(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8939],{4333:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/verbfy-talk/[roomId]",function(){return r(85269)}])},85269:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return N}});var n=r(85893),c=r(67294),a=r(11163),o=r(9008),s=r.n(o),i=r(11088),l=r(67642),d=r(83454);let u={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun3.l.google.com:19302"},{urls:"stun:stun4.l.google.com:19302"}],iceCandidatePoolSize:10},m={NotAllowedError:"Microphone permission denied. Please allow microphone access in your browser settings.",NotFoundError:"No microphone found. Please connect a microphone and try again.",NotSupportedError:"Microphone not supported in this browser.",NotReadableError:"Microphone is already in use by another application.",AbortError:"Microphone access was aborted.",SecurityError:"Microphone access blocked due to security restrictions.",InvalidStateError:"Microphone is in an invalid state.",UnknownError:"Unknown microphone error occurred."},h=e=>{let[t,r]=(0,c.useState)([]),[n,a]=(0,c.useState)(null),[o,s]=(0,c.useState)([]),[i,h]=(0,c.useState)(!1),[x,p]=(0,c.useState)(!1),[f,g]=(0,c.useState)(!1),[v,b]=(0,c.useState)(!1),[w,y]=(0,c.useState)(null),[j,N]=(0,c.useState)(0),[k,C]=(0,c.useState)({}),[S,E]=(0,c.useState)("disconnected"),[R,I]=(0,c.useState)([]),[T,_]=(0,c.useState)(null),M=(0,c.useRef)(null),A=(0,c.useRef)(null),D=(0,c.useRef)(new Map),F=(0,c.useRef)(null),U=(0,c.useRef)(null),P=(0,c.useRef)(null),Z=(0,c.useRef)(new Map),L=(0,c.useRef)(null),q=(0,c.useRef)(!1),z=(0,c.useCallback)(()=>{if(!A.current||L.current||!A.current.getAudioTracks()[0])return;let e=new(window.AudioContext||window.webkitAudioContext),t=e.createMediaStreamSource(A.current),r=e.createAnalyser(),c=new Uint8Array(r.frequencyBinCount);return t.connect(r),r.fftSize=256,L.current=setInterval(()=>{var e;r.getByteFrequencyData(c);let t=c.reduce((e,t)=>e+t,0)/c.length;(null===(e=M.current)||void 0===e?void 0:e.connected)&&n&&M.current.emit("participant:speaking",{roomId:n._id,isSpeaking:t>30})},100),()=>{L.current&&(clearInterval(L.current),L.current=null),t.disconnect(),r.disconnect(),e.close()}},[n]),B=(0,c.useCallback)(()=>{L.current&&(clearInterval(L.current),L.current=null)},[]),V=(0,c.useCallback)(async()=>{var t;if(e&&!q.current&&(null===(t=M.current)||void 0===t||!t.connected))try{b(!0),E("connecting"),y(null),N(0),M.current&&(M.current.disconnect(),M.current=null);let t=(0,l.io)("".concat(d.env.NEXT_PUBLIC_BACKEND_URL||"https://api.verbfy.com","/verbfy-talk"),{path:"/socket.io",transports:["polling","websocket"],forceNew:!0,withCredentials:!0,auth:{token:e},timeout:2e4,reconnectionAttempts:5,reconnectionDelay:1e3,reconnectionDelayMax:5e3,upgrade:!0,rememberUpgrade:!0});t.on("connect",()=>{g(!0),b(!1),E("connected"),y(null),N(0),q.current=!0}),t.on("disconnect",e=>{g(!1),E("disconnected"),a(null),s([]),_(null),B(),D.current.forEach(e=>e.close()),D.current.clear(),Z.current.clear()}),t.on("connect_error",e=>{E("error"),y("Connection failed: ".concat(e.message)),b(!1)}),t.on("reconnect_attempt",e=>{E("connecting"),N(e),y("Reconnecting... (Attempt ".concat(e,"/5)"))}),t.on("reconnect",e=>{E("connected"),y(null),N(0)}),t.on("reconnect_failed",()=>{E("error"),y("Failed to reconnect. Please refresh the page."),b(!1)}),t.on("room:error",e=>{y(e.message),E("error")}),t.on("rooms:list",e=>{r(e)}),t.on("room:joined",e=>{if(a(e),e.participants&&e.participants.length>0){let t=e.participants.find(e=>e.userId&&e.userId._id&&e.isActive);t&&_(t.userId._id.toString())}}),t.on("room:left",()=>{a(null),s([]),_(null),B()}),t.on("participants:update",e=>{s(e)}),t.on("participant:joined",e=>{s(t=>[...t,e]),A.current&&e.id!==T&&setTimeout(()=>{G(e.id)},500)}),t.on("participant:left",e=>{s(t=>t.filter(t=>t.id!==e));let t=D.current.get(e);t&&(t.close(),D.current.delete(e)),Z.current.delete(e),C(t=>{let r={...t};return delete r[e],r})}),t.on("participant:mute",e=>{s(t=>t.map(t=>t.id===e.participantId?{...t,isMuted:e.isMuted}:t))}),t.on("participant:speaking",e=>{s(t=>t.map(t=>t.id===e.participantId?{...t,isSpeaking:e.isSpeaking}:t))}),t.on("webrtc:offer",async e=>{try{await O(e.from,e.offer)}catch(e){console.error("❌ WebRTC offer handling failed:",e),y("Failed to establish voice connection")}}),t.on("webrtc:answer",async e=>{try{await W(e.from,e.answer)}catch(e){console.error("❌ WebRTC answer handling failed:",e),y("Failed to complete voice connection")}}),t.on("webrtc:ice-candidate",async e=>{try{await Y(e.from,e.candidate)}catch(r){console.error("❌ ICE candidate handling failed:",r);let t=Z.current.get(e.from)||[];t.push(e.candidate),Z.current.set(e.from,t)}}),M.current=t,t.emit("rooms:get")}catch(e){console.error("❌ Failed to initialize VerbfyTalk:",e),y(e instanceof Error?e.message:"Unknown error"),b(!1)}},[e,B]),O=async(e,t)=>{try{var r;let c=new RTCPeerConnection(u);D.current.set(e,c),A.current&&A.current.getTracks().forEach(e=>{c.addTrack(e,A.current)}),c.onicecandidate=t=>{var r;t.candidate&&(null===(r=M.current)||void 0===r?void 0:r.connected)&&n&&M.current.emit("webrtc:ice-candidate",{roomId:n._id,to:e,candidate:t.candidate})},c.onconnectionstatechange=()=>{"failed"===c.connectionState&&(c.close(),D.current.delete(e))},c.oniceconnectionstatechange=()=>{},c.ontrack=t=>{C(r=>({...r,[e]:t.streams[0]}))},await c.setRemoteDescription(t);let a=await c.createAnswer();for(let t of(await c.setLocalDescription(a),null===(r=M.current)||void 0===r||r.emit("webrtc:answer",{roomId:null==n?void 0:n._id,to:e,answer:a}),Z.current.get(e)||[]))try{await c.addIceCandidate(t)}catch(e){console.warn("Failed to add buffered ICE candidate:",e)}Z.current.delete(e)}catch(e){throw console.error("❌ WebRTC offer handling failed:",e),e}},W=async(e,t)=>{try{let r=D.current.get(e);r&&"closed"!==r.signalingState&&await r.setRemoteDescription(t)}catch(e){throw console.error("❌ WebRTC answer handling failed:",e),e}},Y=async(e,t)=>{try{let r=D.current.get(e);if(r&&r.remoteDescription)await r.addIceCandidate(t);else{let r=Z.current.get(e)||[];r.push(t),Z.current.set(e,r)}}catch(e){throw console.error("❌ ICE candidate handling failed:",e),e}},X=(0,c.useCallback)(async e=>{var t;if(!(null===(t=M.current)||void 0===t?void 0:t.connected))return y("Not connected to server"),!1;try{return M.current.emit("room:join",{roomId:e}),setTimeout(()=>{A.current&&o.length>0&&o.forEach(e=>{e.id!==T&&G(e.id)})},1e3),!0}catch(e){return console.error("❌ Failed to join room:",e),y("Failed to join room"),!1}},[o,T]),G=(0,c.useCallback)(e=>{var t;if(!A.current||!(null===(t=M.current)||void 0===t?void 0:t.connected)||!n)return;let r=new RTCPeerConnection(u);D.current.set(e,r),A.current.getTracks().forEach(e=>{r.addTrack(e,A.current)}),r.onicecandidate=t=>{var r;t.candidate&&(null===(r=M.current)||void 0===r?void 0:r.connected)&&n&&M.current.emit("webrtc:ice-candidate",{roomId:n._id,to:e,candidate:t.candidate})},r.ontrack=t=>{C(r=>({...r,[e]:t.streams[0]}))},r.createOffer().then(e=>r.setLocalDescription(e)).then(()=>{var t;(null===(t=M.current)||void 0===t?void 0:t.connected)&&n&&M.current.emit("webrtc:offer",{roomId:n._id,to:e,offer:r.localDescription})}).catch(e=>{console.error("Failed to create offer:",e)})},[n]),J=(0,c.useCallback)(()=>{var e;(null===(e=M.current)||void 0===e?void 0:e.connected)&&n&&(M.current.emit("room:leave",{roomId:n._id}),B())},[n,B]),H=(0,c.useCallback)(async e=>{var t;if(!(null===(t=M.current)||void 0===t?void 0:t.connected))return y("Not connected to server"),null;try{return new Promise(t=>{var r;let n=setTimeout(()=>{t(null)},1e4);null===(r=M.current)||void 0===r||r.emit("room:create",{name:e},e=>{clearTimeout(n),e.success&&e.roomId?t(e.roomId):t(null)})})}catch(e){return console.error("❌ Failed to create room:",e),y("Failed to create room"),null}},[]),K=(0,c.useCallback)(async()=>{try{var e,t;if(!(null===(e=navigator.mediaDevices)||void 0===e?void 0:e.getUserMedia))throw Error("getUserMedia is not supported in this browser");try{(null===(t=navigator.permissions)||void 0===t?void 0:t.query)&&(await navigator.permissions.query({name:"microphone"})).state}catch(e){}let r=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:44100},video:!1});A.current=r;let n=new(window.AudioContext||window.webkitAudioContext),c=n.createMediaStreamSource(r),a=n.createGain();return c.connect(a),a.connect(n.destination),F.current=n,P.current=c,U.current=a,a.gain.value=0,h(!0),!0}catch(e){return console.error("❌ Microphone error:",e),y(m[e.name]||m.UnknownError),!1}},[]),Q=(0,c.useCallback)(()=>{var e;if(!A.current||!U.current)return;let t=!i;h(t),U.current.gain.value=t?0:1;let r=A.current.getAudioTracks()[0];r&&(r.enabled=!t),null===(e=M.current)||void 0===e||e.emit("participant:mute",{roomId:null==n?void 0:n._id,isMuted:t})},[i,n]),$=(0,c.useCallback)(()=>{var e;let t=!x;p(t),null===(e=M.current)||void 0===e||e.emit("participant:speaker",{roomId:null==n?void 0:n._id,isSpeaker:t})},[x,n]),ee=(0,c.useCallback)(e=>{if(!M.current||!n)return;let t={id:Date.now().toString(),content:e,sender:"current-user",senderName:"You",timestamp:Date.now()};I(e=>[...e,t]),M.current.emit("send-room-message",{roomId:n._id,content:e,timestamp:Date.now()})},[n]),et=(0,c.useCallback)(()=>{B(),A.current&&(A.current.getTracks().forEach(e=>{e.stop()}),A.current=null),F.current&&(F.current.close(),F.current=null),P.current&&(P.current.disconnect(),P.current=null),U.current=null,D.current.forEach(e=>{e.close()}),D.current.clear(),Z.current.clear(),M.current&&(M.current.disconnect(),M.current=null),g(!1),b(!1),E("disconnected"),a(null),s([]),C({}),I([]),y(null),N(0),h(!1),p(!1),_(null),q.current=!1},[B]);return(0,c.useEffect)(()=>(e&&!q.current&&V(),()=>{et()}),[e,V,et]),(0,c.useEffect)(()=>{if(A.current&&n&&f)return z()},[n,f,z]),{rooms:t,currentRoom:n,joinRoom:X,leaveRoom:J,createRoom:H,isMuted:i,isSpeaker:x,isConnected:f,toggleMute:Q,toggleSpeaker:$,requestMicrophone:K,localStream:A.current,remoteStreams:k,participants:o,messages:R,sendMessage:ee,isConnecting:v,connectionError:w,reconnectionAttempts:j,status:S,isInitialized:q.current,socket:M.current,disconnect:et}};var x=r(36197),p=r(72509),f=r(82861),g=r(35892),v=r(32201),b=r(61937),w=r(24585),y=r(16684);function j(e){let{roomId:t,onLeave:r}=e,{user:a}=(0,x.Eu)(),[o,s]=(0,c.useState)(!0),[i,l]=(0,c.useState)(!1),[d,u]=(0,c.useState)(""),[m,j]=(0,c.useState)(null),[N,k]=(0,c.useState)(!0),{localStream:C,remoteStreams:S,isMuted:E,isSpeaker:R,toggleMute:I,toggleSpeaker:T,status:_,connectionError:M,isInitialized:A,participants:D,messages:F,sendMessage:U,joinRoom:P,leaveRoom:Z,socket:L}=h(localStorage.getItem("token")||""),q=(0,c.useRef)(null),z=(0,c.useRef)(null);(0,c.useEffect)(()=>{a&&t&&B()},[a,t]),(0,c.useEffect)(()=>{q.current&&C&&(q.current.srcObject=C)},[C]),(0,c.useEffect)(()=>{z.current&&(z.current.scrollTop=z.current.scrollHeight)},[F]),(0,c.useEffect)(()=>{D.length>0&&j({name:"Room ".concat(t),participants:D.length})},[D,t]);let B=async()=>{try{k(!0),await P(t)}catch(e){console.error("Failed to initialize room:",e),p.Am.error("Failed to join room")}finally{k(!1)}},V=()=>{Z(),r()};return N?(0,n.jsx)("div",{className:"flex items-center justify-center h-screen",children:(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),(0,n.jsx)("p",{className:"mt-4 text-gray-600",children:"Joining room..."})]})}):M?(0,n.jsx)("div",{className:"flex items-center justify-center h-screen",children:(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsxs)("p",{className:"text-red-500 mb-4",children:["Failed to join room: ",M]}),(0,n.jsx)("button",{onClick:V,className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg",children:"Leave Room"})]})}):(0,n.jsxs)("div",{className:"h-screen flex flex-col bg-gray-900",children:[(0,n.jsxs)("div",{className:"bg-gray-800 p-4 flex items-center justify-between",children:[(0,n.jsxs)("div",{className:"flex items-center gap-4",children:[(0,n.jsx)("button",{onClick:V,className:"text-gray-300 hover:text-white p-2 rounded-lg hover:bg-gray-700",children:(0,n.jsx)(f.Z,{className:"w-6 h-6"})}),(0,n.jsxs)("div",{children:[(0,n.jsx)("h1",{className:"text-white font-semibold text-lg",children:(null==m?void 0:m.name)||"Room ".concat(t)}),(0,n.jsxs)("p",{className:"text-gray-400 text-sm",children:[D.length," participants"]})]})]}),(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)("button",{onClick:()=>l(!i),className:"p-2 rounded-lg ".concat(i?"bg-blue-600 text-white":"text-gray-300 hover:text-white hover:bg-gray-700"),children:(0,n.jsx)(g.Z,{className:"w-5 h-5"})}),(0,n.jsx)("button",{onClick:()=>s(!o),className:"p-2 rounded-lg ".concat(o?"bg-blue-600 text-white":"text-gray-300 hover:text-white hover:bg-gray-700"),children:(0,n.jsx)(v.Z,{className:"w-5 h-5"})})]})]}),(0,n.jsxs)("div",{className:"flex-1 flex",children:[(0,n.jsx)("div",{className:"flex-1 p-4",children:(0,n.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 h-full",children:[(0,n.jsxs)("div",{className:"relative bg-gray-800 rounded-lg overflow-hidden",children:[(0,n.jsx)("video",{ref:q,autoPlay:!0,muted:!0,playsInline:!0,className:"w-full h-full object-cover"}),(0,n.jsxs)("div",{className:"absolute bottom-2 left-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded",children:[null==a?void 0:a.name," (You)"]}),E&&(0,n.jsx)("div",{className:"absolute top-2 left-2 bg-red-500 text-white p-1 rounded",children:(0,n.jsx)(b.Z,{className:"w-4 h-4"})})]}),D.filter(e=>e.id!==(null==a?void 0:a.id)).map(e=>(0,n.jsxs)("div",{className:"relative bg-gray-800 rounded-lg overflow-hidden",children:[(0,n.jsx)("div",{className:"w-full h-full flex items-center justify-center",children:(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("div",{className:"w-16 h-16 bg-gray-600 rounded-full flex items-center justify-center mx-auto mb-2",children:(0,n.jsx)("span",{className:"text-white text-lg font-semibold",children:e.name.charAt(0).toUpperCase()})}),(0,n.jsx)("p",{className:"text-white text-sm",children:e.name}),e.isSpeaking&&(0,n.jsx)("div",{className:"mt-1",children:(0,n.jsx)("div",{className:"w-2 h-2 bg-green-500 rounded-full mx-auto animate-pulse"})})]})}),e.isMuted&&(0,n.jsx)("div",{className:"absolute top-2 left-2 bg-red-500 text-white p-1 rounded",children:(0,n.jsx)(b.Z,{className:"w-4 h-4"})})]},e.id))]})}),(0,n.jsxs)("div",{className:"w-80 bg-gray-800 border-l border-gray-700",children:[i&&(0,n.jsxs)("div",{className:"p-4 border-b border-gray-700",children:[(0,n.jsx)("h3",{className:"text-white font-semibold mb-3",children:"Participants"}),(0,n.jsx)("div",{className:"space-y-2",children:D.map(e=>(0,n.jsxs)("div",{className:"flex items-center gap-3 p-2 rounded bg-gray-700",children:[(0,n.jsx)("div",{className:"w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center",children:(0,n.jsx)("span",{className:"text-white text-sm font-semibold",children:e.name.charAt(0).toUpperCase()})}),(0,n.jsxs)("div",{className:"flex-1",children:[(0,n.jsxs)("p",{className:"text-white text-sm",children:[e.name,e.id===(null==a?void 0:a.id)&&" (You)"]}),(0,n.jsx)("p",{className:"text-gray-400 text-xs",children:e.isSpeaker?"Speaker":"Listener"})]}),(0,n.jsx)("div",{className:"flex gap-1",children:(0,n.jsx)(b.Z,{className:"w-4 h-4 ".concat(e.isMuted?"text-red-500":"text-green-500")})})]},e.id))})]}),o&&(0,n.jsxs)("div",{className:"flex-1 flex flex-col h-full",children:[(0,n.jsx)("div",{className:"p-4 border-b border-gray-700",children:(0,n.jsx)("h3",{className:"text-white font-semibold",children:"Chat"})}),(0,n.jsx)("div",{className:"flex-1 overflow-y-auto p-4",ref:z,children:(0,n.jsx)("div",{className:"space-y-3",children:F.map((e,t)=>(0,n.jsxs)("div",{className:"bg-gray-700 rounded-lg p-3",children:[(0,n.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,n.jsx)("span",{className:"text-blue-400 text-sm font-semibold",children:e.sender===(null==a?void 0:a.id)?"You":e.senderName}),(0,n.jsx)("span",{className:"text-gray-400 text-xs",children:new Date(e.timestamp).toLocaleTimeString()})]}),(0,n.jsx)("p",{className:"text-white text-sm",children:e.content})]},t))})}),(0,n.jsx)("div",{className:"p-4 border-t border-gray-700",children:(0,n.jsxs)("form",{onSubmit:e=>{e.preventDefault(),d.trim()&&(U(d),u(""))},className:"flex gap-2",children:[(0,n.jsx)("input",{type:"text",value:d,onChange:e=>u(e.target.value),placeholder:"Type a message...",className:"flex-1 bg-gray-700 text-white px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),(0,n.jsx)("button",{type:"submit",className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg",children:"Send"})]})})]})]})]}),(0,n.jsxs)("div",{className:"bg-gray-800 p-4 flex items-center justify-center gap-4",children:[(0,n.jsx)("button",{onClick:I,className:"p-3 rounded-full ".concat(E?"bg-red-500 text-white":"bg-gray-600 text-white"," hover:opacity-80 transition-colors"),children:(0,n.jsx)(b.Z,{className:"w-6 h-6"})}),(0,n.jsx)("button",{onClick:T,className:"p-3 rounded-full ".concat(R?"bg-blue-600 text-white":"bg-gray-600 text-white"," hover:opacity-80 transition-colors"),children:R?(0,n.jsx)(w.Z,{className:"w-6 h-6"}):(0,n.jsx)(y.Z,{className:"w-6 h-6"})}),(0,n.jsx)("button",{onClick:V,className:"bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium transition-colors",children:"Leave Room"})]})]})}function N(){let e=(0,a.useRouter)(),{roomId:t}=e.query;return t?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(s(),{children:[(0,n.jsxs)("title",{children:["VerbfyTalk Room - ",t]}),(0,n.jsx)("meta",{name:"description",content:"Join the conversation in VerbfyTalk"})]}),(0,n.jsx)(i.Z,{title:"VerbfyTalk Room: ".concat(t),children:(0,n.jsx)(j,{roomId:t,onLeave:()=>{e.push("/verbfy-talk")}})})]}):(0,n.jsx)(i.Z,{title:"VerbfyTalk",children:(0,n.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("h1",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Room Not Found"}),(0,n.jsx)("p",{className:"text-gray-600 mb-6",children:"The room you're looking for doesn't exist."}),(0,n.jsx)("button",{onClick:()=>e.push("/verbfy-talk"),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors",children:"Back to Rooms"})]})})})}}},function(e){e.O(0,[1216,1088,2888,179],function(){return e(e.s=4333)}),_N_E=e.O()}]);
//# sourceMappingURL=[roomId]-e14764deec94c84b.js.map