(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8939],{4333:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/verbfy-talk/[roomId]",function(){return r(85269)}])},85269:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return b}});var n=r(85893),s=r(67294),a=r(11163),c=r(9008),o=r.n(c),l=r(11088),i=r(67642),d=r(36197),u=r(5704),m=r(83454);let x=()=>{let{user:e}=(0,d.aC)(),t=u.tokenStorage.getToken(),[r,n]=(0,s.useState)(null),[a,c]=(0,s.useState)(!1),[o,l]=(0,s.useState)(null),[x,h]=(0,s.useState)([]),[g,f]=(0,s.useState)([]),[b,p]=(0,s.useState)(!1),[v,j]=(0,s.useState)(null),[y,N]=(0,s.useState)(!1),[w,k]=(0,s.useState)(!1),C=(0,s.useRef)(null),D=(0,s.useRef)(null),_=(0,s.useRef)(new Map),S={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]};(0,s.useEffect)(()=>{if(!e||!t)return;let r=(0,i.io)("".concat(m.env.NEXT_PUBLIC_BACKEND_URL||"https://api.verbfy.com"),{auth:{token:t},transports:["polling","websocket"]});return C.current=r,n(r),r.on("connect",()=>{console.log("✅ Connected to VerbfyTalk server"),c(!0),j(null)}),r.on("disconnect",e=>{console.log("❌ Disconnected from VerbfyTalk server:",e),c(!1)}),r.on("connect_error",e=>{console.error("❌ Connection error:",e),j("Failed to connect to server")}),r.on("room:joined",e=>{console.log("✅ Joined room:",e.name),l(e),h(e.participants.map(e=>({id:e.userId._id,name:e.userId.name,isSpeaking:!1,isMuted:!1,isSpeaker:!1}))),j(null)}),r.on("room:error",e=>{console.error("❌ Room error:",e.message),j(e.message)}),r.on("participant:joined",e=>{console.log("\uD83D\uDC64 Participant joined:",e.name),h(t=>[...t,e])}),r.on("participant:left",e=>{console.log("\uD83D\uDC4B Participant left:",e),h(t=>t.filter(t=>t.id!==e))}),r.on("message:received",e=>{console.log("\uD83D\uDCAC Message received:",e.message),f(t=>[...t,e])}),r.on("webrtc:offer",async e=>{await P(e.from,e.offer)}),r.on("webrtc:answer",async e=>{await L(e.from,e.answer)}),r.on("webrtc:ice-candidate",async e=>{await M(e.from,e.candidate)}),()=>{r.disconnect(),C.current=null}},[e,t]);let T=(0,s.useCallback)(async()=>{try{let e=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1});return D.current=e,e}catch(e){return console.error("❌ Failed to get microphone access:",e),j("Microphone access denied"),null}},[]),R=(0,s.useCallback)(async(e,t)=>{var r;if(!(null===(r=C.current)||void 0===r?void 0:r.connected))return j("Not connected to server"),!1;try{if(p(!0),j(null),!await T())return p(!1),!1;return C.current.emit("room:join",{roomId:e,password:t}),!0}catch(e){return console.error("❌ Failed to join room:",e),j("Failed to join room"),p(!1),!1}},[T]),E=(0,s.useCallback)(()=>{var e;(null===(e=C.current)||void 0===e?void 0:e.connected)&&o&&C.current.emit("room:leave",{roomId:o._id}),l(null),h([]),f([]),D.current&&(D.current.getTracks().forEach(e=>e.stop()),D.current=null),_.current.forEach(e=>e.close()),_.current.clear()},[o]),F=(0,s.useCallback)(e=>{var t;(null===(t=C.current)||void 0===t?void 0:t.connected)&&o&&C.current.emit("message:send",{roomId:o._id,message:e.trim()})},[o]),I=(0,s.useCallback)(()=>{if(D.current){let e=D.current.getAudioTracks()[0];e&&(e.enabled=!e.enabled,N(!e.enabled))}},[]),P=async(e,t)=>{try{var r;let n=new RTCPeerConnection(S);_.current.set(e,n),D.current&&D.current.getTracks().forEach(e=>{n.addTrack(e,D.current)}),n.onicecandidate=t=>{var r;t.candidate&&(null===(r=C.current)||void 0===r?void 0:r.connected)&&C.current.emit("webrtc:ice-candidate",{to:e,candidate:t.candidate})},n.ontrack=t=>{console.log("\uD83C\uDFB5 Remote audio stream received from:",e)},await n.setRemoteDescription(t);let s=await n.createAnswer();await n.setLocalDescription(s),(null===(r=C.current)||void 0===r?void 0:r.connected)&&C.current.emit("webrtc:answer",{to:e,answer:s})}catch(e){console.error("❌ Failed to handle offer:",e)}},L=async(e,t)=>{try{let r=_.current.get(e);r&&await r.setRemoteDescription(t)}catch(e){console.error("❌ Failed to handle answer:",e)}},M=async(e,t)=>{try{let r=_.current.get(e);r&&r.remoteDescription&&await r.addIceCandidate(t)}catch(e){console.error("❌ Failed to handle ICE candidate:",e)}};return{isConnected:a,isLoading:b,error:v,currentRoom:o,participants:x,messages:g,isMuted:y,isSpeaking:w,joinRoom:R,leaveRoom:E,sendMessage:F,toggleMute:I,setError:j}};var h=r(82861),g=r(61937);function f(e){let{roomId:t,onLeave:r}=e,{isConnected:a,isLoading:c,error:o,currentRoom:l,participants:i,messages:d,isMuted:u,joinRoom:m,leaveRoom:f,sendMessage:b,toggleMute:p,setError:v}=x(),[j,y]=(0,s.useState)("");(0,s.useEffect)(()=>{t&&a&&m(t)},[t,a,m]);let N=()=>{f(),r()};return c?(0,n.jsx)("div",{className:"flex items-center justify-center h-screen bg-gray-900",children:(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),(0,n.jsx)("p",{className:"mt-4 text-white",children:"Joining room..."})]})}):o?(0,n.jsx)("div",{className:"flex items-center justify-center h-screen bg-gray-900",children:(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("p",{className:"text-red-400 mb-4",children:o}),(0,n.jsx)("button",{onClick:()=>{v(null),m(t)},className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg mr-4",children:"Retry"}),(0,n.jsx)("button",{onClick:N,className:"bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg",children:"Leave Room"})]})}):(0,n.jsxs)("div",{className:"h-screen flex flex-col bg-gray-900",children:[(0,n.jsxs)("div",{className:"bg-gray-800 p-4 flex items-center justify-between",children:[(0,n.jsxs)("div",{className:"flex items-center gap-4",children:[(0,n.jsx)("button",{onClick:N,className:"text-gray-300 hover:text-white p-2 rounded-lg hover:bg-gray-700",children:(0,n.jsx)(h.Z,{className:"w-6 h-6"})}),(0,n.jsxs)("div",{children:[(0,n.jsx)("h1",{className:"text-xl font-bold text-white",children:(null==l?void 0:l.name)||"Room ".concat(t)}),(0,n.jsxs)("p",{className:"text-gray-400 text-sm",children:[i.length," participant",1!==i.length?"s":""]})]})]}),(0,n.jsx)("div",{className:"flex items-center gap-4",children:(0,n.jsx)("button",{onClick:p,className:"p-3 rounded-full transition-colors ".concat(u?"bg-red-600 hover:bg-red-700 text-white":"bg-green-600 hover:bg-green-700 text-white"),children:(0,n.jsx)(g.Z,{className:"w-6 h-6 ".concat(u?"opacity-50":"")})})})]}),(0,n.jsxs)("div",{className:"flex-1 flex",children:[(0,n.jsxs)("div",{className:"w-1/3 bg-gray-800 p-4",children:[(0,n.jsx)("h2",{className:"text-lg font-semibold text-white mb-4",children:"Participants"}),(0,n.jsx)("div",{className:"space-y-2",children:i.map(e=>(0,n.jsxs)("div",{className:"flex items-center gap-3 p-3 bg-gray-700 rounded-lg",children:[(0,n.jsx)("div",{className:"w-3 h-3 rounded-full ".concat(e.isSpeaking?"bg-green-500":"bg-gray-500")}),(0,n.jsx)("span",{className:"text-white",children:e.name}),e.isMuted&&(0,n.jsx)(g.Z,{className:"w-4 h-4 text-red-400 opacity-50"})]},e.id))})]}),(0,n.jsxs)("div",{className:"flex-1 flex flex-col",children:[(0,n.jsx)("div",{className:"flex-1 p-4 overflow-y-auto",children:(0,n.jsx)("div",{className:"space-y-4",children:d.map(e=>(0,n.jsxs)("div",{className:"flex gap-3",children:[(0,n.jsx)("div",{className:"w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white text-sm font-semibold",children:e.userName.charAt(0).toUpperCase()}),(0,n.jsxs)("div",{className:"flex-1",children:[(0,n.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,n.jsx)("span",{className:"text-white font-semibold",children:e.userName}),(0,n.jsx)("span",{className:"text-gray-400 text-sm",children:new Date(e.timestamp).toLocaleTimeString()})]}),(0,n.jsx)("p",{className:"text-gray-300",children:e.message})]})]},e.id))})}),(0,n.jsx)("div",{className:"p-4 border-t border-gray-700",children:(0,n.jsxs)("form",{onSubmit:e=>{e.preventDefault(),j.trim()&&(b(j),y(""))},className:"flex gap-3",children:[(0,n.jsx)("input",{type:"text",value:j,onChange:e=>y(e.target.value),placeholder:"Type a message...",className:"flex-1 bg-gray-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600"}),(0,n.jsx)("button",{type:"submit",disabled:!j.trim(),className:"bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white px-6 py-2 rounded-lg transition-colors",children:"Send"})]})})]})]})]})}function b(){let e=(0,a.useRouter)(),{roomId:t}=e.query;return t?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(o(),{children:[(0,n.jsxs)("title",{children:["VerbfyTalk Room - ",t]}),(0,n.jsx)("meta",{name:"description",content:"Join the conversation in VerbfyTalk"})]}),(0,n.jsx)(l.Z,{title:"VerbfyTalk Room: ".concat(t),children:(0,n.jsx)(f,{roomId:t,onLeave:()=>{e.push("/verbfy-talk")}})})]}):(0,n.jsx)(l.Z,{title:"VerbfyTalk",children:(0,n.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("h1",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Room Not Found"}),(0,n.jsx)("p",{className:"text-gray-600 mb-6",children:"The room you're looking for doesn't exist."}),(0,n.jsx)("button",{onClick:()=>e.push("/verbfy-talk"),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors",children:"Back to Rooms"})]})})})}}},function(e){e.O(0,[1216,1088,2888,179],function(){return e(e.s=4333)}),_N_E=e.O()}]);
//# sourceMappingURL=[roomId]-055809d733474bb0.js.map