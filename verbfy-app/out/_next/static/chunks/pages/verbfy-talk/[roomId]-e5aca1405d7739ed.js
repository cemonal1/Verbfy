(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8939],{4333:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/verbfy-talk/[roomId]",function(){return r(85269)}])},85269:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return p}});var n=r(85893),a=r(67294),s=r(11163),o=r(9008),c=r.n(o),i=r(11088),l=r(67642),d=r(36197),u=r(5704),m=r(83454);let g=()=>{let{user:e}=(0,d.aC)(),t=u.tokenStorage.getToken(),[r,n]=(0,a.useState)(null),[s,o]=(0,a.useState)(!1),[c,i]=(0,a.useState)(null),[g,h]=(0,a.useState)([]),[x,f]=(0,a.useState)([]),[p,b]=(0,a.useState)(!1),[v,j]=(0,a.useState)(null),[y,w]=(0,a.useState)(!1),[N,k]=(0,a.useState)(!1),C=(0,a.useRef)(null),D=(0,a.useRef)(null),T=(0,a.useRef)(new Map),S={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]};(0,a.useEffect)(()=>{if(!e||!t)return;let r=(0,l.io)("".concat(m.env.NEXT_PUBLIC_BACKEND_URL||"https://api.verbfy.com"),{auth:{token:t},transports:["polling","websocket"]});return C.current=r,n(r),r.on("connect",()=>{console.log("✅ Connected to VerbfyTalk server"),o(!0),j(null)}),r.on("disconnect",e=>{console.log("❌ Disconnected from VerbfyTalk server:",e),o(!1)}),r.on("connect_error",e=>{console.error("❌ Connection error:",e),j("Failed to connect to server")}),r.on("room:joined",t=>{console.log("✅ Joined room:",t.name),i(t),h(t.participants.map(e=>({id:e.userId._id,name:e.userId.name,isSpeaking:!1,isMuted:!1,isSpeaker:!1}))),j(null),b(!1),setTimeout(()=>{D.current&&t.participants.length>0&&(console.log("\uD83D\uDD17 Initializing WebRTC connections with",t.participants.length,"participants"),t.participants.forEach(t=>{t.userId._id!==(null==e?void 0:e.id)&&P(t.userId._id)}))},1e3)}),r.on("room:error",e=>{console.error("❌ Room error:",e.message),j(e.message)}),r.on("participant:joined",t=>{console.log("\uD83D\uDC64 Participant joined:",t.name),h(e=>[...e,t]),D.current&&t.id!==(null==e?void 0:e.id)&&setTimeout(()=>{P(t.id)},500)}),r.on("participant:left",e=>{console.log("\uD83D\uDC4B Participant left:",e),h(t=>t.filter(t=>t.id!==e));let t=T.current.get(e);t&&(t.close(),T.current.delete(e),console.log("\uD83D\uDD0C Closed peer connection for:",e))}),r.on("message:received",e=>{console.log("\uD83D\uDCAC Message received:",e.message),f(t=>[...t,e])}),r.on("webrtc:offer",async e=>{await A(e.from,e.offer)}),r.on("webrtc:answer",async e=>{await B(e.from,e.answer)}),r.on("webrtc:ice-candidate",async e=>{await L(e.from,e.candidate)}),()=>{r.disconnect(),C.current=null}},[e,t]);let _=(0,a.useCallback)(async()=>{try{let e=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1});return D.current=e,e}catch(e){return console.error("❌ Failed to get microphone access:",e),j("Microphone access denied"),null}},[]),R=(0,a.useCallback)(async(e,r)=>{var n;if(!(null===(n=C.current)||void 0===n?void 0:n.connected))return j("Not connected to server"),!1;try{if(b(!0),j(null),!await _())return b(!1),!1;let n=await fetch("/api/verbfy-talk/".concat(e,"/join"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(t)},credentials:"include",body:JSON.stringify({password:r})});if(!n.ok){let e=await n.json();throw Error(e.message||"Failed to join room")}let a=await n.json();return console.log("✅ HTTP API join successful:",a.data.name),C.current.emit("room:join",{roomId:e,password:r}),!0}catch(e){return console.error("❌ Failed to join room:",e),j(e instanceof Error?e.message:"Failed to join room"),b(!1),!1}},[_,t]),E=(0,a.useCallback)(()=>{var e;(null===(e=C.current)||void 0===e?void 0:e.connected)&&c&&C.current.emit("room:leave",{roomId:c._id}),i(null),h([]),f([]),D.current&&(D.current.getTracks().forEach(e=>e.stop()),D.current=null),T.current.forEach(e=>e.close()),T.current.clear()},[c]),F=(0,a.useCallback)(e=>{var t;(null===(t=C.current)||void 0===t?void 0:t.connected)&&c&&C.current.emit("message:send",{roomId:c._id,message:e.trim()})},[c]),I=(0,a.useCallback)(()=>{if(D.current){let e=D.current.getAudioTracks()[0];e&&(e.enabled=!e.enabled,w(!e.enabled))}},[]),P=(0,a.useCallback)(async e=>{try{var t;let r=new RTCPeerConnection(S);T.current.set(e,r),D.current&&D.current.getTracks().forEach(e=>{r.addTrack(e,D.current)}),r.onicecandidate=t=>{var r;t.candidate&&(null===(r=C.current)||void 0===r?void 0:r.connected)&&C.current.emit("webrtc:ice-candidate",{to:e,candidate:t.candidate})},r.ontrack=t=>{console.log("\uD83C\uDFB5 Remote audio stream received from:",e)};let n=await r.createOffer();await r.setLocalDescription(n),(null===(t=C.current)||void 0===t?void 0:t.connected)&&C.current.emit("webrtc:offer",{to:e,offer:n}),console.log("\uD83D\uDD17 Peer connection created for:",e)}catch(e){console.error("❌ Failed to create peer connection:",e)}},[]),A=async(e,t)=>{try{var r;let n=new RTCPeerConnection(S);T.current.set(e,n),D.current&&D.current.getTracks().forEach(e=>{n.addTrack(e,D.current)}),n.onicecandidate=t=>{var r;t.candidate&&(null===(r=C.current)||void 0===r?void 0:r.connected)&&C.current.emit("webrtc:ice-candidate",{to:e,candidate:t.candidate})},n.ontrack=t=>{console.log("\uD83C\uDFB5 Remote audio stream received from:",e)},await n.setRemoteDescription(t);let a=await n.createAnswer();await n.setLocalDescription(a),(null===(r=C.current)||void 0===r?void 0:r.connected)&&C.current.emit("webrtc:answer",{to:e,answer:a})}catch(e){console.error("❌ Failed to handle offer:",e)}},B=async(e,t)=>{try{let r=T.current.get(e);r&&await r.setRemoteDescription(t)}catch(e){console.error("❌ Failed to handle answer:",e)}},L=async(e,t)=>{try{let r=T.current.get(e);r&&r.remoteDescription&&await r.addIceCandidate(t)}catch(e){console.error("❌ Failed to handle ICE candidate:",e)}};return{isConnected:s,isLoading:p,error:v,currentRoom:c,participants:g,messages:x,isMuted:y,isSpeaking:N,joinRoom:R,leaveRoom:E,sendMessage:F,toggleMute:I,createPeerConnection:P,setError:j}};var h=r(82861),x=r(61937);function f(e){let{roomId:t,onLeave:r}=e,{isConnected:s,isLoading:o,error:c,currentRoom:i,participants:l,messages:d,isMuted:u,isSpeaking:m,joinRoom:f,leaveRoom:p,sendMessage:b,toggleMute:v,setError:j}=g(),[y,w]=(0,a.useState)("");(0,a.useEffect)(()=>{t&&s&&f(t)},[t,s,f]);let N=()=>{p(),r()};return o?(0,n.jsx)("div",{className:"flex items-center justify-center h-screen bg-gray-900",children:(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),(0,n.jsx)("p",{className:"mt-4 text-white",children:"Joining room..."})]})}):c?(0,n.jsx)("div",{className:"flex items-center justify-center h-screen bg-gray-900",children:(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("p",{className:"text-red-400 mb-4",children:c}),(0,n.jsx)("button",{onClick:()=>{j(null),f(t)},className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg mr-4",children:"Retry"}),(0,n.jsx)("button",{onClick:N,className:"bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg",children:"Leave Room"})]})}):(0,n.jsxs)("div",{className:"h-screen flex flex-col bg-gray-900",children:[(0,n.jsxs)("div",{className:"bg-gray-800 p-4 flex items-center justify-between",children:[(0,n.jsxs)("div",{className:"flex items-center gap-4",children:[(0,n.jsx)("button",{onClick:N,className:"text-gray-300 hover:text-white p-2 rounded-lg hover:bg-gray-700",children:(0,n.jsx)(h.Z,{className:"w-6 h-6"})}),(0,n.jsxs)("div",{children:[(0,n.jsx)("h1",{className:"text-xl font-bold text-white",children:(null==i?void 0:i.name)||"Room ".concat(t)}),(0,n.jsxs)("p",{className:"text-gray-400 text-sm",children:[l.length," participant",1!==l.length?"s":""]})]})]}),(0,n.jsx)("div",{className:"flex items-center gap-4",children:(0,n.jsxs)("button",{onClick:v,className:"p-3 rounded-full transition-colors relative ".concat(u?"bg-red-600 hover:bg-red-700 text-white":m?"bg-green-600 hover:bg-green-700 text-white animate-pulse":"bg-green-600 hover:bg-green-700 text-white"),children:[(0,n.jsx)(x.Z,{className:"w-6 h-6 ".concat(u?"opacity-50":"")}),m&&!u&&(0,n.jsx)("div",{className:"absolute -top-1 -right-1 w-3 h-3 bg-green-400 rounded-full animate-pulse"})]})})]}),(0,n.jsxs)("div",{className:"flex-1 flex",children:[(0,n.jsxs)("div",{className:"w-1/3 bg-gray-800 p-4",children:[(0,n.jsx)("h2",{className:"text-lg font-semibold text-white mb-4",children:"Participants"}),(0,n.jsx)("div",{className:"space-y-2",children:l.map(e=>(0,n.jsxs)("div",{className:"flex items-center gap-3 p-3 rounded-lg transition-colors ".concat(e.isSpeaking?"bg-green-700 border border-green-500":"bg-gray-700"),children:[(0,n.jsx)("div",{className:"w-3 h-3 rounded-full transition-colors ".concat(e.isSpeaking?"bg-green-500 animate-pulse":"bg-gray-500")}),(0,n.jsx)("span",{className:"text-white font-medium",children:e.name}),e.isMuted&&(0,n.jsx)(x.Z,{className:"w-4 h-4 text-red-400 opacity-50"}),e.isSpeaking&&(0,n.jsx)("div",{className:"ml-auto",children:(0,n.jsx)("div",{className:"w-2 h-2 bg-green-400 rounded-full animate-pulse"})})]},e.id))})]}),(0,n.jsxs)("div",{className:"flex-1 flex flex-col",children:[(0,n.jsx)("div",{className:"flex-1 p-4 overflow-y-auto",children:(0,n.jsx)("div",{className:"space-y-4",children:d.map(e=>(0,n.jsxs)("div",{className:"flex gap-3",children:[(0,n.jsx)("div",{className:"w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white text-sm font-semibold",children:e.userName.charAt(0).toUpperCase()}),(0,n.jsxs)("div",{className:"flex-1",children:[(0,n.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,n.jsx)("span",{className:"text-white font-semibold",children:e.userName}),(0,n.jsx)("span",{className:"text-gray-400 text-sm",children:new Date(e.timestamp).toLocaleTimeString()})]}),(0,n.jsx)("p",{className:"text-gray-300",children:e.message})]})]},e.id))})}),(0,n.jsx)("div",{className:"p-4 border-t border-gray-700",children:(0,n.jsxs)("form",{onSubmit:e=>{e.preventDefault(),y.trim()&&(b(y),w(""))},className:"flex gap-3",children:[(0,n.jsx)("input",{type:"text",value:y,onChange:e=>w(e.target.value),placeholder:"Type a message...",className:"flex-1 bg-gray-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600"}),(0,n.jsx)("button",{type:"submit",disabled:!y.trim(),className:"bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white px-6 py-2 rounded-lg transition-colors",children:"Send"})]})})]})]})]})}function p(){let e=(0,s.useRouter)(),{roomId:t}=e.query;return t?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(c(),{children:[(0,n.jsxs)("title",{children:["VerbfyTalk Room - ",t]}),(0,n.jsx)("meta",{name:"description",content:"Join the conversation in VerbfyTalk"})]}),(0,n.jsx)(i.Z,{title:"VerbfyTalk Room: ".concat(t),children:(0,n.jsx)(f,{roomId:t,onLeave:()=>{e.push("/verbfy-talk")}})})]}):(0,n.jsx)(i.Z,{title:"VerbfyTalk",children:(0,n.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("h1",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Room Not Found"}),(0,n.jsx)("p",{className:"text-gray-600 mb-6",children:"The room you're looking for doesn't exist."}),(0,n.jsx)("button",{onClick:()=>e.push("/verbfy-talk"),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors",children:"Back to Rooms"})]})})})}}},function(e){e.O(0,[1216,1088,2888,179],function(){return e(e.s=4333)}),_N_E=e.O()}]);
//# sourceMappingURL=[roomId]-e5aca1405d7739ed.js.map