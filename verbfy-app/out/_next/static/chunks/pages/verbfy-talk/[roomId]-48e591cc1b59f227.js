(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8939],{4333:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/verbfy-talk/[roomId]",function(){return r(85269)}])},85269:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return b}});var n=r(85893),o=r(67294),a=r(11163),c=r(9008),s=r.n(c),i=r(11088),l=r(36197),d=r(67642),u=r(83454);let m={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun3.l.google.com:19302"},{urls:"stun:stun4.l.google.com:19302"}],iceCandidatePoolSize:10},g={NotAllowedError:"Microphone permission denied. Please allow microphone access in your browser settings.",NotFoundError:"No microphone found. Please connect a microphone and try again.",NotSupportedError:"Microphone not supported in this browser.",NotReadableError:"Microphone is already in use by another application.",AbortError:"Microphone access was aborted.",SecurityError:"Microphone access blocked due to security restrictions.",InvalidStateError:"Microphone is in an invalid state.",UnknownError:"Unknown microphone error occurred."},h=e=>{let[t,r]=(0,o.useState)([]),[n,a]=(0,o.useState)(null),[c,s]=(0,o.useState)([]),[i,l]=(0,o.useState)(!1),[h,p]=(0,o.useState)(!1),[x,f]=(0,o.useState)(!1),[b,y]=(0,o.useState)(null),[v,w]=(0,o.useState)(0),k=(0,o.useRef)(null),D=(0,o.useRef)(null),j=(0,o.useRef)(new Map),N=(0,o.useRef)(null),C=(0,o.useRef)(null),E=(0,o.useRef)(null),S=(0,o.useRef)(new Map),T=(0,o.useRef)(null),R=(0,o.useRef)(!1),A=(0,o.useCallback)(()=>{if(!D.current||T.current||!D.current.getAudioTracks()[0])return;let e=new(window.AudioContext||window.webkitAudioContext),t=e.createMediaStreamSource(D.current),r=e.createAnalyser(),o=new Uint8Array(r.frequencyBinCount);return t.connect(r),r.fftSize=256,T.current=setInterval(()=>{var e;r.getByteFrequencyData(o);let t=o.reduce((e,t)=>e+t,0)/o.length;(null===(e=k.current)||void 0===e?void 0:e.connected)&&n&&k.current.emit("participant:speaking",{roomId:n.id,isSpeaking:t>30})},100),()=>{T.current&&(clearInterval(T.current),T.current=null),t.disconnect(),r.disconnect(),e.close()}},[n]),M=(0,o.useCallback)(()=>{T.current&&(clearInterval(T.current),T.current=null)},[]),F=(0,o.useCallback)(async()=>{if(e&&!R.current)try{f(!0),y(null),w(0),k.current&&(k.current.disconnect(),k.current=null);let t=(0,d.io)(u.env.NEXT_PUBLIC_BACKEND_URL||"https://api.verbfy.com",{path:"/socket.io",transports:["websocket","polling"],forceNew:!1,withCredentials:!0,auth:{token:e},timeout:2e4,reconnectionAttempts:5,reconnectionDelay:1e3,reconnectionDelayMax:5e3,upgrade:!0,rememberUpgrade:!0});t.on("connect",()=>{console.log("\uD83D\uDD0C VerbfyTalk connected:",t.id),p(!0),f(!1),y(null),w(0),R.current=!0}),t.on("disconnect",e=>{console.log("\uD83D\uDD0C VerbfyTalk disconnected:",e),p(!1),a(null),s([]),M(),j.current.forEach(e=>e.close()),j.current.clear(),S.current.clear()}),t.on("connect_error",e=>{console.error("\uD83D\uDD0C VerbfyTalk connection error:",e),y("Connection failed: ".concat(e.message)),f(!1)}),t.on("reconnect_attempt",e=>{console.log("\uD83D\uDD04 VerbfyTalk reconnection attempt:",e),w(e),y("Reconnecting... (Attempt ".concat(e,"/5)"))}),t.on("reconnect",e=>{console.log("✅ VerbfyTalk reconnected after",e,"attempts"),y(null),w(0)}),t.on("reconnect_failed",()=>{console.error("❌ VerbfyTalk reconnection failed"),y("Failed to reconnect. Please refresh the page."),f(!1)}),t.on("rooms:list",e=>{r(e)}),t.on("room:joined",e=>{a(e),console.log("\uD83C\uDFA4 Joined room:",e.name)}),t.on("room:left",()=>{a(null),s([]),M(),console.log("\uD83C\uDFA4 Left room")}),t.on("participants:update",e=>{s(e)}),t.on("participant:joined",e=>{console.log("\uD83D\uDC64 Participant joined:",e.name),s(t=>[...t,e])}),t.on("participant:left",e=>{console.log("\uD83D\uDC64 Participant left:",e),s(t=>t.filter(t=>t.id!==e));let t=j.current.get(e);t&&(t.close(),j.current.delete(e)),S.current.delete(e)}),t.on("participant:mute",e=>{s(t=>t.map(t=>t.id===e.participantId?{...t,isMuted:e.isMuted}:t))}),t.on("participant:speaking",e=>{s(t=>t.map(t=>t.id===e.participantId?{...t,isSpeaking:e.isSpeaking}:t))}),t.on("webrtc:offer",async e=>{try{await I(e.from,e.offer)}catch(e){console.error("❌ WebRTC offer handling failed:",e),y("Failed to establish voice connection")}}),t.on("webrtc:answer",async e=>{try{await _(e.from,e.answer)}catch(e){console.error("❌ WebRTC answer handling failed:",e),y("Failed to complete voice connection")}}),t.on("webrtc:ice-candidate",async e=>{try{await P(e.from,e.candidate)}catch(r){console.error("❌ ICE candidate handling failed:",r);let t=S.current.get(e.from)||[];t.push(e.candidate),S.current.set(e.from,t)}}),k.current=t,t.emit("rooms:get")}catch(e){console.error("❌ Failed to initialize VerbfyTalk:",e),y(e instanceof Error?e.message:"Unknown error"),f(!1)}},[e,M]),I=async(e,t)=>{try{var r;let n=new RTCPeerConnection(m);j.current.set(e,n),D.current&&D.current.getTracks().forEach(e=>{n.addTrack(e,D.current)}),n.onicecandidate=t=>{var r;t.candidate&&(null===(r=k.current)||void 0===r?void 0:r.connected)&&k.current.emit("webrtc:ice-candidate",{to:e,candidate:t.candidate})},n.onconnectionstatechange=()=>{console.log("\uD83D\uDD17 Peer connection state (".concat(e,"):"),n.connectionState),"failed"===n.connectionState&&(n.close(),j.current.delete(e))},n.oniceconnectionstatechange=()=>{console.log("\uD83E\uDDCA ICE connection state (".concat(e,"):"),n.iceConnectionState)},await n.setRemoteDescription(t);let o=await n.createAnswer();for(let t of(await n.setLocalDescription(o),null===(r=k.current)||void 0===r||r.emit("webrtc:answer",{to:e,answer:o}),S.current.get(e)||[]))try{await n.addIceCandidate(t)}catch(e){console.warn("Failed to add buffered ICE candidate:",e)}S.current.delete(e)}catch(e){throw console.error("❌ WebRTC offer handling failed:",e),e}},_=async(e,t)=>{try{let r=j.current.get(e);r&&"closed"!==r.signalingState&&await r.setRemoteDescription(t)}catch(e){throw console.error("❌ WebRTC answer handling failed:",e),e}},P=async(e,t)=>{try{let r=j.current.get(e);if(r&&r.remoteDescription)await r.addIceCandidate(t);else{let r=S.current.get(e)||[];r.push(t),S.current.set(e,r)}}catch(e){throw console.error("❌ ICE candidate handling failed:",e),e}},U=(0,o.useCallback)(async e=>{var t;if(!(null===(t=k.current)||void 0===t?void 0:t.connected))return y("Not connected to server"),!1;try{return k.current.emit("room:join",{roomId:e}),!0}catch(e){return console.error("❌ Failed to join room:",e),y("Failed to join room"),!1}},[]),V=(0,o.useCallback)(()=>{var e;(null===(e=k.current)||void 0===e?void 0:e.connected)&&n&&(k.current.emit("room:leave",{roomId:n.id}),M())},[n,M]),L=(0,o.useCallback)(async e=>{var t;if(!(null===(t=k.current)||void 0===t?void 0:t.connected))return y("Not connected to server"),null;try{return new Promise(t=>{var r;let n=setTimeout(()=>{t(null)},1e4);null===(r=k.current)||void 0===r||r.emit("room:create",{name:e},e=>{clearTimeout(n),e.success&&e.roomId?t(e.roomId):t(null)})})}catch(e){return console.error("❌ Failed to create room:",e),y("Failed to create room"),null}},[]),q=(0,o.useCallback)(async()=>{try{var e,t;if(console.log("\uD83C\uDFA4 Requesting microphone access..."),!(null===(e=navigator.mediaDevices)||void 0===e?void 0:e.getUserMedia))throw Error("getUserMedia is not supported in this browser");let r="unknown";try{(null===(t=navigator.permissions)||void 0===t?void 0:t.query)&&(r=(await navigator.permissions.query({name:"microphone"})).state,console.log("\uD83D\uDD0D Microphone permission status:",r))}catch(e){console.log("⚠️ Could not check permission status, proceeding with getUserMedia")}let n=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:44100},video:!1});D.current=n;let o=new(window.AudioContext||window.webkitAudioContext),a=o.createMediaStreamSource(n),c=o.createGain();return a.connect(c),c.connect(o.destination),N.current=o,E.current=a,C.current=c,c.gain.value=0,l(!0),console.log("✅ Microphone access granted"),!0}catch(e){return console.error("❌ Microphone error:",e),y(g[e.name]||g.UnknownError),!1}},[]),B=(0,o.useCallback)(()=>{var e;if(!D.current||!C.current)return;let t=!i;l(t),C.current.gain.value=t?0:1;let r=D.current.getAudioTracks()[0];r&&(r.enabled=!t),null===(e=k.current)||void 0===e||e.emit("participant:mute",{roomId:null==n?void 0:n.id,isMuted:t})},[i,n]),z=(0,o.useCallback)(()=>{console.log("\uD83E\uDDF9 Cleaning up VerbfyTalk..."),M(),D.current&&(D.current.getTracks().forEach(e=>{e.stop()}),D.current=null),N.current&&(N.current.close(),N.current=null),E.current&&(E.current.disconnect(),E.current=null),C.current=null,j.current.forEach(e=>{e.close()}),j.current.clear(),S.current.clear(),k.current&&(k.current.disconnect(),k.current=null),p(!1),f(!1),a(null),s([]),y(null),w(0),l(!1),R.current=!1,console.log("✅ VerbfyTalk cleanup completed")},[M]);return(0,o.useEffect)(()=>(e&&!R.current&&F(),()=>{z()}),[e,F,z]),(0,o.useEffect)(()=>{if(D.current&&n&&h)return A()},[n,h,A]),{rooms:t,currentRoom:n,joinRoom:U,leaveRoom:V,createRoom:L,isMuted:i,isConnected:h,toggleMute:B,requestMicrophone:q,participants:c,isConnecting:x,connectionError:b,reconnectionAttempts:v,disconnect:z}};var p=r(5704),x=r(72509);function f(e){let{roomId:t,onLeave:r}=e,{user:a}=(0,l.Eu)(),[c,s]=(0,o.useState)(!1),[i,d]=(0,o.useState)([]),[u,m]=(0,o.useState)(""),{isConnected:g,isConnecting:f,currentRoom:b,participants:y,isMuted:v,connectionError:w,reconnectionAttempts:k,joinRoom:D,leaveRoom:j,toggleMute:N,requestMicrophone:C,disconnect:E}=h(p.tokenStorage.getToken()||"");(0,o.useEffect)(()=>{(async()=>{if(g&&!b&&!c){s(!0);try{await D(t)?x.Am.success("Joined room successfully!"):x.Am.error("Failed to join room")}catch(e){console.error("❌ Failed to join room:",e),x.Am.error("Failed to join room")}finally{s(!1)}}})()},[g,b,t,c,D]),(0,o.useEffect)(()=>{w&&x.Am.error(w)},[w]),(0,o.useEffect)(()=>{k>0?x.Am.loading("Reconnecting... (Attempt ".concat(k,"/5)"),{id:"reconnecting"}):x.Am.dismiss("reconnecting")},[k]);let S=async()=>{await C()?(x.Am.success("Microphone access granted!"),g&&await D(t)):x.Am.error("Microphone access denied")};return(0,n.jsxs)("div",{className:"max-w-4xl mx-auto p-6",children:[(0,n.jsx)("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-6",children:(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,n.jsx)("div",{className:"text-2xl ".concat(f?"text-yellow-600":g?"text-green-600":w?"text-red-600":"text-gray-600"),children:f?"\uD83D\uDFE1":g?"\uD83D\uDFE2":w?"\uD83D\uDD34":"⚪"}),(0,n.jsxs)("div",{children:[(0,n.jsx)("h1",{className:"text-xl font-bold text-gray-900 dark:text-white",children:(null==b?void 0:b.name)||"Room: ".concat(t)}),(0,n.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:f?"Connecting...":g?"".concat(y.length," participants"):"Disconnected"})]})]}),(0,n.jsxs)("div",{className:"flex items-center space-x-3",children:[!g&&(0,n.jsx)("button",{onClick:S,className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors",children:"Enable Microphone"}),(0,n.jsx)("button",{onClick:N,disabled:!g,className:"px-4 py-2 rounded-lg font-medium transition-colors ".concat(v?"bg-red-600 hover:bg-red-700 text-white":"bg-green-600 hover:bg-green-700 text-white"," ").concat(g?"":"opacity-50 cursor-not-allowed"),children:v?"Unmute":"Mute"}),(0,n.jsx)("button",{onClick:()=>{j(),E(),null==r||r()},className:"bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium transition-colors",children:"Leave Room"})]})]})}),(0,n.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,n.jsx)("div",{className:"lg:col-span-1",children:(0,n.jsxs)("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6",children:[(0,n.jsxs)("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:["Participants (",y.length,")"]}),(0,n.jsxs)("div",{className:"space-y-3",children:[y.map(e=>(0,n.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,n.jsx)("div",{className:"w-3 h-3 rounded-full ".concat(e.isSpeaking?"bg-green-500":"bg-gray-300")}),(0,n.jsx)("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:e.name}),e.isMuted&&(0,n.jsx)("span",{className:"text-xs text-red-500",children:"\uD83D\uDD07"}),e.isSpeaking&&(0,n.jsx)("span",{className:"text-xs text-green-500",children:"\uD83C\uDFA4"})]},e.id)),0===y.length&&(0,n.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"No participants yet"})]})]})}),(0,n.jsx)("div",{className:"lg:col-span-2",children:(0,n.jsxs)("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6",children:[(0,n.jsx)("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"Chat"}),(0,n.jsxs)("div",{className:"h-64 overflow-y-auto mb-4 space-y-2",children:[i.map(e=>(0,n.jsxs)("div",{className:"text-sm",children:[(0,n.jsxs)("span",{className:"font-medium text-blue-600 dark:text-blue-400",children:[e.username,":"]})," ",(0,n.jsx)("span",{className:"text-gray-700 dark:text-gray-300",children:e.text}),(0,n.jsx)("span",{className:"text-xs text-gray-500 dark:text-gray-400 ml-2",children:e.timestamp.toLocaleTimeString()})]},e.id)),0===i.length&&(0,n.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"No messages yet. Start the conversation!"})]}),(0,n.jsxs)("form",{onSubmit:e=>{if(e.preventDefault(),u.trim()){let e={id:Date.now().toString(),text:u,username:(null==a?void 0:a.name)||"You",timestamp:new Date};d(t=>[...t,e]),m("")}},className:"flex space-x-2",children:[(0,n.jsx)("input",{type:"text",value:u,onChange:e=>m(e.target.value),placeholder:"Type a message...",className:"flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white",disabled:!g}),(0,n.jsx)("button",{type:"submit",disabled:!g||!u.trim(),className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:"Send"})]})]})})]}),w&&(0,n.jsx)("div",{className:"mt-6 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4",children:(0,n.jsxs)("div",{className:"flex",children:[(0,n.jsx)("div",{className:"flex-shrink-0",children:(0,n.jsx)("svg",{className:"h-5 w-5 text-red-400",viewBox:"0 0 20 20",fill:"currentColor",children:(0,n.jsx)("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z",clipRule:"evenodd"})})}),(0,n.jsxs)("div",{className:"ml-3",children:[(0,n.jsx)("h3",{className:"text-sm font-medium text-red-800 dark:text-red-200",children:"Connection Error"}),(0,n.jsx)("div",{className:"mt-2 text-sm text-red-700 dark:text-red-300",children:w})]})]})})]})}function b(){let e=(0,a.useRouter)(),{roomId:t}=e.query;return t?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(s(),{children:[(0,n.jsxs)("title",{children:["VerbfyTalk Room - ",t]}),(0,n.jsx)("meta",{name:"description",content:"Join the conversation in VerbfyTalk"})]}),(0,n.jsx)(i.Z,{title:"VerbfyTalk Room: ".concat(t),children:(0,n.jsx)(f,{roomId:t,onLeave:()=>{e.push("/verbfy-talk")}})})]}):(0,n.jsx)(i.Z,{title:"VerbfyTalk",children:(0,n.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("h1",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Room Not Found"}),(0,n.jsx)("p",{className:"text-gray-600 mb-6",children:"The room you're looking for doesn't exist."}),(0,n.jsx)("button",{onClick:()=>e.push("/verbfy-talk"),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors",children:"Back to Rooms"})]})})})}}},function(e){e.O(0,[1216,1088,2888,179],function(){return e(e.s=4333)}),_N_E=e.O()}]);
//# sourceMappingURL=[roomId]-48e591cc1b59f227.js.map