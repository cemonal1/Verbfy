(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8939],{4333:function(e,t,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/verbfy-talk/[roomId]",function(){return s(83383)}])},83383:function(e,t,s){"use strict";s.r(t),s.d(t,{__N_SSG:function(){return S},default:function(){return C}});var r=s(85893),n=s(67294),i=s(11163),o=s(9008),a=s.n(o),c=s(11088),l=s(67642),d=s(36197),u=s(5704),m=s(83454);let h=()=>{let{user:e}=(0,d.aC)(),t=u.tokenStorage.getToken(),[s,r]=(0,n.useState)(!1),[i,o]=(0,n.useState)(null),[a,c]=(0,n.useState)([]),[h,p]=(0,n.useState)([]),[g,x]=(0,n.useState)(!1),[v,f]=(0,n.useState)(null),[b,y]=(0,n.useState)(!1),[w]=(0,n.useState)(!1),j=(0,n.useRef)(null),N=(0,n.useRef)(null),k=(0,n.useRef)(new Map),S={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]};(0,n.useEffect)(()=>{if(!e||!t)return;let s=(0,l.io)("".concat(m.env.NEXT_PUBLIC_BACKEND_URL||"https://api.verbfy.com"),{auth:{token:t},transports:["polling"],upgrade:!0,rememberUpgrade:!0,timeout:2e4,forceNew:!0,reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3,reconnectionDelayMax:5e3,autoConnect:!0,withCredentials:!0});return j.current=s,s.on("connect",()=>{console.log("✅ Connected to VerbfyTalk server"),r(!0),f(null)}),s.on("disconnect",e=>{console.log("❌ Disconnected from VerbfyTalk server:",e),r(!1)}),s.on("connect_error",e=>{console.error("❌ Connection error:",e),f("Failed to connect to server")}),s.on("room:joined",t=>{console.log("✅ Joined room:",t.name),o(t),c(t.participants.map(e=>({id:e.userId._id,name:e.userId.name,isSpeaking:!1,isMuted:!1,isSpeaker:!1}))),f(null),x(!1),setTimeout(()=>{N.current&&t.participants.length>0&&(console.log("\uD83D\uDD17 Initializing WebRTC connections with",t.participants.length,"participants"),t.participants.forEach(t=>{t.userId._id!==(null==e?void 0:e.id)&&R(t.userId._id)}))},1e3)}),s.on("room:error",e=>{console.error("❌ Room error:",e.message),f(e.message)}),s.on("participant:joined",t=>{console.log("\uD83D\uDC64 Participant joined:",t.name),c(e=>[...e,t]),N.current&&t.id!==(null==e?void 0:e.id)&&setTimeout(()=>{R(t.id)},500)}),s.on("participant:left",e=>{console.log("\uD83D\uDC4B Participant left:",e),c(t=>t.filter(t=>t.id!==e));let t=k.current.get(e);t&&(t.close(),k.current.delete(e),console.log("\uD83D\uDD0C Closed peer connection for:",e))}),s.on("message:received",e=>{console.log("\uD83D\uDCAC Message received:",e.message),p(t=>[...t,e])}),s.on("webrtc:offer",async e=>{await T(e.from,e.offer)}),s.on("webrtc:answer",async e=>{await A(e.from,e.answer)}),s.on("webrtc:ice-candidate",async e=>{await I(e.from,e.candidate)}),()=>{s.disconnect(),j.current=null}},[e,t]);let C=(0,n.useCallback)(async(e,s)=>{var r;if(!(null===(r=j.current)||void 0===r?void 0:r.connected))return f("Not connected to server"),!1;try{x(!0),f(null);let r=await fetch("/api/verbfy-talk/".concat(e,"/join"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(t)},credentials:"include",body:JSON.stringify({password:s})});if(!r.ok){let e=await r.json();throw Error(e.message||"Failed to join room")}let n=await r.json();return console.log("✅ HTTP API join successful:",n.data.name),j.current.emit("room:join",{roomId:e,password:s}),!0}catch(e){return console.error("❌ Failed to join room:",e),f(e instanceof Error?e.message:"Failed to join room"),x(!1),!1}},[t]),D=(0,n.useCallback)(e=>{N.current=e,console.log("✅ Microphone stream set in useVerbfyTalk")},[]),M=(0,n.useCallback)(()=>{var e;(null===(e=j.current)||void 0===e?void 0:e.connected)&&i&&j.current.emit("room:leave",{roomId:i._id}),o(null),c([]),p([]),N.current&&(N.current.getTracks().forEach(e=>e.stop()),N.current=null),k.current.forEach(e=>e.close()),k.current.clear()},[i]),E=(0,n.useCallback)(e=>{var t;(null===(t=j.current)||void 0===t?void 0:t.connected)&&i&&j.current.emit("message:send",{roomId:i._id,message:e.trim()})},[i]),P=(0,n.useCallback)(()=>{if(N.current){let e=N.current.getAudioTracks()[0];e&&(e.enabled=!e.enabled,y(!e.enabled))}},[]),R=(0,n.useCallback)(async e=>{try{var t;let s=new RTCPeerConnection(S);k.current.set(e,s),N.current&&N.current.getTracks().forEach(e=>{s.addTrack(e,N.current)}),s.onicecandidate=t=>{var s;t.candidate&&(null===(s=j.current)||void 0===s?void 0:s.connected)&&j.current.emit("webrtc:ice-candidate",{to:e,candidate:t.candidate})},s.ontrack=()=>{console.log("\uD83C\uDFB5 Remote audio stream received from:",e)};let r=await s.createOffer();await s.setLocalDescription(r),(null===(t=j.current)||void 0===t?void 0:t.connected)&&j.current.emit("webrtc:offer",{to:e,offer:r}),console.log("\uD83D\uDD17 Peer connection created for:",e)}catch(e){console.error("❌ Failed to create peer connection:",e)}},[]),T=async(e,t)=>{try{var s;let r=new RTCPeerConnection(S);k.current.set(e,r),N.current&&N.current.getTracks().forEach(e=>{r.addTrack(e,N.current)}),r.onicecandidate=t=>{var s;t.candidate&&(null===(s=j.current)||void 0===s?void 0:s.connected)&&j.current.emit("webrtc:ice-candidate",{to:e,candidate:t.candidate})},r.ontrack=()=>{console.log("\uD83C\uDFB5 Remote audio stream received from:",e)},await r.setRemoteDescription(t);let n=await r.createAnswer();await r.setLocalDescription(n),(null===(s=j.current)||void 0===s?void 0:s.connected)&&j.current.emit("webrtc:answer",{to:e,answer:n})}catch(e){console.error("❌ Failed to handle offer:",e)}},A=async(e,t)=>{try{let s=k.current.get(e);s&&await s.setRemoteDescription(t)}catch(e){console.error("❌ Failed to handle answer:",e)}},I=async(e,t)=>{try{let s=k.current.get(e);s&&s.remoteDescription&&await s.addIceCandidate(t)}catch(e){console.error("❌ Failed to handle ICE candidate:",e)}};return{isConnected:s,isLoading:g,error:v,currentRoom:i,participants:a,messages:h,isMuted:b,isSpeaking:w,joinRoom:C,leaveRoom:M,sendMessage:E,toggleMute:P,createPeerConnection:R,setMicrophoneStream:D,setError:f}};class p{static getInstance(){return p.instance||(p.instance=new p),p.instance}initializePermissionState(){if(this.permissionState.isSupported=!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&"function"==typeof navigator.mediaDevices.getUserMedia),!this.permissionState.isSupported){this.permissionState.error="getUserMedia is not supported in this browser";return}"permissions"in navigator?this.checkPermissionStatus():this.permissionState.canRequest=!0}async checkPermissionStatus(){try{let e=await navigator.permissions.query({name:"microphone"});this.permissionState.isGranted="granted"===e.state,this.permissionState.isDenied="denied"===e.state,this.permissionState.canRequest="denied"!==e.state,this.permissionState.lastChecked=Date.now(),e.addEventListener("change",()=>{this.permissionState.isGranted="granted"===e.state,this.permissionState.isDenied="denied"===e.state,this.permissionState.canRequest="denied"!==e.state,this.permissionState.lastChecked=Date.now()})}catch(e){console.warn("Permissions API not fully supported:",e),this.permissionState.canRequest=!0}}async getMicrophoneDevices(){try{let e=await navigator.mediaDevices.enumerateDevices();return this.devices=e.filter(e=>"audioinput"===e.kind).map(e=>({deviceId:e.deviceId,label:e.label||"Microphone ".concat(e.deviceId.slice(0,8)),kind:e.kind,groupId:e.groupId})),this.devices}catch(e){return console.error("Failed to enumerate devices:",e),[]}}async requestMicrophonePermission(e){if(!this.permissionState.isSupported)return{success:!1,error:"Microphone access is not supported in this browser. Please use a modern browser like Chrome, Firefox, Safari, or Edge."};if(this.permissionState.isDenied)return{success:!1,error:"Microphone access has been permanently denied. Please enable microphone access in your browser settings and refresh the page."};try{var t;let s={audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:44100,channelCount:1,latency:.01},video:!1},r={audio:{...s.audio,...(null==e?void 0:e.audio)||{}},video:null!==(t=null==e?void 0:e.video)&&void 0!==t?t:s.video};this.permissionState.isPrompted=!0,console.log("\uD83C\uDFA4 Requesting microphone access with constraints:",r);let n=await navigator.mediaDevices.getUserMedia(r);return this.currentStream=n,this.permissionState.isGranted=!0,this.permissionState.isDenied=!1,this.permissionState.lastChecked=Date.now(),this.permissionState.error=void 0,console.log("✅ Microphone access granted successfully"),await this.getMicrophoneDevices(),{success:!0,stream:n}}catch(t){this.permissionState.isGranted=!1,this.permissionState.lastChecked=Date.now();let e=this.getDetailedErrorMessage(t);return this.permissionState.error=e,console.error("❌ Microphone access failed:",t),{success:!1,error:e}}}getDetailedErrorMessage(e){return e instanceof Error?({NotAllowedError:'Microphone access was denied. Please click "Allow" when prompted, or enable microphone access in your browser settings.',NotFoundError:"No microphone device found. Please connect a microphone and try again.",NotSupportedError:"Microphone access is not supported in this browser. Please use a modern browser.",NotReadableError:"Microphone is already in use by another application. Please close other applications using the microphone and try again.",AbortError:"Microphone access request was cancelled. Please try again.",SecurityError:"Microphone access is blocked due to security restrictions. Please ensure you are using HTTPS.",InvalidStateError:"Microphone is in an invalid state. Please refresh the page and try again.",TypeError:"Invalid microphone constraints. Please try again.",UnknownError:"An unknown error occurred while accessing the microphone. Please try again."})[e.name]||"Microphone access failed: ".concat(e.message||"Unknown error"):"Microphone access failed: Unknown error"}async testMicrophoneQuality(e){try{let t=new(window.AudioContext||window.webkitAudioContext),s=t.createMediaStreamSource(e),r=t.createAnalyser(),n=new Uint8Array(r.frequencyBinCount);return s.connect(r),r.fftSize=256,new Promise(e=>{let i=0,o=0,a=0,c=setInterval(()=>{r.getByteFrequencyData(n);let l=n.reduce((e,t)=>e+t,0)/n.length;if(o+=l,i++,l>10&&a++,i>=10){let n;clearInterval(c);let l=o/i,d=a/i;n=d>.7&&l>20?"excellent":d>.4&&l>10?"good":d>.1&&l>5?"poor":"none",e({isWorking:"none"!==n,hasAudio:d>.1,volumeLevel:l,quality:n}),s.disconnect(),r.disconnect(),t.close()}},100)})}catch(e){return console.error("Microphone quality test failed:",e),{isWorking:!1,hasAudio:!1,volumeLevel:0,quality:"none"}}}stopMicrophone(){this.currentStream&&(this.currentStream.getTracks().forEach(e=>{e.stop(),console.log("\uD83D\uDD07 Microphone track stopped")}),this.currentStream=null)}getPermissionState(){return{...this.permissionState}}isMicrophoneActive(){return null!==this.currentStream&&this.currentStream.getAudioTracks().some(e=>"live"===e.readyState)}getBrowserCompatibility(){return{getUserMedia:!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia),permissionsAPI:"permissions"in navigator,audioContext:!!(window.AudioContext||window.webkitAudioContext),webRTC:!!(window.RTCPeerConnection||window.webkitRTCPeerConnection),https:"https:"===location.protocol||"localhost"===location.hostname}}resetPermissionState(){this.stopMicrophone(),this.permissionState={isSupported:!1,isGranted:!1,isDenied:!1,isPrompted:!1,canRequest:!1,lastChecked:0},this.initializePermissionState()}constructor(){this.devices=[],this.currentStream=null,this.permissionState={isSupported:!1,isGranted:!1,isDenied:!1,isPrompted:!1,canRequest:!1,lastChecked:0},this.initializePermissionState()}}let g=p.getInstance(),x=()=>{let[e,t]=(0,n.useState)(g.getPermissionState()),[s,r]=(0,n.useState)([]),[i,o]=(0,n.useState)(null),[a,c]=(0,n.useState)(null),[l,d]=(0,n.useState)(!1),[u,m]=(0,n.useState)({isWorking:!1,hasAudio:!1,volumeLevel:0,quality:"none"}),[h,p]=(0,n.useState)(null),x=(0,n.useRef)(null),v=g.getBrowserCompatibility(),f=(0,n.useCallback)(()=>{let e=g.getPermissionState();t(e),p(e.error||null)},[]),b=(0,n.useCallback)(async()=>{try{let e=await g.getMicrophoneDevices();if(r(e),a&&e.length>0){let t=a.getAudioTracks()[0];if(t){let s=e.find(e=>e.deviceId===t.getSettings().deviceId);o(s||e[0])}}}catch(e){console.error("Failed to refresh devices:",e)}},[a]),y=(0,n.useCallback)(async e=>{try{p(null);let t=await g.requestMicrophonePermission(e);return t.success&&t.stream?(c(t.stream),d(!0),await b(),N(t.stream)):p(t.error||"Failed to access microphone"),f(),t}catch(t){let e=t instanceof Error?t.message:"Unknown error occurred";return p(e),f(),{success:!1,error:e}}},[b,f]),w=(0,n.useCallback)(()=>{g.stopMicrophone(),c(null),d(!1),m({isWorking:!1,hasAudio:!1,volumeLevel:0,quality:"none"}),x.current&&(clearInterval(x.current),x.current=null),f()},[f]),j=(0,n.useCallback)(async()=>{if(a)try{let e=await g.testMicrophoneQuality(a);m(e)}catch(e){console.error("Quality test failed:",e)}},[a]),N=(0,n.useCallback)(e=>{x.current&&clearInterval(x.current),x.current=setInterval(async()=>{try{let t=await g.testMicrophoneQuality(e);m(t),d(t.isWorking)}catch(e){console.error("Quality monitoring failed:",e),d(!1)}},2e3)},[]),k=(0,n.useCallback)(()=>{p(null)},[]);return(0,n.useEffect)(()=>{f(),b();let e=setInterval(f,5e3);return()=>{clearInterval(e),x.current&&clearInterval(x.current)}},[f,b]),(0,n.useEffect)(()=>{if(a){let e=a.getAudioTracks()[0];if(e){let t=()=>{console.log("\uD83C\uDFA4 Audio track ended"),d(!1),m(e=>({...e,isWorking:!1,quality:"none"}))},s=()=>{console.log("\uD83D\uDD07 Audio track muted"),d(!1)},r=()=>{console.log("\uD83D\uDD0A Audio track unmuted"),d(!0)};return e.addEventListener("ended",t),e.addEventListener("mute",s),e.addEventListener("unmute",r),()=>{e.removeEventListener("ended",t),e.removeEventListener("mute",s),e.removeEventListener("unmute",r)}}}},[a]),{permissionState:e,isSupported:e.isSupported,isGranted:e.isGranted,isDenied:e.isDenied,canRequest:e.canRequest,devices:s,currentDevice:i,currentStream:a,isActive:l,quality:u,requestPermission:y,stopMicrophone:w,testQuality:j,refreshDevices:b,browserCompatibility:v,error:h,clearError:k}};var v=s(54910),f=s(11429),b=s(29711),y=s(13431),w=s(61937);function j(e){let{onPermissionGranted:t,onCancel:s,roomName:i="VerbfyTalk Room"}=e,{permissionState:o,isSupported:a,isGranted:c,isDenied:l,canRequest:d,devices:u,currentStream:m,isActive:h,quality:p,requestPermission:g,stopMicrophone:j,testQuality:N,refreshDevices:k,browserCompatibility:S,error:C,clearError:D}=x(),[M,E]=(0,n.useState)(!1),[P,R]=(0,n.useState)(!1),[T,A]=(0,n.useState)("");(0,n.useEffect)(()=>{a&&d&&!c&&!l&&I()},[a,d,c,l]),(0,n.useEffect)(()=>{m&&h&&p.isWorking&&t(m)},[m,h,p.isWorking,t]);let I=async()=>{E(!0),D();let e=T?{audio:{deviceId:{exact:T},echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:44100,channelCount:1,latency:.01},video:!1}:void 0,t=await g(e);t.success?console.log("✅ Microphone permission granted"):console.error("❌ Microphone permission failed:",t.error),E(!1)},q=async()=>{j(),await k(),await I()},F=async()=>{await N()};return(0,r.jsx)("div",{className:"flex items-center justify-center h-screen bg-gray-900",children:(0,r.jsxs)("div",{className:"text-center max-w-md mx-auto p-6",children:[(0,r.jsxs)("div",{className:"mb-6",children:[M?(0,r.jsx)(v.Z,{className:"w-16 h-16 text-blue-600 animate-spin"}):c&&h&&p.isWorking?(0,r.jsx)(f.Z,{className:"w-16 h-16 text-green-600"}):l?(0,r.jsx)(b.Z,{className:"w-16 h-16 text-red-600"}):a?(0,r.jsx)(w.Z,{className:"w-16 h-16 text-blue-600"}):(0,r.jsx)(y.Z,{className:"w-16 h-16 text-yellow-600"}),(0,r.jsx)("h2",{className:"text-2xl font-bold text-white mt-4 mb-2",children:"Microphone Access Required"}),(0,r.jsxs)("p",{className:"text-gray-300 mb-4",children:[i," needs access to your microphone for voice chat."]})]}),(0,r.jsxs)("div",{className:"mb-6 p-4 rounded-lg bg-gray-800 ".concat(c&&h&&p.isWorking?"text-green-600":l||C?"text-red-600":a?"text-blue-600":"text-yellow-600"),children:[(0,r.jsx)("p",{className:"text-sm font-medium",children:M?"Requesting microphone access...":c&&h&&p.isWorking?"Microphone access granted! Quality: ".concat(p.quality):l?"Microphone access was denied. Please enable it in your browser settings.":a?C||"Microphone access is required for voice chat.":"Microphone access is not supported in this browser."}),h&&p.isWorking?(0,r.jsxs)("div",{className:"mt-4 flex items-center justify-center gap-2",children:[(0,r.jsx)("div",{className:"w-3 h-3 rounded-full ".concat({excellent:"bg-green-500",good:"bg-blue-500",poor:"bg-yellow-500",none:"bg-red-500"}[p.quality]," animate-pulse")}),(0,r.jsxs)("span",{className:"text-sm text-gray-400",children:["Quality: ",p.quality," | Volume: ",Math.round(p.volumeLevel)]})]}):null]}),C&&(0,r.jsxs)("div",{className:"mb-6 p-4 bg-red-900 border border-red-700 rounded-lg",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,r.jsx)(y.Z,{className:"w-5 h-5 text-red-400"}),(0,r.jsx)("span",{className:"text-red-400 font-medium",children:"Error"})]}),(0,r.jsx)("p",{className:"text-red-300 text-sm",children:C})]}),(0,r.jsxs)("div",{className:"space-y-3",children:[!c&&d&&!M&&(0,r.jsx)("button",{onClick:I,className:"w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors",children:"Allow Microphone Access"}),c&&h&&(0,r.jsx)("button",{onClick:F,className:"w-full bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors",children:"Test Microphone Quality"}),(l||C)&&(0,r.jsx)("button",{onClick:q,className:"w-full bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-3 rounded-lg font-medium transition-colors",children:"Retry Microphone Access"}),(0,r.jsxs)("button",{onClick:()=>R(!P),className:"w-full bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-medium transition-colors",children:[P?"Hide":"Show"," Advanced Options"]})]}),P&&(0,r.jsxs)("div",{className:"mt-6",children:[P&&0!==u.length?(0,r.jsxs)("div",{className:"mt-4",children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-white mb-2",children:"Select Microphone Device"}),(0,r.jsxs)("select",{value:T,onChange:e=>A(e.target.value),className:"w-full bg-gray-700 text-white px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[(0,r.jsx)("option",{value:"",children:"Default Device"}),u.map(e=>(0,r.jsx)("option",{value:e.deviceId,children:e.label},e.deviceId))]})]}):null,P?(0,r.jsxs)("div",{className:"mt-6 p-4 bg-gray-800 rounded-lg",children:[(0,r.jsx)("h4",{className:"text-sm font-semibold text-white mb-3",children:"Browser Compatibility"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(f.Z,{className:"w-4 h-4 ".concat(S.getUserMedia?"text-green-500":"text-red-500")}),(0,r.jsx)("span",{className:"text-gray-300",children:"getUserMedia"})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(f.Z,{className:"w-4 h-4 ".concat(S.permissionsAPI?"text-green-500":"text-red-500")}),(0,r.jsx)("span",{className:"text-gray-300",children:"Permissions API"})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(f.Z,{className:"w-4 h-4 ".concat(S.audioContext?"text-green-500":"text-red-500")}),(0,r.jsx)("span",{className:"text-gray-300",children:"Audio Context"})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(f.Z,{className:"w-4 h-4 ".concat(S.webRTC?"text-green-500":"text-red-500")}),(0,r.jsx)("span",{className:"text-gray-300",children:"WebRTC"})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(f.Z,{className:"w-4 h-4 ".concat(S.https?"text-green-500":"text-red-500")}),(0,r.jsx)("span",{className:"text-gray-300",children:"HTTPS"})]})]})]}):null]}),(0,r.jsxs)("div",{className:"mt-6 text-sm text-gray-400 space-y-1",children:[(0,r.jsx)("p",{children:"• Your microphone will only be used for voice chat"}),(0,r.jsx)("p",{children:"• You can mute/unmute anytime during the conversation"}),(0,r.jsx)("p",{children:"• No audio is recorded or stored"}),(0,r.jsx)("p",{children:"• Microphone access can be revoked in browser settings"})]}),(0,r.jsx)("button",{onClick:s,className:"mt-6 text-gray-400 hover:text-white transition-colors",children:"← Back to Rooms"})]})})}var N=s(82861);function k(e){let{roomId:t,onLeave:s}=e,{isConnected:i,isLoading:o,error:a,currentRoom:c,participants:l,messages:d,isMuted:u,isSpeaking:m,joinRoom:p,leaveRoom:g,sendMessage:x,toggleMute:v,setMicrophoneStream:f,setError:b}=h(),[y,k]=(0,n.useState)(!1),[S,C]=(0,n.useState)("");(0,n.useEffect)(()=>{t&&i&&y&&p(t).catch(e=>{console.error("❌ Failed to join room in useEffect:",e),b("Failed to join room. Please try again.")})},[t,i,y,p]);let D=()=>{g(),s()};return o?(0,r.jsx)("div",{className:"flex items-center justify-center h-screen bg-gray-900",children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),(0,r.jsx)("p",{className:"mt-4 text-white",children:"Joining room..."})]})}):y?a?(0,r.jsx)("div",{className:"flex items-center justify-center h-screen bg-gray-900",children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("p",{className:"text-red-400 mb-4",children:a}),(0,r.jsx)("button",{onClick:()=>{b(null),p(t)},className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg mr-4",children:"Retry"}),(0,r.jsx)("button",{onClick:D,className:"bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg",children:"Leave Room"})]})}):(0,r.jsxs)("div",{className:"h-screen flex flex-col bg-gray-900",children:[(0,r.jsxs)("div",{className:"bg-gray-800 p-4 flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex items-center gap-4",children:[(0,r.jsx)("button",{onClick:D,className:"text-gray-300 hover:text-white p-2 rounded-lg hover:bg-gray-700",children:(0,r.jsx)(N.Z,{className:"w-6 h-6"})}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h1",{className:"text-xl font-bold text-white",children:(null==c?void 0:c.name)||"Room ".concat(t)}),(0,r.jsxs)("p",{className:"text-gray-400 text-sm",children:[l.length," participant",1!==l.length?"s":""]})]})]}),(0,r.jsx)("div",{className:"flex items-center gap-4",children:(0,r.jsxs)("button",{onClick:v,className:"p-3 rounded-full transition-colors relative ".concat(u?"bg-red-600 hover:bg-red-700 text-white":m?"bg-green-600 hover:bg-green-700 text-white animate-pulse":"bg-green-600 hover:bg-green-700 text-white"),children:[(0,r.jsx)(w.Z,{className:"w-6 h-6 ".concat(u?"opacity-50":"")}),m&&!u&&(0,r.jsx)("div",{className:"absolute -top-1 -right-1 w-3 h-3 bg-green-400 rounded-full animate-pulse"})]})})]}),(0,r.jsxs)("div",{className:"flex-1 flex",children:[(0,r.jsxs)("div",{className:"w-1/3 bg-gray-800 p-4",children:[(0,r.jsx)("h2",{className:"text-lg font-semibold text-white mb-4",children:"Participants"}),(0,r.jsx)("div",{className:"space-y-2",children:l.map(e=>(0,r.jsxs)("div",{className:"flex items-center gap-3 p-3 rounded-lg transition-colors ".concat(e.isSpeaking?"bg-green-700 border border-green-500":"bg-gray-700"),children:[(0,r.jsx)("div",{className:"w-3 h-3 rounded-full transition-colors ".concat(e.isSpeaking?"bg-green-500 animate-pulse":"bg-gray-500")}),(0,r.jsx)("span",{className:"text-white font-medium",children:e.name}),e.isMuted&&(0,r.jsx)(w.Z,{className:"w-4 h-4 text-red-400 opacity-50"}),e.isSpeaking&&(0,r.jsx)("div",{className:"ml-auto",children:(0,r.jsx)("div",{className:"w-2 h-2 bg-green-400 rounded-full animate-pulse"})})]},e.id))})]}),(0,r.jsxs)("div",{className:"flex-1 flex flex-col",children:[(0,r.jsx)("div",{className:"flex-1 p-4 overflow-y-auto",children:(0,r.jsx)("div",{className:"space-y-4",children:d.map(e=>(0,r.jsxs)("div",{className:"flex gap-3",children:[(0,r.jsx)("div",{className:"w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white text-sm font-semibold",children:e.userName.charAt(0).toUpperCase()}),(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,r.jsx)("span",{className:"text-white font-semibold",children:e.userName}),(0,r.jsx)("span",{className:"text-gray-400 text-sm",children:new Date(e.timestamp).toLocaleTimeString()})]}),(0,r.jsx)("p",{className:"text-gray-300",children:e.message})]})]},e.id))})}),(0,r.jsx)("div",{className:"p-4 border-t border-gray-700",children:(0,r.jsxs)("form",{onSubmit:e=>{e.preventDefault(),S.trim()&&(x(S),C(""))},className:"flex gap-3",children:[(0,r.jsx)("input",{type:"text",value:S,onChange:e=>C(e.target.value),placeholder:"Type a message...",className:"flex-1 bg-gray-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600"}),(0,r.jsx)("button",{type:"submit",disabled:!S.trim(),className:"bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white px-6 py-2 rounded-lg transition-colors",children:"Send"})]})})]})]})]}):(0,r.jsx)(j,{onPermissionGranted:e=>{try{console.log("✅ Microphone permission granted, setting stream..."),f(e),k(!0),t&&i&&p(t).catch(e=>{console.error("❌ Failed to join room:",e),b("Failed to join room. Please try again.")})}catch(e){console.error("❌ Error handling microphone permission:",e),b("Failed to initialize microphone. Please try again.")}},onCancel:()=>{try{console.log("❌ Microphone permission cancelled"),s()}catch(e){console.error("❌ Error handling microphone cancellation:",e),s()}},roomName:(null==c?void 0:c.name)||"Room ".concat(t)})}var S=!0;function C(){let e=(0,i.useRouter)(),{roomId:t}=e.query,[s,o]=(0,n.useState)(!0),[l,d]=(0,n.useState)(!1);(0,n.useEffect)(()=>{e.isReady&&(t&&"string"==typeof t&&t.trim().length>0?d(/^[0-9a-fA-F]{24}$/.test(t)):d(!1),o(!1))},[e.isReady,t]);let u=()=>{e.push("/verbfy-talk")};return s?(0,r.jsx)(c.Z,{title:"VerbfyTalk",children:(0,r.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),(0,r.jsx)("p",{className:"text-gray-600",children:"Loading room..."})]})})}):t&&l?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(a(),{children:[(0,r.jsxs)("title",{children:["VerbfyTalk Room - ",t]}),(0,r.jsx)("meta",{name:"description",content:"Join the conversation in VerbfyTalk"})]}),(0,r.jsx)(c.Z,{title:"VerbfyTalk Room: ".concat(t),children:(0,r.jsx)(D,{fallback:(0,r.jsx)(M,{onLeave:u}),children:(0,r.jsx)(k,{roomId:t,onLeave:u})})})]}):(0,r.jsx)(c.Z,{title:"VerbfyTalk",children:(0,r.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("h1",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Room Not Found"}),(0,r.jsx)("p",{className:"text-gray-600 mb-6",children:t?"The room ID format is invalid or the room does not exist.":"No room ID provided."}),(0,r.jsx)("button",{onClick:()=>e.push("/verbfy-talk"),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors",children:"Back to Rooms"})]})})})}class D extends n.Component{static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){console.error("VerbfyTalk Room Error:",e,t)}render(){return this.state.hasError?this.props.fallback:this.props.children}constructor(e){super(e),this.state={hasError:!1}}}function M(e){let{onLeave:t}=e;return(0,r.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("h1",{className:"text-2xl font-bold text-red-600 mb-4",children:"Room Error"}),(0,r.jsx)("p",{className:"text-gray-600 mb-6",children:"Something went wrong while loading the room. Please try again."}),(0,r.jsx)("button",{onClick:t,className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors",children:"Back to Rooms"})]})})}}},function(e){e.O(0,[1216,1088,2888,179],function(){return e(e.s=4333)}),_N_E=e.O()}]);
//# sourceMappingURL=[roomId]-d6d7d888bde050f2.js.map