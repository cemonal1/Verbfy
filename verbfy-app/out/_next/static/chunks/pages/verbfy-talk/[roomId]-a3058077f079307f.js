(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8939],{4333:function(e,s,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/verbfy-talk/[roomId]",function(){return a(89878)}])},89878:function(e,s,a){"use strict";a.r(s),a.d(s,{default:function(){return j}});var t=a(85893),r=a(67294),l=a(11163),n=a(11088),i=a(32798),c=a(36197),o=a(65567),d=function(e){let{messages:s,onSendMessage:a,isConnected:l}=e,[n,i]=(0,r.useState)(""),c=(0,r.useRef)(null),d=()=>{var e;null===(e=c.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})};(0,r.useEffect)(()=>{d()},[s]);let m=e=>new Intl.DateTimeFormat("en-US",{hour:"2-digit",minute:"2-digit"}).format(e);return(0,t.jsxs)("div",{className:"flex flex-col h-full bg-white border rounded-lg",children:[(0,t.jsxs)("div",{className:"p-4 border-b bg-gray-50 rounded-t-lg",children:[(0,t.jsx)("h3",{className:"font-semibold text-gray-900",children:"Chat"}),(0,t.jsxs)("div",{className:"flex items-center gap-2 mt-1",children:[(0,t.jsx)("div",{className:"w-2 h-2 rounded-full ".concat(l?"bg-green-500":"bg-red-500")}),(0,t.jsx)("span",{className:"text-xs text-gray-600",children:l?"Connected":"Disconnected"})]})]}),(0,t.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:[0===s.length?(0,t.jsx)("div",{className:"text-center text-gray-500 text-sm",children:"No messages yet. Start the conversation!"}):s.map(e=>(0,t.jsx)("div",{className:"flex flex-col ".concat("system"===e.type?"items-center":"items-start"),children:"system"===e.type?(0,t.jsx)("div",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded",children:e.message}):(0,t.jsxs)("div",{className:"max-w-[80%]",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,t.jsx)("span",{className:"text-xs font-medium text-gray-700",children:e.userName}),(0,t.jsx)("span",{className:"text-xs text-gray-500",children:m(e.timestamp)})]}),(0,t.jsx)("div",{className:"bg-blue-100 text-blue-900 px-3 py-2 rounded-lg text-sm",children:e.message})]})},e.id)),(0,t.jsx)("div",{ref:c})]}),(0,t.jsx)("form",{onSubmit:e=>{e.preventDefault(),n.trim()&&l&&(a(n.trim()),i(""))},className:"p-4 border-t",children:(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsx)("input",{type:"text",value:n,onChange:e=>i(e.target.value),placeholder:l?"Type a message...":"Connecting...",disabled:!l,className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed"}),(0,t.jsx)("button",{type:"submit",disabled:!n.trim()||!l,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors",children:(0,t.jsx)(o.Z,{className:"w-4 h-4"})})]})})]})},m=a(72509),u=a(61937),x=a(82861),h=a(64964),g=a(35892),b=a(22877),f=a(4553),p=a(40068),v=a(18689),j=function(){let e=(0,l.useRouter)(),{user:s}=(0,c.Eu)(),{roomId:a}=e.query,[o,j]=(0,r.useState)(null),[y,N]=(0,r.useState)(!0),[w,k]=(0,r.useState)(!1),[C,D]=(0,r.useState)(50),[S,R]=(0,r.useState)(!1),[E,T]=(0,r.useState)(!1),{localStream:A,remoteStreams:M,isMicOn:P,isCameraOn:_,toggleMic:F,toggleCamera:I,reconnect:Z,status:L,error:B,muteStates:O,videoStates:q,toggleRemoteMute:U,toggleRemoteVideo:V,isInitializing:Y}=(s&&a&&"".concat(s.id,"-verbfy-talk-").concat(a),function(e,s,a){let[t,l]=(0,r.useState)(null),[n,i]=(0,r.useState)({}),[c,o]=(0,r.useState)(!0),[d,m]=(0,r.useState)(!0),[u,x]=(0,r.useState)("disconnected"),[h,g]=(0,r.useState)(null),[b,f]=(0,r.useState)({}),[p,v]=(0,r.useState)({}),[j,y]=(0,r.useState)(!1),N=(0,r.useRef)(null);(0,r.useEffect)(()=>(w(),()=>{N.current&&N.current.getTracks().forEach(e=>{e.stop()})}),[]);let w=async()=>{try{if(y(!0),g(null),x("connecting"),!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw Error("Your browser does not support media access. Please use a modern browser like Chrome, Firefox, Safari, or Edge.");console.log("\uD83C\uDFA4 Requesting microphone and camera access...");try{let e=await Promise.all([navigator.permissions.query({name:"microphone"}),navigator.permissions.query({name:"camera"})]);if(console.log("\uD83D\uDCCB Current permissions:",{microphone:e[0].state,camera:e[1].state}),"denied"===e[0].state||"denied"===e[1].state)throw Error("Media permissions are denied. Please allow microphone and camera access in your browser settings.")}catch(e){console.warn("⚠️ Could not check permissions:",e)}let e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:44100},video:{width:{ideal:1280,max:1920},height:{ideal:720,max:1080},frameRate:{ideal:30,max:60},facingMode:"user"}});console.log("✅ Media access granted:",{audioTracks:e.getAudioTracks().length,videoTracks:e.getVideoTracks().length}),N.current=e,l(e),x("connected");let s=e.getAudioTracks()[0],a=e.getVideoTracks()[0];s&&(s.enabled=c,s.addEventListener("ended",()=>{console.warn("\uD83C\uDFA4 Audio track ended"),g("Microphone access was lost. Please refresh the page.")})),a&&(a.enabled=d,a.addEventListener("ended",()=>{console.warn("\uD83D\uDCF9 Video track ended"),g("Camera access was lost. Please refresh the page.")}))}catch(s){console.error("❌ Failed to access media devices:",s);let e="Failed to access microphone and camera";if("NotAllowedError"===s.name)e='Microphone and camera access denied. Please click the camera/microphone icon in your browser\'s address bar and select "Allow", then refresh the page.';else if("NotFoundError"===s.name)e="No microphone or camera found. Please check that your devices are connected and working properly.";else if("NotReadableError"===s.name)e="Microphone or camera is already in use by another application. Please close other applications using your camera/microphone and try again.";else if("OverconstrainedError"===s.name){e="Camera constraints cannot be satisfied. Trying with basic settings...";try{console.log("\uD83D\uDD04 Trying with basic media constraints...");let e=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0});N.current=e,l(e),x("connected"),console.log("✅ Connected with basic media constraints");return}catch(s){console.error("❌ Failed with basic constraints too:",s),e="Failed to access media devices even with basic settings. Please check your browser permissions and device connections."}}else"SecurityError"===s.name?e="Media access blocked due to security restrictions. Please ensure you're using HTTPS and try again.":s.message&&(e=s.message);g(e),x("error")}finally{y(!1)}},k=(0,r.useCallback)(()=>{if(N.current){let e=N.current.getAudioTracks()[0];if(e){let s=!c;e.enabled=s,o(s),console.log("\uD83C\uDFA4 Microphone ".concat(s?"enabled":"disabled"))}}},[c]),C=(0,r.useCallback)(()=>{if(N.current){let e=N.current.getVideoTracks()[0];if(e){let s=!d;e.enabled=s,m(s),console.log("\uD83D\uDCF9 Camera ".concat(s?"enabled":"disabled"))}}},[d]),D=(0,r.useCallback)(async()=>{console.log("\uD83D\uDD04 Reconnecting to room:",e),x("reconnecting"),N.current&&N.current.getTracks().forEach(e=>e.stop()),await w()},[e]),S=(0,r.useCallback)(e=>{f(s=>({...s,[e]:!s[e]}))},[]),R=(0,r.useCallback)(e=>{v(s=>({...s,[e]:!s[e]}))},[]),E=()=>!!navigator.mediaDevices&&!!navigator.mediaDevices.getUserMedia||(g("Your browser does not support media devices. Please use a modern browser like Chrome, Firefox, or Safari."),!1);return(0,r.useEffect)(()=>{E()||x("error")},[]),{localStream:t,remoteStreams:n,isMicOn:c,isCameraOn:d,toggleMic:k,toggleCamera:C,reconnect:D,status:u,error:h,muteStates:b,videoStates:p,toggleRemoteMute:S,toggleRemoteVideo:R,isInitializing:j}}(a,0,0)),{messages:z,sendMessage:X,isConnected:G}=function(e){let[s,a]=(0,r.useState)([]),[t]=(0,r.useState)(!1);return{messages:s,sendMessage:(0,r.useCallback)(e=>{let s={id:Date.now().toString(),userId:"current-user",userName:"You",message:e,timestamp:new Date,type:"text"};a(e=>[...e,s])},[]),isConnected:t}}(0),H=(0,r.useRef)(null),J=(0,r.useRef)({});(0,r.useEffect)(()=>{a&&"string"==typeof a&&K()},[a]),(0,r.useEffect)(()=>{A&&H.current&&(H.current.srcObject=A)},[A]),(0,r.useEffect)(()=>{Object.entries(M).forEach(e=>{let[s,a]=e,t=J.current[s];t&&a&&(t.srcObject=a)})},[M]);let K=async()=>{try{N(!0);let e=await i.bl.getRoomDetails(a);j(e.data)}catch(s){m.Am.error("Failed to load room details"),e.push("/verbfy-talk")}finally{N(!1)}},Q=async()=>{try{await i.bl.leaveRoom(a),m.Am.success("Left room successfully"),e.push("/verbfy-talk")}catch(a){var s,t,r;(null===(s=a.response)||void 0===s?void 0:s.status)===400&&(null===(r=a.response)||void 0===r?void 0:null===(t=r.data)||void 0===t?void 0:t.message)==="Not in room"?(m.Am.success("Left room successfully"),e.push("/verbfy-talk")):(console.error("Leave room error:",a),m.Am.error("Failed to leave room"))}};if(y||Y)return(0,t.jsx)(n.Z,{allowedRoles:["student","teacher"],children:(0,t.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),(0,t.jsx)("p",{className:"mt-4 text-gray-600",children:y?"Loading room...":"Requesting microphone and camera access..."}),Y&&(0,t.jsx)("p",{className:"mt-2 text-sm text-gray-500",children:"Please allow access to your microphone and camera when prompted"})]})})});if(!o)return(0,t.jsx)(n.Z,{allowedRoles:["student","teacher"],children:(0,t.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("p",{className:"text-gray-600",children:"Room not found"}),(0,t.jsx)("button",{onClick:()=>e.push("/verbfy-talk"),className:"mt-4 bg-blue-600 text-white px-4 py-2 rounded",children:"Back to Rooms"})]})})});if(B&&"error"===L)return(0,t.jsx)(n.Z,{allowedRoles:["student","teacher"],children:(0,t.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,t.jsxs)("div",{className:"text-center max-w-md",children:[(0,t.jsx)("div",{className:"text-red-500 mb-4",children:(0,t.jsx)(u.Z,{className:"w-16 h-16 mx-auto mb-4"})}),(0,t.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Media Access Required"}),(0,t.jsx)("p",{className:"text-gray-600 mb-6",children:B}),(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsx)("button",{onClick:Z,className:"w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition-colors",children:"Try Again"}),(0,t.jsx)("button",{onClick:()=>e.push("/verbfy-talk"),className:"w-full bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded transition-colors",children:"Back to Rooms"})]}),(0,t.jsxs)("div",{className:"mt-6 text-sm text-gray-500",children:[(0,t.jsx)("p",{className:"font-medium mb-2",children:"To fix this issue:"}),(0,t.jsxs)("ul",{className:"text-left space-y-1",children:[(0,t.jsx)("li",{children:"• Click the camera/microphone icon in your browser's address bar"}),(0,t.jsx)("li",{children:'• Select "Allow" for both camera and microphone'}),(0,t.jsx)("li",{children:"• Refresh the page and try again"})]})]})]})})});let W=[];return"object"==typeof o.createdBy?o.createdBy._id:o.createdBy,null==s||s.id,(0,t.jsx)(n.Z,{allowedRoles:["student","teacher"],children:(0,t.jsxs)("div",{className:"h-screen flex flex-col bg-gray-900",children:[(0,t.jsx)("div",{className:"bg-white border-b px-6 py-4",children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsx)("button",{onClick:()=>e.push("/verbfy-talk"),className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:(0,t.jsx)(x.Z,{className:"w-5 h-5"})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h1",{className:"text-xl font-semibold text-gray-900",children:o.name}),(0,t.jsxs)("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[(0,t.jsxs)("span",{className:"flex items-center gap-1 ".concat((e=>{switch(e){case"Beginner":return"text-green-600";case"Intermediate":return"text-yellow-600";case"Advanced":return"text-red-600";default:return"text-blue-600"}})(o.level)),children:[(0,t.jsx)(h.Z,{className:"w-4 h-4"}),o.level]}),(0,t.jsx)("span",{children:"•"}),(0,t.jsxs)("span",{className:"flex items-center gap-1",children:[(0,t.jsx)(g.Z,{className:"w-4 h-4"}),W.length,"/",o.maxParticipants]}),o.topic&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("span",{children:"•"}),(0,t.jsx)("span",{children:o.topic})]})]})]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("button",{onClick:()=>k(!w),className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:(0,t.jsx)(g.Z,{className:"w-5 h-5"})}),(0,t.jsx)("button",{onClick:Q,className:"bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors",children:"Leave Room"})]})]})}),(0,t.jsxs)("div",{className:"flex-1 flex",children:[(0,t.jsxs)("div",{className:"flex-1 flex flex-col",children:[B&&(0,t.jsx)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 m-4",children:(0,t.jsxs)("div",{className:"flex items-start gap-3",children:[(0,t.jsx)("div",{className:"flex-shrink-0",children:(0,t.jsx)("svg",{className:"w-5 h-5 text-red-500",fill:"currentColor",viewBox:"0 0 20 20",children:(0,t.jsx)("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z",clipRule:"evenodd"})})}),(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("h3",{className:"text-sm font-medium text-red-800",children:"Media Access Error"}),(0,t.jsx)("p",{className:"text-sm text-red-700 mt-1",children:B}),(0,t.jsxs)("div",{className:"mt-3 flex gap-2",children:[(0,t.jsx)("button",{onClick:Z,className:"bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition-colors",disabled:Y,children:Y?"Retrying...":"Try Again"}),(0,t.jsx)("button",{onClick:()=>e.push("/verbfy-talk/test-media"),className:"bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm transition-colors",children:"Test Media"})]})]})]})}),Y&&(0,t.jsx)("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 m-4",children:(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("div",{className:"flex-shrink-0",children:(0,t.jsx)("div",{className:"w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h3",{className:"text-sm font-medium text-blue-800",children:"Initializing Media"}),(0,t.jsx)("p",{className:"text-sm text-blue-700",children:"Requesting access to your camera and microphone..."})]})]})}),(0,t.jsx)("div",{className:"flex-1 p-4",children:(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 h-full",children:[(0,t.jsxs)("div",{className:"relative bg-gray-800 rounded-lg overflow-hidden",children:[(0,t.jsx)("video",{ref:H,autoPlay:!0,muted:!0,playsInline:!0,className:"w-full h-full object-cover"}),(0,t.jsxs)("div",{className:"absolute bottom-2 left-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-sm",children:["You ",!_&&"(Camera Off)"," ",!P&&"(Mic Off)"]}),"connecting"===L&&(0,t.jsx)("div",{className:"absolute top-2 right-2 bg-yellow-500 text-white px-2 py-1 rounded text-xs",children:"Connecting..."}),"connected"===L&&(0,t.jsx)("div",{className:"absolute top-2 right-2 bg-green-500 text-white px-2 py-1 rounded text-xs",children:"Connected"})]}),W.filter(e=>e.userId._id!==(null==s?void 0:s.id)).map((e,s)=>(0,t.jsxs)("div",{className:"relative bg-gray-800 rounded-lg overflow-hidden",children:[(0,t.jsx)("video",{ref:s=>{J.current[e.userId._id]=s},autoPlay:!0,playsInline:!0,className:"w-full h-full object-cover"}),(0,t.jsx)("div",{className:"absolute bottom-2 left-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-sm",children:e.userId.name})]},e.userId._id))]})}),(0,t.jsx)("div",{className:"bg-white border-t px-6 py-4",children:(0,t.jsxs)("div",{className:"flex items-center justify-center gap-4",children:[(0,t.jsx)("button",{onClick:F,className:"p-3 rounded-full transition-colors ".concat(P?"bg-gray-200 hover:bg-gray-300":"bg-red-500 hover:bg-red-600 text-white"),children:(0,t.jsx)(u.Z,{className:"w-6 h-6"})}),(0,t.jsx)("button",{onClick:I,className:"p-3 rounded-full transition-colors ".concat(_?"bg-gray-200 hover:bg-gray-300":"bg-red-500 hover:bg-red-600 text-white"),children:_?(0,t.jsx)(b.Z,{className:"w-6 h-6"}):(0,t.jsx)(f.Z,{className:"w-6 h-6"})}),(0,t.jsx)("button",{onClick:()=>T(!E),className:"p-3 rounded-full transition-colors ".concat(E?"bg-blue-500 hover:bg-blue-600 text-white":"bg-gray-200 hover:bg-gray-300"),children:(0,t.jsx)(p.Z,{className:"w-6 h-6"})}),(0,t.jsx)("button",{onClick:Q,className:"p-3 bg-red-500 hover:bg-red-600 text-white rounded-full transition-colors",children:(0,t.jsx)(v.Z,{className:"w-6 h-6"})})]})})]}),(0,t.jsxs)("div",{className:"w-80 bg-white border-l flex flex-col",children:[w&&(0,t.jsxs)("div",{className:"border-b p-4",children:[(0,t.jsx)("h3",{className:"font-semibold text-gray-900 mb-3",children:"Participants"}),(0,t.jsx)("div",{className:"space-y-2",children:W.map(e=>(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("div",{className:"w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-medium",children:e.userId.name.charAt(0).toUpperCase()}),(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsxs)("p",{className:"text-sm font-medium text-gray-900",children:[e.userId.name,e.userId._id===(null==s?void 0:s.id)&&" (You)"]}),(0,t.jsxs)("p",{className:"text-xs text-gray-500",children:["Joined ",new Date(e.joinedAt).toLocaleTimeString()]})]})]},e.userId._id))})]}),(0,t.jsxs)("div",{className:"flex-1 flex flex-col",children:[(0,t.jsx)("div",{className:"p-4 border-b",children:(0,t.jsx)("h3",{className:"font-semibold text-gray-900",children:"Chat"})}),(0,t.jsx)("div",{className:"flex-1 overflow-hidden",children:(0,t.jsx)(d,{messages:z,onSendMessage:X,isConnected:G})})]})]})]})]})})}}},function(e){e.O(0,[1216,1088,2888,179],function(){return e(e.s=4333)}),_N_E=e.O()}]);