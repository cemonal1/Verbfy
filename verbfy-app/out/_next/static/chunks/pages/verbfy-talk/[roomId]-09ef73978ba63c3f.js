(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8939],{4333:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/verbfy-talk/[roomId]",function(){return r(85269)}])},85269:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return N}});var n=r(85893),o=r(67294),c=r(11163),a=r(9008),s=r.n(a),l=r(11088),i=r(67642),d=r(83454);let u={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun3.l.google.com:19302"},{urls:"stun:stun4.l.google.com:19302"}],iceCandidatePoolSize:10},m={NotAllowedError:"Microphone permission denied. Please allow microphone access in your browser settings.",NotFoundError:"No microphone found. Please connect a microphone and try again.",NotSupportedError:"Microphone not supported in this browser.",NotReadableError:"Microphone is already in use by another application.",AbortError:"Microphone access was aborted.",SecurityError:"Microphone access blocked due to security restrictions.",InvalidStateError:"Microphone is in an invalid state.",UnknownError:"Unknown microphone error occurred."},h=e=>{let[t,r]=(0,o.useState)([]),[n,c]=(0,o.useState)(null),[a,s]=(0,o.useState)([]),[l,h]=(0,o.useState)(!1),[p,g]=(0,o.useState)(!1),[x,f]=(0,o.useState)(!1),[b,v]=(0,o.useState)(!1),[w,y]=(0,o.useState)(null),[j,N]=(0,o.useState)(0),[k,C]=(0,o.useState)({}),[D,S]=(0,o.useState)("disconnected"),[E,R]=(0,o.useState)([]),T=(0,o.useRef)(null),I=(0,o.useRef)(null),A=(0,o.useRef)(new Map),M=(0,o.useRef)(null),F=(0,o.useRef)(null),_=(0,o.useRef)(null),P=(0,o.useRef)(new Map),U=(0,o.useRef)(null),V=(0,o.useRef)(!1),Z=(0,o.useCallback)(()=>{if(!I.current||U.current||!I.current.getAudioTracks()[0])return;let e=new(window.AudioContext||window.webkitAudioContext),t=e.createMediaStreamSource(I.current),r=e.createAnalyser(),o=new Uint8Array(r.frequencyBinCount);return t.connect(r),r.fftSize=256,U.current=setInterval(()=>{var e;r.getByteFrequencyData(o);let t=o.reduce((e,t)=>e+t,0)/o.length;(null===(e=T.current)||void 0===e?void 0:e.connected)&&n&&T.current.emit("participant:speaking",{roomId:n.id,isSpeaking:t>30})},100),()=>{U.current&&(clearInterval(U.current),U.current=null),t.disconnect(),r.disconnect(),e.close()}},[n]),L=(0,o.useCallback)(()=>{U.current&&(clearInterval(U.current),U.current=null)},[]),q=(0,o.useCallback)(async()=>{if(e&&!V.current)try{v(!0),S("connecting"),y(null),N(0),T.current&&(T.current.disconnect(),T.current=null);let t=(0,i.io)(d.env.NEXT_PUBLIC_BACKEND_URL||"https://api.verbfy.com",{path:"/socket.io",transports:["websocket","polling"],forceNew:!1,withCredentials:!0,auth:{token:e},timeout:2e4,reconnectionAttempts:5,reconnectionDelay:1e3,reconnectionDelayMax:5e3,upgrade:!0,rememberUpgrade:!0});t.on("connect",()=>{console.log("\uD83D\uDD0C VerbfyTalk connected:",t.id),f(!0),v(!1),S("connected"),y(null),N(0),V.current=!0}),t.on("disconnect",e=>{console.log("\uD83D\uDD0C VerbfyTalk disconnected:",e),f(!1),S("disconnected"),c(null),s([]),L(),A.current.forEach(e=>e.close()),A.current.clear(),P.current.clear()}),t.on("connect_error",e=>{console.error("\uD83D\uDD0C VerbfyTalk connection error:",e),S("error"),y("Connection failed: ".concat(e.message)),v(!1)}),t.on("reconnect_attempt",e=>{console.log("\uD83D\uDD04 VerbfyTalk reconnection attempt:",e),S("connecting"),N(e),y("Reconnecting... (Attempt ".concat(e,"/5)"))}),t.on("reconnect",e=>{console.log("✅ VerbfyTalk reconnected after",e,"attempts"),S("connected"),y(null),N(0)}),t.on("reconnect_failed",()=>{console.error("❌ VerbfyTalk reconnection failed"),S("error"),y("Failed to reconnect. Please refresh the page."),v(!1)}),t.on("rooms:list",e=>{r(e)}),t.on("room:joined",e=>{c(e),console.log("\uD83C\uDFA4 Joined room:",e.name)}),t.on("room:left",()=>{c(null),s([]),L(),console.log("\uD83C\uDFA4 Left room")}),t.on("participants:update",e=>{s(e)}),t.on("participant:joined",e=>{console.log("\uD83D\uDC64 Participant joined:",e.name),s(t=>[...t,e])}),t.on("participant:left",e=>{console.log("\uD83D\uDC64 Participant left:",e),s(t=>t.filter(t=>t.id!==e));let t=A.current.get(e);t&&(t.close(),A.current.delete(e)),P.current.delete(e),C(t=>{let r={...t};return delete r[e],r})}),t.on("participant:mute",e=>{s(t=>t.map(t=>t.id===e.participantId?{...t,isMuted:e.isMuted}:t))}),t.on("participant:speaking",e=>{s(t=>t.map(t=>t.id===e.participantId?{...t,isSpeaking:e.isSpeaking}:t))}),t.on("webrtc:offer",async e=>{try{await B(e.from,e.offer)}catch(e){console.error("❌ WebRTC offer handling failed:",e),y("Failed to establish voice connection")}}),t.on("webrtc:answer",async e=>{try{await z(e.from,e.answer)}catch(e){console.error("❌ WebRTC answer handling failed:",e),y("Failed to complete voice connection")}}),t.on("webrtc:ice-candidate",async e=>{try{await W(e.from,e.candidate)}catch(r){console.error("❌ ICE candidate handling failed:",r);let t=P.current.get(e.from)||[];t.push(e.candidate),P.current.set(e.from,t)}}),T.current=t,t.emit("rooms:get")}catch(e){console.error("❌ Failed to initialize VerbfyTalk:",e),y(e instanceof Error?e.message:"Unknown error"),v(!1)}},[e,L]),B=async(e,t)=>{try{var r;let n=new RTCPeerConnection(u);A.current.set(e,n),I.current&&I.current.getTracks().forEach(e=>{n.addTrack(e,I.current)}),n.onicecandidate=t=>{var r;t.candidate&&(null===(r=T.current)||void 0===r?void 0:r.connected)&&T.current.emit("webrtc:ice-candidate",{to:e,candidate:t.candidate})},n.onconnectionstatechange=()=>{console.log("\uD83D\uDD17 Peer connection state (".concat(e,"):"),n.connectionState),"failed"===n.connectionState&&(n.close(),A.current.delete(e))},n.oniceconnectionstatechange=()=>{console.log("\uD83E\uDDCA ICE connection state (".concat(e,"):"),n.iceConnectionState)},n.ontrack=t=>{console.log("\uD83C\uDFB5 Received remote stream from ".concat(e)),C(r=>({...r,[e]:t.streams[0]}))},await n.setRemoteDescription(t);let o=await n.createAnswer();for(let t of(await n.setLocalDescription(o),null===(r=T.current)||void 0===r||r.emit("webrtc:answer",{to:e,answer:o}),P.current.get(e)||[]))try{await n.addIceCandidate(t)}catch(e){console.warn("Failed to add buffered ICE candidate:",e)}P.current.delete(e)}catch(e){throw console.error("❌ WebRTC offer handling failed:",e),e}},z=async(e,t)=>{try{let r=A.current.get(e);r&&"closed"!==r.signalingState&&await r.setRemoteDescription(t)}catch(e){throw console.error("❌ WebRTC answer handling failed:",e),e}},W=async(e,t)=>{try{let r=A.current.get(e);if(r&&r.remoteDescription)await r.addIceCandidate(t);else{let r=P.current.get(e)||[];r.push(t),P.current.set(e,r)}}catch(e){throw console.error("❌ ICE candidate handling failed:",e),e}},Y=(0,o.useCallback)(async e=>{var t;if(!(null===(t=T.current)||void 0===t?void 0:t.connected))return y("Not connected to server"),!1;try{return T.current.emit("room:join",{roomId:e}),!0}catch(e){return console.error("❌ Failed to join room:",e),y("Failed to join room"),!1}},[]),J=(0,o.useCallback)(()=>{var e;(null===(e=T.current)||void 0===e?void 0:e.connected)&&n&&(T.current.emit("room:leave",{roomId:n.id}),L())},[n,L]),O=(0,o.useCallback)(async e=>{var t;if(!(null===(t=T.current)||void 0===t?void 0:t.connected))return y("Not connected to server"),null;try{return new Promise(t=>{var r;let n=setTimeout(()=>{t(null)},1e4);null===(r=T.current)||void 0===r||r.emit("room:create",{name:e},e=>{clearTimeout(n),e.success&&e.roomId?t(e.roomId):t(null)})})}catch(e){return console.error("❌ Failed to create room:",e),y("Failed to create room"),null}},[]),X=(0,o.useCallback)(async()=>{try{var e,t;if(console.log("\uD83C\uDFA4 Requesting microphone access..."),!(null===(e=navigator.mediaDevices)||void 0===e?void 0:e.getUserMedia))throw Error("getUserMedia is not supported in this browser");let r="unknown";try{(null===(t=navigator.permissions)||void 0===t?void 0:t.query)&&(r=(await navigator.permissions.query({name:"microphone"})).state,console.log("\uD83D\uDD0D Microphone permission status:",r))}catch(e){console.log("⚠️ Could not check permission status, proceeding with getUserMedia")}let n=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:44100},video:!1});I.current=n;let o=new(window.AudioContext||window.webkitAudioContext),c=o.createMediaStreamSource(n),a=o.createGain();return c.connect(a),a.connect(o.destination),M.current=o,_.current=c,F.current=a,a.gain.value=0,h(!0),console.log("✅ Microphone access granted"),!0}catch(e){return console.error("❌ Microphone error:",e),y(m[e.name]||m.UnknownError),!1}},[]),G=(0,o.useCallback)(()=>{var e;if(!I.current||!F.current)return;let t=!l;h(t),F.current.gain.value=t?0:1;let r=I.current.getAudioTracks()[0];r&&(r.enabled=!t),null===(e=T.current)||void 0===e||e.emit("participant:mute",{roomId:null==n?void 0:n.id,isMuted:t})},[l,n]),H=(0,o.useCallback)(()=>{var e;let t=!p;g(t),null===(e=T.current)||void 0===e||e.emit("participant:speaker",{roomId:null==n?void 0:n.id,isSpeaker:t})},[p,n]),K=(0,o.useCallback)(e=>{if(!T.current||!n)return;let t={id:Date.now().toString(),content:e,sender:"current-user",senderName:"You",timestamp:Date.now()};R(e=>[...e,t]),T.current.emit("send-room-message",{roomId:n.id,content:e,timestamp:Date.now()})},[n]),$=(0,o.useCallback)(()=>{console.log("\uD83E\uDDF9 Cleaning up VerbfyTalk..."),L(),I.current&&(I.current.getTracks().forEach(e=>{e.stop()}),I.current=null),M.current&&(M.current.close(),M.current=null),_.current&&(_.current.disconnect(),_.current=null),F.current=null,A.current.forEach(e=>{e.close()}),A.current.clear(),P.current.clear(),T.current&&(T.current.disconnect(),T.current=null),f(!1),v(!1),S("disconnected"),c(null),s([]),C({}),R([]),y(null),N(0),h(!1),g(!1),V.current=!1,console.log("✅ VerbfyTalk cleanup completed")},[L]);return(0,o.useEffect)(()=>(e&&!V.current&&q(),()=>{$()}),[e,q,$]),(0,o.useEffect)(()=>{if(I.current&&n&&x)return Z()},[n,x,Z]),{rooms:t,currentRoom:n,joinRoom:Y,leaveRoom:J,createRoom:O,isMuted:l,isSpeaker:p,isConnected:x,toggleMute:G,toggleSpeaker:H,requestMicrophone:X,localStream:I.current,remoteStreams:k,participants:a,messages:E,sendMessage:K,isConnecting:b,connectionError:w,reconnectionAttempts:j,status:D,isInitialized:V.current,disconnect:$}};var p=r(36197),g=r(72509),x=r(82861),f=r(35892),b=r(32201),v=r(61937),w=r(24585),y=r(16684);function j(e){let{roomId:t,onLeave:r}=e,{user:c}=(0,p.Eu)(),[a,s]=(0,o.useState)(null),[l,d]=(0,o.useState)(!0),[u,m]=(0,o.useState)(!1),[j,N]=(0,o.useState)(""),[k,C]=(0,o.useState)(null),[D,S]=(0,o.useState)(!0),{localStream:E,remoteStreams:R,isMuted:T,isSpeaker:I,toggleMute:A,toggleSpeaker:M,status:F,connectionError:_,isInitialized:P,participants:U,messages:V,sendMessage:Z,joinRoom:L,leaveRoom:q}=h(localStorage.getItem("token")||""),B=(0,o.useRef)(null),z=(0,o.useRef)(null);(0,o.useEffect)(()=>{if(c&&t){let e="https://api.verbfy.com".replace(/\/$/,""),t=(0,i.io)(e,{path:"/socket.io",transports:["polling"],withCredentials:!0,auth:{token:localStorage.getItem("token")||void 0}});return s(t),W(t),()=>{t.disconnect()}}},[c,t]),(0,o.useEffect)(()=>{B.current&&E&&(B.current.srcObject=E)},[E]),(0,o.useEffect)(()=>{z.current&&(z.current.scrollTop=z.current.scrollHeight)},[V]);let W=async e=>{try{S(!0),await L(t),e.on("room-updated",e=>{C(e.room)}),e.on("participant-joined",e=>{g.Am.success("".concat(e.name," joined the room"))}),e.on("participant-left",e=>{(0,g.Am)("A participant left the room")}),e.on("room-message",e=>{})}catch(e){console.error("Failed to initialize room:",e),g.Am.error("Failed to join room")}finally{S(!1)}},Y=()=>{q(),r()};return D?(0,n.jsx)("div",{className:"flex items-center justify-center h-screen",children:(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),(0,n.jsx)("p",{className:"mt-4 text-gray-600",children:"Joining room..."})]})}):_?(0,n.jsx)("div",{className:"flex items-center justify-center h-screen",children:(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsxs)("p",{className:"text-red-500 mb-4",children:["Failed to join room: ",_]}),(0,n.jsx)("button",{onClick:Y,className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg",children:"Leave Room"})]})}):(0,n.jsxs)("div",{className:"h-screen flex flex-col bg-gray-900",children:[(0,n.jsxs)("div",{className:"bg-gray-800 p-4 flex items-center justify-between",children:[(0,n.jsxs)("div",{className:"flex items-center gap-4",children:[(0,n.jsx)("button",{onClick:Y,className:"text-gray-300 hover:text-white p-2 rounded-lg hover:bg-gray-700",children:(0,n.jsx)(x.Z,{className:"w-6 h-6"})}),(0,n.jsxs)("div",{children:[(0,n.jsx)("h1",{className:"text-white font-semibold text-lg",children:(null==k?void 0:k.name)||"Room ".concat(t)}),(0,n.jsxs)("p",{className:"text-gray-400 text-sm",children:[U.length," participants"]})]})]}),(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)("button",{onClick:()=>m(!u),className:"p-2 rounded-lg ".concat(u?"bg-blue-600 text-white":"text-gray-300 hover:text-white hover:bg-gray-700"),children:(0,n.jsx)(f.Z,{className:"w-5 h-5"})}),(0,n.jsx)("button",{onClick:()=>d(!l),className:"p-2 rounded-lg ".concat(l?"bg-blue-600 text-white":"text-gray-300 hover:text-white hover:bg-gray-700"),children:(0,n.jsx)(b.Z,{className:"w-5 h-5"})})]})]}),(0,n.jsxs)("div",{className:"flex-1 flex",children:[(0,n.jsx)("div",{className:"flex-1 p-4",children:(0,n.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 h-full",children:[(0,n.jsxs)("div",{className:"relative bg-gray-800 rounded-lg overflow-hidden",children:[(0,n.jsx)("video",{ref:B,autoPlay:!0,muted:!0,playsInline:!0,className:"w-full h-full object-cover"}),(0,n.jsxs)("div",{className:"absolute bottom-2 left-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded",children:[null==c?void 0:c.name," (You)"]}),T&&(0,n.jsx)("div",{className:"absolute top-2 left-2 bg-red-500 text-white p-1 rounded",children:(0,n.jsx)(v.Z,{className:"w-4 h-4"})})]}),U.filter(e=>e.id!==(null==c?void 0:c.id)).map(e=>(0,n.jsxs)("div",{className:"relative bg-gray-800 rounded-lg overflow-hidden",children:[(0,n.jsx)("div",{className:"w-full h-full flex items-center justify-center",children:(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("div",{className:"w-16 h-16 bg-gray-600 rounded-full flex items-center justify-center mx-auto mb-2",children:(0,n.jsx)("span",{className:"text-white text-lg font-semibold",children:e.name.charAt(0).toUpperCase()})}),(0,n.jsx)("p",{className:"text-white text-sm",children:e.name}),e.isSpeaking&&(0,n.jsx)("div",{className:"mt-1",children:(0,n.jsx)("div",{className:"w-2 h-2 bg-green-500 rounded-full mx-auto animate-pulse"})})]})}),e.isMuted&&(0,n.jsx)("div",{className:"absolute top-2 left-2 bg-red-500 text-white p-1 rounded",children:(0,n.jsx)(v.Z,{className:"w-4 h-4"})})]},e.id))]})}),(0,n.jsxs)("div",{className:"w-80 bg-gray-800 border-l border-gray-700",children:[u&&(0,n.jsxs)("div",{className:"p-4 border-b border-gray-700",children:[(0,n.jsx)("h3",{className:"text-white font-semibold mb-3",children:"Participants"}),(0,n.jsx)("div",{className:"space-y-2",children:U.map(e=>(0,n.jsxs)("div",{className:"flex items-center gap-3 p-2 rounded bg-gray-700",children:[(0,n.jsx)("div",{className:"w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center",children:(0,n.jsx)("span",{className:"text-white text-sm font-semibold",children:e.name.charAt(0).toUpperCase()})}),(0,n.jsxs)("div",{className:"flex-1",children:[(0,n.jsxs)("p",{className:"text-white text-sm",children:[e.name,e.id===(null==c?void 0:c.id)&&" (You)"]}),(0,n.jsx)("p",{className:"text-gray-400 text-xs",children:e.isSpeaker?"Speaker":"Listener"})]}),(0,n.jsx)("div",{className:"flex gap-1",children:(0,n.jsx)(v.Z,{className:"w-4 h-4 ".concat(e.isMuted?"text-red-500":"text-green-500")})})]},e.id))})]}),l&&(0,n.jsxs)("div",{className:"flex-1 flex flex-col h-full",children:[(0,n.jsx)("div",{className:"p-4 border-b border-gray-700",children:(0,n.jsx)("h3",{className:"text-white font-semibold",children:"Chat"})}),(0,n.jsx)("div",{className:"flex-1 overflow-y-auto p-4",ref:z,children:(0,n.jsx)("div",{className:"space-y-3",children:V.map((e,t)=>(0,n.jsxs)("div",{className:"bg-gray-700 rounded-lg p-3",children:[(0,n.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,n.jsx)("span",{className:"text-blue-400 text-sm font-semibold",children:e.sender===(null==c?void 0:c.id)?"You":e.senderName}),(0,n.jsx)("span",{className:"text-gray-400 text-xs",children:new Date(e.timestamp).toLocaleTimeString()})]}),(0,n.jsx)("p",{className:"text-white text-sm",children:e.content})]},t))})}),(0,n.jsx)("div",{className:"p-4 border-t border-gray-700",children:(0,n.jsxs)("form",{onSubmit:e=>{e.preventDefault(),j.trim()&&(Z(j),N(""))},className:"flex gap-2",children:[(0,n.jsx)("input",{type:"text",value:j,onChange:e=>N(e.target.value),placeholder:"Type a message...",className:"flex-1 bg-gray-700 text-white px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),(0,n.jsx)("button",{type:"submit",className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg",children:"Send"})]})})]})]})]}),(0,n.jsxs)("div",{className:"bg-gray-800 p-4 flex items-center justify-center gap-4",children:[(0,n.jsx)("button",{onClick:A,className:"p-3 rounded-full ".concat(T?"bg-red-500 text-white":"bg-gray-600 text-white"," hover:opacity-80 transition-colors"),children:(0,n.jsx)(v.Z,{className:"w-6 h-6"})}),(0,n.jsx)("button",{onClick:M,className:"p-3 rounded-full ".concat(I?"bg-blue-600 text-white":"bg-gray-600 text-white"," hover:opacity-80 transition-colors"),children:I?(0,n.jsx)(w.Z,{className:"w-6 h-6"}):(0,n.jsx)(y.Z,{className:"w-6 h-6"})}),(0,n.jsx)("button",{onClick:Y,className:"bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium transition-colors",children:"Leave Room"})]})]})}function N(){let e=(0,c.useRouter)(),{roomId:t}=e.query;return t?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(s(),{children:[(0,n.jsxs)("title",{children:["VerbfyTalk Room - ",t]}),(0,n.jsx)("meta",{name:"description",content:"Join the conversation in VerbfyTalk"})]}),(0,n.jsx)(l.Z,{title:"VerbfyTalk Room: ".concat(t),children:(0,n.jsx)(j,{roomId:t,onLeave:()=>{e.push("/verbfy-talk")}})})]}):(0,n.jsx)(l.Z,{title:"VerbfyTalk",children:(0,n.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("h1",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Room Not Found"}),(0,n.jsx)("p",{className:"text-gray-600 mb-6",children:"The room you're looking for doesn't exist."}),(0,n.jsx)("button",{onClick:()=>e.push("/verbfy-talk"),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors",children:"Back to Rooms"})]})})})}}},function(e){e.O(0,[1216,1088,2888,179],function(){return e(e.s=4333)}),_N_E=e.O()}]);
//# sourceMappingURL=[roomId]-09ef73978ba63c3f.js.map