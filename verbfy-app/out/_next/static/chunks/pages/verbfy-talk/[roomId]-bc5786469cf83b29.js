(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8939],{4333:function(e,s,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/verbfy-talk/[roomId]",function(){return t(79622)}])},79622:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return z}});var a=t(85893),l=t(67294),r=t(11163),i=t(10571),n=t(32798),c=t(36197),d=t(68655),o=t(23050),m=t(85111),u=t(23603),x=t(89176),h=t(17734),g=t(5704);let p=e=>{let{lessonId:s,enabled:t=!0}=e,{user:a}=(0,c.aC)(),[r,i]=(0,l.useState)(null),[n,d]=(0,l.useState)(!1),[o,m]=(0,l.useState)([]),[u,x]=(0,l.useState)([]),[p,f]=(0,l.useState)(!1),[b,v]=(0,l.useState)(null),j=(0,l.useRef)(null);(0,l.useEffect)(()=>{let e=g.tokenStorage.getToken();if(!t||!a||!e||!s)return;let l=(0,h.io)("https://api.verbfy.com",{path:"/verbfy-talk/socket.io",auth:{token:e},transports:["websocket","polling"],reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3});return l.on("connect",()=>{d(!0),v(null)}),l.on("disconnect",()=>{d(!1),f(!1)}),l.on("connect_error",e=>{v("Failed to connect to lesson chat"),d(!1)}),l.on("lesson:joined",e=>{let{lessonId:t}=e;t===s&&f(!0)}),l.on("lesson:left",e=>{let{lessonId:t}=e;t===s&&f(!1)}),l.on("lesson:message",e=>{e.lessonId===s&&m(s=>[...s,e])}),l.on("lesson:file-shared",e=>{if(e.lessonId===s){let s={id:e.id,lessonId:e.lessonId,userId:e.uploadedBy,userName:e.uploaderName,userRole:e.uploaderRole,message:"Shared file: ".concat(e.fileName),messageType:"file",timestamp:e.timestamp,fileId:e.fileId};m(e=>[...e,s])}}),l.on("lesson:participant-joined",e=>{x(s=>s.some(s=>s.userId===e.userId)?s:[...s,e]);let t={id:"system-".concat(Date.now()),lessonId:s,userId:"system",userName:"System",userRole:"system",message:"".concat(e.userName," joined the lesson"),messageType:"system",timestamp:e.timestamp};m(e=>[...e,t])}),l.on("lesson:participant-left",e=>{x(s=>s.filter(s=>s.userId!==e.userId));let t={id:"system-".concat(Date.now()),lessonId:s,userId:"system",userName:"System",userRole:"system",message:"".concat(e.userName," left the lesson"),messageType:"system",timestamp:e.timestamp};m(e=>[...e,t])}),l.on("error",e=>{v(e.message)}),i(l),()=>{l&&l.disconnect()}},[t,a,s]),(0,l.useEffect)(()=>{j.current&&j.current.scrollIntoView({behavior:"smooth"})},[o]),(0,l.useEffect)(()=>{r&&n&&!p&&s&&r.emit("lesson:join",{lessonId:s})},[r,n,p,s]);let y=(0,l.useCallback)(e=>!!(r&&n&&p&&e.trim())&&(r.emit("lesson:send-message",{lessonId:s,message:e.trim(),messageType:"text"}),!0),[r,n,p,s]),N=(0,l.useCallback)((e,t,a)=>!!r&&!!n&&!!p&&(r.emit("lesson:file-shared",{lessonId:s,fileId:e,fileName:t,fileSize:a}),!0),[r,n,p,s]),w=(0,l.useCallback)(()=>{r&&p&&r.emit("lesson:leave",{lessonId:s})},[r,p,s]),k=(0,l.useCallback)(async()=>{let e=g.tokenStorage.getToken();if(e)try{let t=await fetch("/api/lesson-chat/".concat(s,"/messages"),{headers:{Authorization:"Bearer ".concat(e)}});if(t.ok){let e=await t.json();m(e)}}catch(e){}},[s]);return(0,l.useEffect)(()=>{p&&k()},[p,k]),{isConnected:n,isJoined:p,messages:o,participants:u,error:b,messagesEndRef:j,sendMessage:y,shareFile:N,leaveLesson:w,loadChatHistory:k,clearError:()=>v(null)}};var f=t(2553),b=t(43283),v=t(62190);let j=e=>{let{lessonId:s,onFileShared:t,onClose:r}=e,[i,n]=(0,l.useState)(null),[c,m]=(0,l.useState)(!1),[u,x]=(0,l.useState)(null),[h,g]=(0,l.useState)(!1),p=(0,l.useRef)(null),j=["image/jpeg","image/png","image/gif","image/webp","video/mp4","video/avi","video/mov","audio/mp3","audio/wav","audio/ogg","application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation","text/plain"],y=e=>j.includes(e.type)?e.size>52428800?"File size must be less than 50MB.":null:"File type not supported. Please upload images, videos, audio, PDF, or document files.",N=e=>{let s=y(e);if(s){x(s);return}n(e),x(null)},w=async()=>{if(i){m(!0),x(null);try{let e=new FormData;e.append("file",i),e.append("description","Shared in lesson ".concat(s));let a=await fetch("/api/lesson-chat/".concat(s,"/files/upload"),{method:"POST",headers:{Authorization:"Bearer ".concat(localStorage.getItem("token"))},body:e});if(!a.ok){let e=await a.json();throw Error(e.message||"Upload failed")}let l=await a.json();t(l.fileId,l.fileName,l.fileSize)}catch(e){x(e instanceof Error?e.message:"Upload failed")}finally{m(!1)}}};return(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,a.jsxs)("div",{className:"bg-white rounded-lg p-6 w-full max-w-md mx-4",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-gray-900",children:"Share File"}),(0,a.jsx)("button",{onClick:r,className:"text-gray-400 hover:text-gray-600",disabled:c,children:(0,a.jsx)(v.Z,{className:"w-5 h-5"})})]}),(0,a.jsx)("div",{className:"border-2 border-dashed rounded-lg p-6 text-center transition-colors ".concat(h?"border-blue-400 bg-blue-50":"border-gray-300 hover:border-gray-400"),onDrop:e=>{e.preventDefault(),g(!1);let s=Array.from(e.dataTransfer.files);s.length>0&&N(s[0])},onDragOver:e=>{e.preventDefault(),g(!0)},onDragLeave:e=>{e.preventDefault(),g(!1)},children:i?(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsx)("div",{className:"flex items-center justify-center",children:(0,a.jsx)(f.Z,{className:"w-8 h-8 text-blue-500"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"font-medium text-gray-900",children:i.name}),(0,a.jsx)("p",{className:"text-sm text-gray-500",children:(e=>{if(0===e)return"0 Bytes";let s=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,s)).toFixed(2))+" "+["Bytes","KB","MB","GB"][s]})(i.size)})]}),(0,a.jsx)("button",{onClick:()=>n(null),className:"text-sm text-red-600 hover:text-red-800",disabled:c,children:"Remove file"})]}):(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsx)("div",{className:"flex items-center justify-center",children:(0,a.jsx)(b.Z,{className:"w-8 h-8 text-gray-400"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-gray-600",children:"Drop a file here or"}),(0,a.jsx)("button",{onClick:()=>{var e;return null===(e=p.current)||void 0===e?void 0:e.click()},className:"text-blue-600 hover:text-blue-800 font-medium",disabled:c,children:"browse files"})]}),(0,a.jsx)("p",{className:"text-xs text-gray-500",children:"Max 50MB • Images, Videos, Audio, PDF, Documents"})]})}),(0,a.jsx)("input",{ref:p,type:"file",onChange:e=>{let s=e.target.files;s&&s.length>0&&N(s[0])},accept:j.join(","),className:"hidden",disabled:c}),u&&(0,a.jsx)("div",{className:"mt-4 p-3 bg-red-50 border border-red-200 rounded-lg",children:(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)(d.Z,{className:"w-4 h-4 text-red-500"}),(0,a.jsx)("span",{className:"text-sm text-red-700",children:u})]})}),(0,a.jsxs)("div",{className:"flex items-center justify-end space-x-3 mt-6",children:[(0,a.jsx)("button",{onClick:r,className:"px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50",disabled:c,children:"Cancel"}),(0,a.jsx)("button",{onClick:w,disabled:!i||c,className:"px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center space-x-2",children:c?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),(0,a.jsx)("span",{children:"Uploading..."})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(o.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{children:"Share File"})]})})]})]})})};var y=t(12779),N=t(83691),w=t(68760),k=t(2287),C=t(63594);let I=e=>{let{message:s,lessonId:t}=e,{user:l}=(0,c.aC)(),r=(null==l?void 0:l.id)===s.userId,i="system"===s.messageType,n=async()=>{if(s.fileId)try{let e=await fetch("/api/lesson-chat/".concat(t,"/files/").concat(s.fileId,"/download"),{headers:{Authorization:"Bearer ".concat(localStorage.getItem("token"))}});if(e.ok){let t=await e.blob(),a=window.URL.createObjectURL(t),l=document.createElement("a");l.href=a,l.download=s.message.replace("Shared file: ",""),document.body.appendChild(l),l.click(),window.URL.revokeObjectURL(a),document.body.removeChild(l)}}catch(e){}};return i?(0,a.jsx)("div",{className:"flex justify-center",children:(0,a.jsx)("div",{className:"bg-gray-100 text-gray-600 text-xs px-3 py-1 rounded-full",children:s.message})}):(0,a.jsx)("div",{className:"flex ".concat(r?"justify-end":"justify-start"),children:(0,a.jsxs)("div",{className:"max-w-xs lg:max-w-md ".concat(r?"order-2":"order-1"),children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2 mb-1 ".concat(r?"justify-end":"justify-start"),children:[(0,a.jsx)("span",{className:"text-sm font-medium ".concat((e=>{switch(e){case"teacher":return"text-blue-600";case"student":return"text-green-600";case"admin":return"text-purple-600";default:return"text-gray-600"}})(s.userRole)),children:s.userName}),(0,a.jsx)("span",{className:"text-xs px-2 py-0.5 rounded-full ".concat((e=>{switch(e){case"teacher":return"bg-blue-100 text-blue-800";case"student":return"bg-green-100 text-green-800";case"admin":return"bg-purple-100 text-purple-800";default:return"bg-gray-100 text-gray-800"}})(s.userRole)),children:s.userRole}),(0,a.jsx)("span",{className:"text-xs text-gray-500",children:new Date(s.timestamp).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"})})]}),(0,a.jsx)("div",{className:"px-3 py-2 rounded-lg ".concat(r?"bg-blue-500 text-white":"bg-gray-100 text-gray-900"),children:"file"===s.messageType?(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-1",children:[(e=>{var s;switch(null===(s=e.split(".").pop())||void 0===s?void 0:s.toLowerCase()){case"jpg":case"jpeg":case"png":case"gif":case"webp":return(0,a.jsx)(w.Z,{className:"w-4 h-4"});case"mp4":case"avi":case"mov":case"wmv":return(0,a.jsx)(C.Z,{className:"w-4 h-4"});case"mp3":case"wav":case"ogg":return(0,a.jsx)(k.Z,{className:"w-4 h-4"});case"pdf":case"doc":case"docx":case"txt":return(0,a.jsx)(f.Z,{className:"w-4 h-4"});default:return(0,a.jsx)(N.Z,{className:"w-4 h-4"})}})(s.message),(0,a.jsx)("span",{className:"text-sm",children:s.message.replace("Shared file: ","")})]}),(0,a.jsx)("button",{onClick:n,className:"p-1 rounded hover:bg-opacity-80 ".concat(r?"hover:bg-blue-600":"hover:bg-gray-200"),title:"Download file",children:(0,a.jsx)(y.Z,{className:"w-3 h-3"})})]}):(0,a.jsx)("p",{className:"text-sm whitespace-pre-wrap break-words",children:s.message})})]})})};var S=t(95494),Z=t(82591),R=t(8267);let E=e=>{let{participants:s,onClose:t}=e,l=e=>{switch(e){case"teacher":return(0,a.jsx)(Z.Z,{className:"w-4 h-4 text-blue-500"});case"admin":return(0,a.jsx)(S.Z,{className:"w-4 h-4 text-purple-500"});default:return(0,a.jsx)(R.Z,{className:"w-4 h-4 text-gray-500"})}},r=e=>{switch(e){case"teacher":return"text-blue-600 bg-blue-50";case"admin":return"text-purple-600 bg-purple-50";case"student":return"text-green-600 bg-green-50";default:return"text-gray-600 bg-gray-50"}},i=e=>new Date(e).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"});return(0,a.jsx)("div",{className:"border-b border-gray-200 bg-gray-50",children:(0,a.jsxs)("div",{className:"p-3",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,a.jsxs)("h4",{className:"font-medium text-gray-900",children:["Participants (",s.length,")"]}),(0,a.jsx)("button",{onClick:t,className:"text-gray-400 hover:text-gray-600",children:(0,a.jsx)(v.Z,{className:"w-4 h-4"})})]}),(0,a.jsx)("div",{className:"space-y-2 max-h-32 overflow-y-auto",children:0===s.length?(0,a.jsxs)("div",{className:"text-center text-gray-500 py-4",children:[(0,a.jsx)(R.Z,{className:"w-8 h-8 mx-auto mb-2 text-gray-300"}),(0,a.jsx)("p",{className:"text-sm",children:"No participants yet"})]}):s.map(e=>(0,a.jsxs)("div",{className:"flex items-center justify-between p-2 bg-white rounded-lg border border-gray-200",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[l(e.userRole),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"font-medium text-sm text-gray-900",children:e.userName}),(0,a.jsx)("div",{className:"text-xs px-2 py-0.5 rounded-full inline-block ".concat(r(e.userRole)),children:e.userRole})]})]}),(0,a.jsx)("div",{className:"text-xs text-gray-500",children:i(e.timestamp)})]},e.userId))})]})})};var P=e=>{let{lessonId:s,className:t="",height:r="400px"}=e,[i,n]=(0,l.useState)(""),[c,h]=(0,l.useState)(!1),[g,f]=(0,l.useState)(!1),b=(0,l.useRef)(null),{isConnected:v,isJoined:y,messages:N,participants:w,error:k,messagesEndRef:C,sendMessage:S,shareFile:Z,clearError:R}=p({lessonId:s}),P=()=>{if(i.trim()&&S(i)){var e;n(""),null===(e=b.current)||void 0===e||e.focus()}},_=v?y?{text:"Connected",color:"text-green-500",icon:o.Z}:{text:"Connecting...",color:"text-yellow-500",icon:d.Z}:{text:"Disconnected",color:"text-red-500",icon:d.Z},T=_.icon;return(0,a.jsxs)("div",{className:"flex flex-col bg-white border border-gray-200 rounded-lg shadow-sm ".concat(t),children:[(0,a.jsxs)("div",{className:"flex items-center justify-between p-3 border-b border-gray-200 bg-gray-50 rounded-t-lg",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)("h3",{className:"font-medium text-gray-900",children:"Lesson Chat"}),(0,a.jsxs)("div",{className:"flex items-center space-x-1",children:[(0,a.jsx)(T,{className:"w-4 h-4 ".concat(_.color)}),(0,a.jsx)("span",{className:"text-xs ".concat(_.color),children:_.text})]})]}),(0,a.jsx)("div",{className:"flex items-center space-x-2",children:(0,a.jsxs)("button",{onClick:()=>f(!g),className:"p-1 text-gray-500 hover:text-gray-700 hover:bg-gray-200 rounded",title:"Show participants",children:[(0,a.jsx)(x.Z,{className:"w-4 h-4"}),w.length>0&&(0,a.jsx)("span",{className:"ml-1 text-xs",children:w.length})]})})]}),k&&(0,a.jsx)("div",{className:"p-3 bg-red-50 border-b border-red-200",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)(d.Z,{className:"w-4 h-4 text-red-500"}),(0,a.jsx)("span",{className:"text-sm text-red-700",children:k})]}),(0,a.jsx)("button",{onClick:R,className:"text-red-500 hover:text-red-700",children:"\xd7"})]})}),g&&(0,a.jsx)(E,{participants:w,onClose:()=>f(!1)}),(0,a.jsxs)("div",{className:"flex-1 overflow-y-auto p-3 space-y-3",style:{height:r,maxHeight:r},children:[0===N.length?(0,a.jsxs)("div",{className:"text-center text-gray-500 py-8",children:[(0,a.jsx)("div",{className:"text-sm",children:"No messages yet"}),(0,a.jsx)("div",{className:"text-xs mt-1",children:"Start the conversation!"})]}):N.map(e=>(0,a.jsx)(I,{message:e,lessonId:s},e.id)),(0,a.jsx)("div",{ref:C})]}),c&&(0,a.jsx)(j,{lessonId:s,onFileShared:(e,s,t)=>{Z(e,s,t),h(!1)},onClose:()=>h(!1)}),(0,a.jsx)("div",{className:"p-3 border-t border-gray-200 bg-gray-50 rounded-b-lg",children:y?(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)("button",{onClick:()=>h(!0),className:"p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-200 rounded-lg transition-colors",title:"Share file",children:(0,a.jsx)(m.Z,{className:"w-4 h-4"})}),(0,a.jsx)("div",{className:"flex-1 relative",children:(0,a.jsx)("input",{ref:b,type:"text",value:i,onChange:e=>n(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),P())},placeholder:"Type a message...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",disabled:!y})}),(0,a.jsx)("button",{onClick:P,disabled:!i.trim()||!y,className:"p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors",title:"Send message",children:(0,a.jsx)(u.Z,{className:"w-4 h-4"})})]}):(0,a.jsx)("div",{className:"text-center text-gray-500 py-2",children:(0,a.jsx)("div",{className:"text-sm",children:v?"Joining lesson...":"Connecting to lesson chat..."})})})]})},_=t(72509),T=t(64964),D=t(82861),A=t(40068),M=t(61937),F=t(18689),L=t(35892),B=t(22877),U=t(91594),z=function(){var e,s;let t=(0,r.useRouter)(),{user:d}=(0,c.Eu)(),{roomId:o}=t.query,[m,u]=(0,l.useState)(null),[x,h]=(0,l.useState)(!0),[g,p]=(0,l.useState)(!1),[f,b]=(0,l.useState)(50),[v,j]=(0,l.useState)(!1),[y,N]=(0,l.useState)(!1),[w,k]=(0,l.useState)("grid"),[C,I]=(0,l.useState)(null),{localStream:S,remoteStreams:Z,isMicOn:R,isCameraOn:E,toggleMic:z,toggleCamera:O,reconnect:Y,status:q,error:G,muteStates:V,videoStates:K,toggleRemoteMute:H,toggleRemoteVideo:J,isInitializing:X}=(d&&o&&"".concat(d.id,"-verbfy-talk-").concat(o),function(e,s,t){let[a,r]=(0,l.useState)(null),[i,n]=(0,l.useState)({}),[c,d]=(0,l.useState)(!0),[o,m]=(0,l.useState)(!0),[u,x]=(0,l.useState)("disconnected"),[h,g]=(0,l.useState)(null),[p,f]=(0,l.useState)({}),[b,v]=(0,l.useState)({}),[j,y]=(0,l.useState)(!1),N=(0,l.useRef)(null);(0,l.useEffect)(()=>(w(),()=>{N.current&&N.current.getTracks().forEach(e=>{e.stop()})}),[]);let w=async()=>{try{if(y(!0),g(null),x("connecting"),!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw Error("Your browser does not support media access. Please use a modern browser like Chrome, Firefox, Safari, or Edge.");try{let e=await Promise.all([navigator.permissions.query({name:"microphone"}),navigator.permissions.query({name:"camera"})]);if("denied"===e[0].state||"denied"===e[1].state)throw Error("Media permissions are denied. Please allow microphone and camera access in your browser settings.")}catch(e){}let e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:44100},video:{width:{ideal:1280,max:1920},height:{ideal:720,max:1080},frameRate:{ideal:30,max:60},facingMode:"user"}});N.current=e,r(e),x("connected");let s=e.getAudioTracks()[0],t=e.getVideoTracks()[0];s&&(s.enabled=c,s.addEventListener("ended",()=>{g("Microphone access was lost. Please refresh the page.")})),t&&(t.enabled=o,t.addEventListener("ended",()=>{g("Camera access was lost. Please refresh the page.")}))}catch(s){let e="Failed to access microphone and camera";if("NotAllowedError"===s.name)e='Microphone and camera access denied. Please click the camera/microphone icon in your browser\'s address bar and select "Allow", then refresh the page.';else if("NotFoundError"===s.name)e="No microphone or camera found. Please check that your devices are connected and working properly.";else if("NotReadableError"===s.name)e="Microphone or camera is already in use by another application. Please close other applications using your camera/microphone and try again.";else if("OverconstrainedError"===s.name){e="Camera constraints cannot be satisfied. Trying with basic settings...";try{let e=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0});N.current=e,r(e),x("connected");return}catch(s){e="Failed to access media devices even with basic settings. Please check your browser permissions and device connections."}}else"SecurityError"===s.name?e="Media access blocked due to security restrictions. Please ensure you're using HTTPS and try again.":s.message&&(e=s.message);g(e),x("error")}finally{y(!1)}},k=(0,l.useCallback)(()=>{if(N.current){let e=N.current.getAudioTracks()[0];if(e){let s=!c;e.enabled=s,d(s)}}},[c]),C=(0,l.useCallback)(()=>{if(N.current){let e=N.current.getVideoTracks()[0];if(e){let s=!o;e.enabled=s,m(s)}}},[o]),I=(0,l.useCallback)(async()=>{x("reconnecting"),N.current&&N.current.getTracks().forEach(e=>e.stop()),await w()},[e]),S=(0,l.useCallback)(e=>{f(s=>({...s,[e]:!s[e]}))},[]),Z=(0,l.useCallback)(e=>{v(s=>({...s,[e]:!s[e]}))},[]),R=()=>!!navigator.mediaDevices&&!!navigator.mediaDevices.getUserMedia||(g("Your browser does not support media devices. Please use a modern browser like Chrome, Firefox, or Safari."),!1);return(0,l.useEffect)(()=>{R()||x("error")},[]),{localStream:a,remoteStreams:i,isMicOn:c,isCameraOn:o,toggleMic:k,toggleCamera:C,reconnect:I,status:u,error:h,muteStates:p,videoStates:b,toggleRemoteMute:S,toggleRemoteVideo:Z,isInitializing:j}}(o,0,0)),Q=(0,l.useRef)(null),W=(0,l.useRef)({});(0,l.useEffect)(()=>{o&&"string"==typeof o&&$()},[o]),(0,l.useEffect)(()=>{S&&Q.current&&(Q.current.srcObject=S)},[S]),(0,l.useEffect)(()=>{Object.entries(Z).forEach(e=>{let[s,t]=e,a=W.current[s];a&&t&&(a.srcObject=t)})},[Z]);let $=async()=>{try{h(!0);let e=await n.bl.getRoomDetails(o);u(e.data)}catch(e){_.Am.error("Failed to load room details"),t.push("/verbfy-talk")}finally{h(!1)}},ee=async()=>{try{await n.bl.leaveRoom(o),_.Am.success("Left room successfully"),t.push("/verbfy-talk")}catch(l){var e,s,a;(null===(e=l.response)||void 0===e?void 0:e.status)===400&&(null===(a=l.response)||void 0===a?void 0:null===(s=a.data)||void 0===s?void 0:s.message)==="Not in room"?(_.Am.success("Left room successfully"),t.push("/verbfy-talk")):_.Am.error("Failed to leave room")}};if(x||X)return(0,a.jsx)(i.Z,{allowedRoles:["student","teacher"],children:(0,a.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),(0,a.jsx)("p",{className:"mt-4 text-gray-600",children:x?"Loading room...":"Requesting microphone and camera access..."}),X&&(0,a.jsx)("p",{className:"mt-2 text-sm text-gray-500",children:"Please allow access to your microphone and camera when prompted"})]})})});if(!m)return(0,a.jsx)(i.Z,{allowedRoles:["student","teacher"],children:(0,a.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("p",{className:"text-gray-600",children:"Room not found"}),(0,a.jsx)("button",{onClick:()=>t.push("/verbfy-talk"),className:"mt-4 bg-blue-600 text-white px-4 py-2 rounded",children:"Back to Rooms"})]})})});if(G&&"error"===q)return(0,a.jsx)(i.Z,{allowedRoles:["student","teacher"],children:(0,a.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,a.jsxs)("div",{className:"text-center max-w-md",children:[(0,a.jsx)("div",{className:"text-red-500 mb-4",children:(0,a.jsx)(M.Z,{className:"w-16 h-16 mx-auto mb-4"})}),(0,a.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Media Access Required"}),(0,a.jsx)("p",{className:"text-gray-600 mb-6",children:G}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsx)("button",{onClick:Y,className:"w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition-colors",children:"Try Again"}),(0,a.jsx)("button",{onClick:()=>t.push("/verbfy-talk"),className:"w-full bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded transition-colors",children:"Back to Rooms"})]}),(0,a.jsxs)("div",{className:"mt-6 text-sm text-gray-500",children:[(0,a.jsx)("p",{className:"font-medium mb-2",children:"To fix this issue:"}),(0,a.jsxs)("ul",{className:"text-left space-y-1",children:[(0,a.jsx)("li",{children:"• Click the camera/microphone icon in your browser's address bar"}),(0,a.jsx)("li",{children:'• Select "Allow" for both camera and microphone'}),(0,a.jsx)("li",{children:"• Refresh the page and try again"})]})]})]})})});let es=[];return"object"==typeof m.createdBy?m.createdBy._id:m.createdBy,null==d||d.id,(0,a.jsx)(i.Z,{allowedRoles:["student","teacher"],children:(0,a.jsxs)("div",{className:"h-screen flex flex-col bg-gray-900",children:[(0,a.jsx)("div",{className:"bg-white border-b px-6 py-4",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center gap-4",children:[(0,a.jsx)("button",{onClick:()=>t.push("/verbfy-talk"),className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:(0,a.jsx)(D.Z,{className:"w-5 h-5"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{className:"text-xl font-semibold text-gray-900",children:m.name}),(0,a.jsxs)("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[(0,a.jsxs)("span",{className:"flex items-center gap-1 ".concat((e=>{switch(e){case"Beginner":return"text-green-600";case"Intermediate":return"text-yellow-600";case"Advanced":return"text-red-600";default:return"text-blue-600"}})(m.level)),children:[(0,a.jsx)(T.Z,{className:"w-4 h-4"}),m.level]}),(0,a.jsx)("span",{children:"•"}),(0,a.jsxs)("span",{className:"flex items-center gap-1",children:[(0,a.jsx)(L.Z,{className:"w-4 h-4"}),es.length,"/",m.maxParticipants]}),m.topic&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("span",{children:"•"}),(0,a.jsx)("span",{children:m.topic})]})]})]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1 bg-gray-100 rounded-lg p-1",children:[(0,a.jsx)("button",{onClick:()=>k("grid"),className:"px-3 py-1 rounded text-sm transition-colors ".concat("grid"===w?"bg-white text-gray-900 shadow-sm":"text-gray-600 hover:text-gray-900"),children:"Grid"}),(0,a.jsx)("button",{onClick:()=>k("speaker"),className:"px-3 py-1 rounded text-sm transition-colors ".concat("speaker"===w?"bg-white text-gray-900 shadow-sm":"text-gray-600 hover:text-gray-900"),children:"Speaker"}),(0,a.jsx)("button",{onClick:()=>k("gallery"),className:"px-3 py-1 rounded text-sm transition-colors ".concat("gallery"===w?"bg-white text-gray-900 shadow-sm":"text-gray-600 hover:text-gray-900"),children:"Gallery"})]}),(0,a.jsx)("button",{onClick:()=>p(!g),className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:(0,a.jsx)(L.Z,{className:"w-5 h-5"})}),(0,a.jsx)("button",{onClick:ee,className:"bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors",children:"Leave Room"})]})]})}),(0,a.jsxs)("div",{className:"flex-1 flex",children:[(0,a.jsxs)("div",{className:"flex-1 flex flex-col",children:[G&&(0,a.jsx)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 m-4",children:(0,a.jsxs)("div",{className:"flex items-start gap-3",children:[(0,a.jsx)("div",{className:"flex-shrink-0",children:(0,a.jsx)("svg",{className:"w-5 h-5 text-red-500",fill:"currentColor",viewBox:"0 0 20 20",children:(0,a.jsx)("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z",clipRule:"evenodd"})})}),(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsx)("h3",{className:"text-sm font-medium text-red-800",children:"Media Access Error"}),(0,a.jsx)("p",{className:"text-sm text-red-700 mt-1",children:G}),(0,a.jsxs)("div",{className:"mt-3 flex gap-2",children:[(0,a.jsx)("button",{onClick:Y,className:"bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition-colors",disabled:X,children:X?"Retrying...":"Try Again"}),(0,a.jsx)("button",{onClick:()=>t.push("/verbfy-talk/test-media"),className:"bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm transition-colors",children:"Test Media"})]})]})]})}),X&&(0,a.jsx)("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 m-4",children:(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("div",{className:"flex-shrink-0",children:(0,a.jsx)("div",{className:"w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-sm font-medium text-blue-800",children:"Initializing Media"}),(0,a.jsx)("p",{className:"text-sm text-blue-700",children:"Requesting access to your camera and microphone..."})]})]})}),(0,a.jsx)("div",{className:"flex-1 p-4",children:(0,a.jsx)("div",{className:"h-full flex flex-col",children:(0,a.jsxs)("div",{className:"flex-1 flex items-center justify-center",children:["grid"===w&&(0,a.jsxs)("div",{className:"\n                      w-full h-full grid gap-2\n                      ".concat(es.length<=1?"grid-cols-1":"","\n                      ").concat(2===es.length?"grid-cols-1 md:grid-cols-2":"","\n                      ").concat(3===es.length?"grid-cols-1 md:grid-cols-2 lg:grid-cols-3":"","\n                      ").concat(4===es.length?"grid-cols-2":"","\n                      ").concat(es.length>=5?"grid-cols-2 md:grid-cols-3":"","\n                    "),children:[(0,a.jsxs)("div",{className:"relative bg-gray-800 rounded-lg overflow-hidden aspect-video min-h-0",children:[(0,a.jsx)("video",{ref:Q,autoPlay:!0,muted:!0,playsInline:!0,className:"w-full h-full object-cover"}),(0,a.jsxs)("div",{className:"absolute inset-0 pointer-events-none",children:[(0,a.jsxs)("div",{className:"absolute top-2 left-2 flex gap-1",children:[!R&&(0,a.jsxs)("div",{className:"bg-red-500 text-white p-1 rounded-full relative",children:[(0,a.jsx)(M.Z,{className:"w-3 h-3"}),(0,a.jsx)(U.Z,{className:"w-2 h-2 absolute -top-0.5 -right-0.5 bg-red-600 rounded-full"})]}),!E&&(0,a.jsxs)("div",{className:"bg-red-500 text-white p-1 rounded-full relative",children:[(0,a.jsx)(B.Z,{className:"w-3 h-3"}),(0,a.jsx)(U.Z,{className:"w-2 h-2 absolute -top-0.5 -right-0.5 bg-red-600 rounded-full"})]})]}),"connecting"===q&&(0,a.jsx)("div",{className:"absolute top-2 right-2 bg-yellow-500 text-white px-2 py-1 rounded text-xs",children:"Connecting..."}),"connected"===q&&(0,a.jsx)("div",{className:"absolute top-2 right-2 bg-green-500 text-white px-2 py-1 rounded text-xs",children:"Connected"}),(0,a.jsx)("div",{className:"absolute bottom-2 left-2 bg-black bg-opacity-70 text-white px-2 py-1 rounded text-sm font-medium",children:"You"})]}),!E&&(0,a.jsx)("div",{className:"absolute inset-0 bg-gray-700 flex items-center justify-center",children:(0,a.jsxs)("div",{className:"text-center text-white",children:[(0,a.jsx)("div",{className:"w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-2",children:(0,a.jsx)("span",{className:"text-2xl font-bold",children:(null==d?void 0:null===(e=d.name)||void 0===e?void 0:e.charAt(0).toUpperCase())||"U"})}),(0,a.jsx)("p",{className:"text-sm",children:"Camera is off"})]})})]}),es.filter(e=>e.userId._id!==(null==d?void 0:d.id)).map((e,s)=>(0,a.jsxs)("div",{className:"relative bg-gray-800 rounded-lg overflow-hidden aspect-video min-h-0",children:[(0,a.jsx)("video",{ref:s=>{W.current[e.userId._id]=s},autoPlay:!0,playsInline:!0,className:"w-full h-full object-cover"}),(0,a.jsxs)("div",{className:"absolute inset-0 pointer-events-none",children:[(0,a.jsxs)("div",{className:"absolute top-2 left-2 flex gap-1",children:[V[e.userId._id]&&(0,a.jsxs)("div",{className:"bg-red-500 text-white p-1 rounded-full relative",children:[(0,a.jsx)(M.Z,{className:"w-3 h-3"}),(0,a.jsx)(U.Z,{className:"w-2 h-2 absolute -top-0.5 -right-0.5 bg-red-600 rounded-full"})]}),!K[e.userId._id]&&(0,a.jsxs)("div",{className:"bg-red-500 text-white p-1 rounded-full relative",children:[(0,a.jsx)(B.Z,{className:"w-3 h-3"}),(0,a.jsx)(U.Z,{className:"w-2 h-2 absolute -top-0.5 -right-0.5 bg-red-600 rounded-full"})]})]}),(0,a.jsx)("div",{className:"absolute bottom-2 left-2 bg-black bg-opacity-70 text-white px-2 py-1 rounded text-sm font-medium",children:e.userId.name})]}),!K[e.userId._id]&&(0,a.jsx)("div",{className:"absolute inset-0 bg-gray-700 flex items-center justify-center",children:(0,a.jsxs)("div",{className:"text-center text-white",children:[(0,a.jsx)("div",{className:"w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-2",children:(0,a.jsx)("span",{className:"text-2xl font-bold",children:e.userId.name.charAt(0).toUpperCase()})}),(0,a.jsx)("p",{className:"text-sm",children:"Camera is off"})]})})]},e.userId._id))]}),"speaker"===w&&(0,a.jsxs)("div",{className:"w-full h-full flex flex-col gap-2",children:[(0,a.jsx)("div",{className:"flex-1 flex items-center justify-center",children:C?(0,a.jsxs)("div",{className:"relative bg-gray-800 rounded-lg overflow-hidden aspect-video max-h-full max-w-full",children:[(0,a.jsx)("video",{ref:e=>{W.current[C]=e},autoPlay:!0,playsInline:!0,className:"w-full h-full object-cover"}),(0,a.jsx)("div",{className:"absolute inset-0 pointer-events-none",children:(0,a.jsx)("div",{className:"absolute bottom-2 left-2 bg-black bg-opacity-70 text-white px-2 py-1 rounded text-sm font-medium",children:null===(s=es.find(e=>e.userId._id===C))||void 0===s?void 0:s.userId.name})})]}):(0,a.jsxs)("div",{className:"relative bg-gray-800 rounded-lg overflow-hidden aspect-video max-h-full max-w-full",children:[(0,a.jsx)("video",{ref:Q,autoPlay:!0,muted:!0,playsInline:!0,className:"w-full h-full object-cover"}),(0,a.jsx)("div",{className:"absolute bottom-2 left-2 bg-black bg-opacity-70 text-white px-2 py-1 rounded text-sm font-medium",children:"You"})]})}),(0,a.jsxs)("div",{className:"flex gap-2 justify-center max-h-32",children:[C&&(0,a.jsxs)("div",{className:"relative bg-gray-800 rounded-lg overflow-hidden aspect-video w-24 h-18 cursor-pointer hover:ring-2 hover:ring-blue-500",onClick:()=>I(null),children:[(0,a.jsx)("video",{ref:Q,autoPlay:!0,muted:!0,playsInline:!0,className:"w-full h-full object-cover"}),(0,a.jsx)("div",{className:"absolute bottom-1 left-1 bg-black bg-opacity-70 text-white px-1 py-0.5 rounded text-xs",children:"You"})]}),es.filter(e=>e.userId._id!==(null==d?void 0:d.id)&&e.userId._id!==C).map(e=>(0,a.jsxs)("div",{className:"relative bg-gray-800 rounded-lg overflow-hidden aspect-video w-24 h-18 cursor-pointer hover:ring-2 hover:ring-blue-500",onClick:()=>I(e.userId._id),children:[(0,a.jsx)("video",{ref:s=>{W.current[e.userId._id]=s},autoPlay:!0,playsInline:!0,className:"w-full h-full object-cover"}),(0,a.jsx)("div",{className:"absolute bottom-1 left-1 bg-black bg-opacity-70 text-white px-1 py-0.5 rounded text-xs",children:e.userId.name})]},e.userId._id))]})]}),"gallery"===w&&(0,a.jsxs)("div",{className:"w-full h-full grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2 content-start",children:[(0,a.jsxs)("div",{className:"relative bg-gray-800 rounded-lg overflow-hidden aspect-video",children:[(0,a.jsx)("video",{ref:Q,autoPlay:!0,muted:!0,playsInline:!0,className:"w-full h-full object-cover"}),(0,a.jsx)("div",{className:"absolute bottom-1 left-1 bg-black bg-opacity-70 text-white px-1 py-0.5 rounded text-xs",children:"You"})]}),es.filter(e=>e.userId._id!==(null==d?void 0:d.id)).map(e=>(0,a.jsxs)("div",{className:"relative bg-gray-800 rounded-lg overflow-hidden aspect-video",children:[(0,a.jsx)("video",{ref:s=>{W.current[e.userId._id]=s},autoPlay:!0,playsInline:!0,className:"w-full h-full object-cover"}),(0,a.jsx)("div",{className:"absolute bottom-1 left-1 bg-black bg-opacity-70 text-white px-1 py-0.5 rounded text-xs",children:e.userId.name})]},e.userId._id))]})]})})}),(0,a.jsx)("div",{className:"bg-white border-t px-6 py-4",children:(0,a.jsxs)("div",{className:"flex items-center justify-center gap-4",children:[(0,a.jsxs)("button",{onClick:z,className:"p-3 rounded-full relative transition-colors ".concat(R?"bg-gray-200 hover:bg-gray-300":"bg-red-500 hover:bg-red-600 text-white"),children:[(0,a.jsx)(M.Z,{className:"w-6 h-6"}),!R&&(0,a.jsx)(U.Z,{className:"w-4 h-4 absolute -top-1 -right-1 bg-red-600 rounded-full text-white p-0.5"})]}),(0,a.jsxs)("button",{onClick:O,className:"p-3 rounded-full relative transition-colors ".concat(E?"bg-gray-200 hover:bg-gray-300":"bg-red-500 hover:bg-red-600 text-white"),children:[(0,a.jsx)(B.Z,{className:"w-6 h-6"}),!E&&(0,a.jsx)(U.Z,{className:"w-4 h-4 absolute -top-1 -right-1 bg-red-600 rounded-full text-white p-0.5"})]}),(0,a.jsxs)("button",{onClick:()=>N(!y),className:"p-3 rounded-full relative transition-colors ".concat(y?"bg-blue-500 hover:bg-blue-600 text-white":"bg-gray-200 hover:bg-gray-300"),children:[(0,a.jsx)(A.Z,{className:"w-6 h-6"}),!y&&(0,a.jsx)(U.Z,{className:"w-4 h-4 absolute -top-1 -right-1 bg-gray-600 rounded-full text-white p-0.5"})]}),(0,a.jsx)("button",{onClick:ee,className:"p-3 bg-red-500 hover:bg-red-600 text-white rounded-full transition-colors",children:(0,a.jsx)(F.Z,{className:"w-6 h-6 transform rotate-[135deg]"})})]})})]}),(0,a.jsxs)("div",{className:"w-80 bg-white border-l flex flex-col",children:[g&&(0,a.jsxs)("div",{className:"border-b p-4",children:[(0,a.jsx)("h3",{className:"font-semibold text-gray-900 mb-3",children:"Participants"}),(0,a.jsx)("div",{className:"space-y-2",children:es.map(e=>(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("div",{className:"w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-medium",children:e.userId.name.charAt(0).toUpperCase()}),(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsxs)("p",{className:"text-sm font-medium text-gray-900",children:[e.userId.name,e.userId._id===(null==d?void 0:d.id)&&" (You)"]}),(0,a.jsxs)("p",{className:"text-xs text-gray-500",children:["Joined ",new Date(e.joinedAt).toLocaleTimeString()]})]})]},e.userId._id))})]}),(0,a.jsx)("div",{className:"flex-1 flex flex-col",children:(0,a.jsx)(P,{lessonId:o})})]})]})]})})}}},function(e){e.O(0,[5522,2138,9226,9496,8484,437,5823,2244,6235,5323,747,3365,8638,9806,7093,8510,8424,8639,7855,7446,2169,8308,1408,6259,4657,8212,571,1493,2888,5514,179],function(){return e(e.s=4333)}),_N_E=e.O()}]);