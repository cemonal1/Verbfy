(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8939],{4333:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/verbfy-talk/[roomId]",function(){return n(3594)}])},3594:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return x}});var r=n(85893),o=n(67294),s=n(11163),c=n(9008),a=n.n(c),i=n(11088),l=n(36197),d=n(67642),u=n(83454),m=n(5704);function h(e){let{roomId:t,onLeave:n}=e,{user:s}=(0,l.Eu)(),[c,a]=(0,o.useState)(!1),{isConnected:i,isConnecting:h,currentRoom:x,users:g,localStream:p,isMicOn:f,error:b,connectionStatus:j,connect:w,disconnect:v,joinRoom:y,leaveRoom:N,toggleMic:D,requestMicrophone:C,clearError:k}=function(){let[e,t]=(0,o.useState)({isConnected:!1,isConnecting:!1,currentRoom:null,users:[],localStream:null,isMicOn:!0,error:null,connectionStatus:"disconnected"}),n=(0,o.useRef)(null),r=(0,o.useRef)(new Map),s=(0,o.useRef)(new Map),c=(0,o.useRef)(null),a=(0,o.useRef)(0),i={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun3.l.google.com:19302"}]},l=(0,o.useCallback)(()=>{if(window.AudioContext){let e=new(window.AudioContext||window.webkitAudioContext),t=()=>{"suspended"===e.state&&e.resume()};document.addEventListener("click",t,{once:!0}),document.addEventListener("touchstart",t,{once:!0})}},[]),m=(0,o.useCallback)(async()=>{try{if(console.log("\uD83C\uDFA4 Requesting microphone access..."),!window.isSecureContext)throw Error("Microphone access requires HTTPS");if(navigator.permissions)try{let e=await navigator.permissions.query({name:"microphone"});if(console.log("\uD83D\uDD0D Microphone permission status:",e.state),"denied"===e.state)throw Error("Microphone permission permanently denied")}catch(e){console.log("⚠️ Could not check permission status, proceeding with getUserMedia")}let e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:44100,channelCount:1}});return console.log("✅ Microphone access granted"),c.current=e,t(t=>({...t,localStream:e,isMicOn:!0,error:null})),!0}catch(n){console.error("❌ Microphone error:",n);let e="Microphone access denied";return"NotAllowedError"===n.name?e="Microphone permission denied. Please allow microphone access and try again.":"NotFoundError"===n.name?e="No microphone found. Please connect a microphone and try again.":"NotSupportedError"===n.name?e="Microphone access not supported in this browser.":"NotReadableError"===n.name?e="Microphone is already in use by another application.":n.message.includes("secure context")?e="Microphone access requires HTTPS. Please use https://verbfy.com instead of http.":n.message.includes("permanently denied")?e="Microphone access permanently blocked. Please enable it in browser settings.":n.message.includes("permissions policy")&&(e="Permissions policy violation. Please try refreshing the page or check browser settings."),t(t=>({...t,error:e,localStream:null,isMicOn:!1})),!1}},[]),h=(0,o.useCallback)((e,t)=>{let o=new RTCPeerConnection(i);return c.current&&c.current.getTracks().forEach(e=>{o.addTrack(e,c.current)}),o.ontrack=t=>{console.log("\uD83C\uDFB5 Received audio stream from ".concat(e));let n=t.streams[0],r=document.createElement("audio");r.srcObject=n,r.autoplay=!0,r.volume=.8,r.muted=!1,r.setAttribute("playsinline","true"),r.setAttribute("webkit-playsinline","true"),r.setAttribute("controls","false"),r.setAttribute("preload","none"),s.current.set(e,r),document.body.appendChild(r)},o.onicecandidate=t=>{t.candidate&&n.current&&n.current.emit("signal",{to:e,data:{type:"ice-candidate",candidate:t.candidate}})},o.onconnectionstatechange=()=>{console.log("\uD83D\uDD17 Peer connection state with ".concat(e,":"),o.connectionState)},r.current.set(e,o),o},[]),x=(0,o.useCallback)(async e=>{let{from:t,data:o}=e;if(!c.current)return;let s=r.current.get(t);s||(s=h(t,!1));try{if("offer"===o.type){var a;await s.setRemoteDescription(new RTCSessionDescription(o));let e=await s.createAnswer();await s.setLocalDescription(e),null===(a=n.current)||void 0===a||a.emit("signal",{to:t,data:{type:"answer",answer:e}})}else"answer"===o.type?await s.setRemoteDescription(new RTCSessionDescription(o.answer)):"ice-candidate"===o.type&&await s.addIceCandidate(new RTCIceCandidate(o.candidate))}catch(e){console.error("❌ Error handling signal:",e)}},[h]),g=(0,o.useCallback)(async e=>{var o;if(null===(o=n.current)||void 0===o?void 0:o.connected){console.log("\uD83D\uDD0C Already connected");return}t(e=>({...e,isConnecting:!0,connectionStatus:"connecting"}));try{let o=(0,d.ZP)(u.env.NEXT_PUBLIC_BACKEND_URL||"https://api.verbfy.com",{path:"/socket.io",transports:["websocket","polling"],timeout:2e4,forceNew:!0,auth:{token:e}});o.on("connect",()=>{console.log("✅ Socket connected successfully"),t(e=>({...e,isConnected:!0,isConnecting:!1,connectionStatus:"connected",error:null})),a.current=0}),o.on("connect_error",e=>{console.error("❌ Socket connection error:",e),t(e=>({...e,isConnecting:!1,connectionStatus:"error",error:"Failed to connect to server. Please try again."}))}),o.on("disconnect",e=>{console.log("\uD83D\uDD0C Socket disconnected:",e),t(e=>({...e,isConnected:!1,connectionStatus:"disconnected"})),a.current<3&&(a.current++,console.log("\uD83D\uDD04 Attempting reconnection ".concat(a.current,"/").concat(3)),setTimeout(()=>{o.connect()},2e3*a.current))}),o.on("authenticated",e=>{console.log("✅ User authenticated:",e)}),o.on("authentication_error",e=>{console.error("❌ Authentication error:",e),t(e=>({...e,error:"Authentication failed. Please try again.",isConnecting:!1,connectionStatus:"error"}))}),o.on("roomJoined",e=>{console.log("\uD83C\uDFE0 Joined room:",e),t(t=>({...t,currentRoom:e.roomId,users:e.users}))}),o.on("userJoined",e=>{if(console.log("\uD83D\uDC64 User joined:",e),t(t=>({...t,users:[...t.users,{id:e.userId,name:e.userName,socketId:e.socketId}]})),c.current){let t=h(e.socketId,!0);t.createOffer().then(n=>{t.setLocalDescription(n),o.emit("signal",{to:e.socketId,data:{type:"offer",offer:n}})}).catch(e=>{console.error("❌ Error creating offer:",e)})}}),o.on("userLeft",e=>{console.log("\uD83D\uDC4B User left:",e),t(t=>({...t,users:t.users.filter(t=>t.socketId!==e.socketId)}));let n=r.current.get(e.socketId);n&&(n.close(),r.current.delete(e.socketId));let o=s.current.get(e.socketId);o&&o.parentNode&&(o.parentNode.removeChild(o),s.current.delete(e.socketId))}),o.on("signal",x),o.on("roomFull",e=>{console.log("❌ Room is full:",e),t(t=>({...t,error:e.message}))}),o.on("error",e=>{console.error("❌ Server error:",e),t(t=>({...t,error:e.message}))}),n.current=o,o.emit("authenticate",{token:e})}catch(e){console.error("❌ Connection failed:",e),t(e=>({...e,isConnecting:!1,connectionStatus:"error",error:"Failed to connect to server"}))}},[x,h]),p=(0,o.useCallback)(()=>{n.current&&(n.current.disconnect(),n.current=null),r.current.forEach(e=>e.close()),r.current.clear(),s.current.forEach(e=>{e.parentNode&&e.parentNode.removeChild(e)}),s.current.clear(),c.current&&(c.current.getTracks().forEach(e=>e.stop()),c.current=null),t(e=>({...e,isConnected:!1,isConnecting:!1,currentRoom:null,users:[],localStream:null,isMicOn:!1,connectionStatus:"disconnected"}))},[]),f=(0,o.useCallback)(async e=>{var r;if(!(null===(r=n.current)||void 0===r?void 0:r.connected)){t(e=>({...e,error:"Not connected to server"}));return}try{if(!await m()){t(e=>({...e,error:"Microphone access required to join room"}));return}n.current.emit("joinRoom",{roomId:e})}catch(e){console.error("❌ Failed to join room:",e),t(e=>({...e,error:"Failed to join room"}))}},[m]),b=(0,o.useCallback)(()=>{n.current&&e.currentRoom&&n.current.emit("leaveRoom"),r.current.forEach(e=>e.close()),r.current.clear(),s.current.forEach(e=>{e.parentNode&&e.parentNode.removeChild(e)}),s.current.clear(),t(e=>({...e,currentRoom:null,users:[]}))},[e.currentRoom]),j=(0,o.useCallback)(()=>{if(c.current){let e=c.current.getAudioTracks()[0];e&&(e.enabled=!e.enabled,t(t=>({...t,isMicOn:e.enabled})))}},[]),w=(0,o.useCallback)(()=>{t(e=>({...e,error:null}))},[]);return(0,o.useEffect)(()=>{l()},[l]),(0,o.useEffect)(()=>()=>{p()},[p]),{...e,connect:g,disconnect:p,joinRoom:f,leaveRoom:b,toggleMic:j,requestMicrophone:m,clearError:w}}();(0,o.useEffect)(()=>{(async()=>{let e=m.tokenStorage.getToken();if(e&&s&&!i&&!h)try{await w(e)}catch(e){console.error("❌ Failed to connect to server:",e)}})()},[s,i,h,w]),(0,o.useEffect)(()=>{(async()=>{if(i&&!x&&!c){a(!0);try{await y(t)}catch(e){console.error("❌ Failed to join room:",e)}finally{a(!1)}}})()},[i,x,t,c,y]);let R=()=>{N(),v(),null==n||n()},E=async()=>{await C()&&i&&await y(t)};return(0,r.jsxs)("div",{className:"max-w-4xl mx-auto p-6",children:[(0,r.jsx)("div",{className:"bg-white rounded-lg shadow-sm border p-6 mb-6",children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h1",{className:"text-2xl font-bold text-gray-900 flex items-center gap-3",children:"\uD83C\uDFA4 Voice Chat Room"}),(0,r.jsxs)("p",{className:"text-gray-600 mt-1",children:["Room ID: ",t]}),(0,r.jsx)("p",{className:"text-sm text-gray-500 mt-2",children:"Maximum 5 participants • Audio only • P2P connection"})]}),(0,r.jsx)("div",{className:"flex items-center gap-3",children:(0,r.jsx)("button",{onClick:R,className:"bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium transition-colors",children:"Leave Room"})})]})}),b&&(0,r.jsxs)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 mb-6",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-red-600",children:"❌"}),(0,r.jsx)("p",{className:"text-red-800",children:b})]}),(0,r.jsx)("button",{onClick:k,className:"mt-2 text-sm text-red-600 hover:text-red-800 underline",children:"Dismiss"})]}),(0,r.jsxs)("div",{className:"bg-white rounded-lg shadow-sm border p-6 mb-6",children:[(0,r.jsx)("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Connection Status"}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)("span",{className:"text-lg",children:(()=>{switch(j){case"connected":return"\uD83D\uDFE2";case"connecting":return"\uD83D\uDFE1";case"error":return"\uD83D\uDD34";default:return"⚪"}})()}),(0,r.jsxs)("span",{className:"text-sm font-medium ".concat((()=>{switch(j){case"connected":return"text-green-600";case"connecting":return"text-yellow-600";case"error":return"text-red-600";default:return"text-gray-600"}})()),children:["Server: ",j.charAt(0).toUpperCase()+j.slice(1)]})]}),(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)("div",{className:"w-3 h-3 rounded-full ".concat(p?"bg-green-500":"bg-gray-400")}),(0,r.jsxs)("span",{className:"text-sm text-gray-700",children:["Microphone: ",p?"Active":"Inactive"]})]}),(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)("div",{className:"w-3 h-3 rounded-full ".concat(x?"bg-green-500":"bg-gray-400")}),(0,r.jsxs)("span",{className:"text-sm text-gray-700",children:["Room: ",x?"Joined":"Not Joined"]})]})]})]}),(0,r.jsxs)("div",{className:"flex-1 flex flex-col items-center justify-center p-8",children:[(h||c)&&(0,r.jsx)("div",{className:"text-center mb-8",children:(0,r.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-8 max-w-md mx-auto",children:[(0,r.jsx)("div",{className:"w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4",children:(0,r.jsx)("div",{className:"animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"})}),(0,r.jsx)("h3",{className:"text-xl font-semibold text-gray-900 mb-4",children:h?"Connecting to Server...":"Joining Room..."}),(0,r.jsx)("p",{className:"text-gray-600",children:h?"Establishing connection...":"Requesting microphone access..."})]})}),i&&!p&&!c&&(0,r.jsx)("div",{className:"text-center mb-8",children:(0,r.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-8 max-w-md mx-auto",children:[(0,r.jsx)("div",{className:"w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4",children:(0,r.jsx)("span",{className:"text-3xl",children:"\uD83C\uDFA4"})}),(0,r.jsx)("h3",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Microphone Access Required"}),(0,r.jsx)("p",{className:"text-gray-600 mb-6",children:"To join the voice chat, you need to allow microphone access. Click the button below to request permission."}),(0,r.jsx)("button",{onClick:E,className:"bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-medium transition-colors",children:"\uD83C\uDFA7 Allow Microphone"})]})}),p&&x&&(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-4xl w-full",children:[(0,r.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-6 text-center",children:[(0,r.jsx)("div",{className:"w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4",children:(0,r.jsx)("svg",{className:"w-10 h-10 text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})})}),(0,r.jsxs)("h3",{className:"font-semibold text-gray-900 mb-2",children:[(null==s?void 0:s.name)||"You"," ",f?"\uD83C\uDFA4":"\uD83D\uDD07"]}),(0,r.jsx)("p",{className:"text-sm text-gray-600",children:"Local"}),!f&&(0,r.jsx)("div",{className:"mt-2 text-xs text-red-500 bg-red-50 px-2 py-1 rounded",children:"Microphone Off"})]}),g.map(e=>(0,r.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-6 text-center",children:[(0,r.jsx)("div",{className:"w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4",children:(0,r.jsx)("svg",{className:"w-10 h-10 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})})}),(0,r.jsxs)("h3",{className:"font-semibold text-gray-900 mb-2",children:[e.name," \uD83C\uDFA4"]}),(0,r.jsx)("p",{className:"text-sm text-gray-600",children:"Remote"})]},e.socketId))]}),(0,r.jsx)("div",{className:"mt-8 text-center",children:(0,r.jsxs)("div",{className:"bg-white rounded-lg shadow-sm border p-6 max-w-2xl mx-auto",children:[(0,r.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Room Information"}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"font-medium",children:"Room ID:"})," ",t]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"font-medium",children:"Participants:"})," ",g.length+(p?1:0),"/5"]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"font-medium",children:"Connection:"})," P2P WebRTC"]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"font-medium",children:"Audio Quality:"})," High"]})]})]})})]}),p&&x&&(0,r.jsxs)("div",{className:"bg-white rounded-lg shadow-sm border p-6 mt-6",children:[(0,r.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Audio Controls"}),(0,r.jsxs)("div",{className:"flex items-center justify-center gap-4",children:[(0,r.jsx)("button",{onClick:D,className:"flex items-center gap-2 px-6 py-3 rounded-lg font-medium transition-colors ".concat(f?"bg-green-100 text-green-700 hover:bg-green-200":"bg-red-100 text-red-700 hover:bg-red-200"),children:f?"\uD83C\uDFA4 Mute":"\uD83D\uDD07 Unmute"}),(0,r.jsx)("button",{onClick:R,className:"flex items-center gap-2 px-6 py-3 rounded-lg font-medium transition-colors bg-red-100 text-red-700 hover:bg-red-200",children:"\uD83D\uDEAA Leave Room"})]})]})]})}function x(){let e=(0,s.useRouter)(),{roomId:t}=e.query;return t?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(a(),{children:[(0,r.jsxs)("title",{children:["VerbfyTalk Room - ",t]}),(0,r.jsx)("meta",{name:"description",content:"Join the conversation in VerbfyTalk"})]}),(0,r.jsx)(i.Z,{title:"VerbfyTalk Room: ".concat(t),children:(0,r.jsx)(h,{roomId:t,onLeave:()=>{e.push("/verbfy-talk")}})})]}):(0,r.jsx)(i.Z,{title:"VerbfyTalk",children:(0,r.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("h1",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Room Not Found"}),(0,r.jsx)("p",{className:"text-gray-600 mb-6",children:"The room you're looking for doesn't exist."}),(0,r.jsx)("button",{onClick:()=>e.push("/verbfy-talk"),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors",children:"Back to Rooms"})]})})})}}},function(e){e.O(0,[1216,1088,2888,179],function(){return e(e.s=4333)}),_N_E=e.O()}]);
//# sourceMappingURL=[roomId]-8212dbc76012d8c9.js.map