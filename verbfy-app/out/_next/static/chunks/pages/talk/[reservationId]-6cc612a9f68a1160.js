(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3910],{40578:function(e,t,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/talk/[reservationId]",function(){return s(71622)}])},71622:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return m}});var a=s(85893),r=s(67294),n=s(11163),l=s(9008),c=s.n(l),i=s(36197),d=s(32798),o=s(56158);let x=(e,t)=>{o.Am.success(e,t)},h=(e,t)=>{o.Am.error(e,t)};var u=s(37213);s(13618);var m=()=>{let{user:e}=(0,i.Eu)(),t=(0,n.useRouter)(),{reservationId:s}=t.query,[l,o]=(0,r.useState)(null),[m,g]=(0,r.useState)(""),[b,f]=(0,r.useState)(""),[j,y]=(0,r.useState)(!0),[p,v]=(0,r.useState)(null),[N,w]=(0,r.useState)(!1),[k,D]=(0,r.useState)(!1),[T,S]=(0,r.useState)(!1),[_,C]=(0,r.useState)([]),[E,L]=(0,r.useState)(0),[F,I]=(0,r.useState)(0),P=(0,r.useRef)(null);(0,r.useEffect)(()=>{s&&e&&G()},[s,e]),(0,r.useEffect)(()=>{l&&e&&M()},[l,e]),(0,r.useEffect)(()=>(k&&!T&&E>0?P.current=setInterval(()=>{L(e=>e<=1?(R(),0):e-1)},1e3):P.current&&clearInterval(P.current),()=>{P.current&&clearInterval(P.current)}),[k,T,E]);let G=async()=>{try{y(!0);let e=await d.ZP.get("/api/reservations/".concat(s));if(e.data.success){let t=e.data.reservation;o(t);let s=new Date("".concat(t.actualDate,"T").concat(t.startTime)),a=new Date("".concat(t.actualDate,"T").concat(t.endTime)),r=Math.floor((a.getTime()-s.getTime())/1e3);I(r);let n=new Date,l=Math.floor((a.getTime()-n.getTime())/1e3);L(Math.max(0,l)),n>=s&&n<=a&&D(!0)}}catch(e){v("Failed to load lesson details"),h("Failed to load lesson details")}finally{y(!1)}},M=async()=>{try{if(!l)return;let t="lesson-".concat(l._id),s=await d.ZP.post("/api/livekit/token/".concat(t),{metadata:{participantName:(null==e?void 0:e.name)||"User",participantId:null==e?void 0:e._id,role:null==e?void 0:e.role}});s.data.token&&(g(s.data.token),f(t))}catch(e){v("Failed to generate video call token"),h("Failed to initialize video call")}},R=async()=>{S(!0),D(!1);try{await d.ZP.patch("/api/reservations/".concat(s),{status:"completed"}),x("Lesson completed successfully!"),setTimeout(()=>{t.push((null==e?void 0:e.role)==="teacher"?"/teacher/dashboard":"/student/dashboard")},3e3)}catch(e){}};if(j)return(0,a.jsx)("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto"}),(0,a.jsx)("p",{className:"mt-4 text-gray-600 dark:text-gray-400",children:"Loading lesson..."})]})});if(p||!l)return(0,a.jsx)("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4",children:(0,a.jsx)("i",{className:"fas fa-exclamation-triangle text-red-600 text-2xl"})}),(0,a.jsx)("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-2",children:p||"Lesson Not Found"}),(0,a.jsx)("p",{className:"text-gray-600 dark:text-gray-400 mb-6",children:"The lesson you're looking for doesn't exist or you don't have access to it."}),(0,a.jsx)("button",{onClick:()=>t.push("/dashboard"),className:"bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors",children:"Go to Dashboard"})]})});if(!(l&&e&&(l.teacher._id===e._id||l.student._id===e._id)))return(0,a.jsx)("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4",children:(0,a.jsx)("i",{className:"fas fa-lock text-red-600 text-2xl"})}),(0,a.jsx)("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-2",children:"Access Denied"}),(0,a.jsx)("p",{className:"text-gray-600 dark:text-gray-400 mb-6",children:"You don't have permission to access this lesson."}),(0,a.jsx)("button",{onClick:()=>t.push("/dashboard"),className:"bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors",children:"Go to Dashboard"})]})});if(!(()=>{if(!l||!e)return!1;let t=new Date,s=new Date("".concat(l.actualDate,"T").concat(l.startTime)),a=new Date("".concat(l.actualDate,"T").concat(l.endTime));return t>=new Date(s.getTime()-3e5)&&t<=a})()){let e=new Date("".concat(l.actualDate,"T").concat(l.startTime)),s=new Date<e;return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(c(),{children:(0,a.jsx)("title",{children:"Lesson Room - Verbfy"})}),(0,a.jsx)("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center",children:(0,a.jsxs)("div",{className:"max-w-md w-full bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 text-center",children:[(0,a.jsx)("div",{className:"w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4",children:(0,a.jsx)("i",{className:"fas fa-clock text-blue-600 text-2xl"})}),(0,a.jsx)("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-4",children:s?"Lesson Not Started Yet":"Lesson Has Ended"}),(0,a.jsxs)("div",{className:"space-y-3 text-sm text-gray-600 dark:text-gray-400 mb-6",children:[(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"Teacher:"})," ",l.teacher.name]}),(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"Student:"})," ",l.student.name]}),(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"Date:"})," ",new Date(l.actualDate).toLocaleDateString()]}),(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"Time:"})," ",l.startTime," - ",l.endTime]})]}),s&&(0,a.jsx)("p",{className:"text-gray-600 dark:text-gray-400 mb-6",children:"You can join the lesson 5 minutes before it starts."}),(0,a.jsx)("button",{onClick:()=>t.push("/dashboard"),className:"bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors",children:"Go to Dashboard"})]})})]})}return T?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(c(),{children:(0,a.jsx)("title",{children:"Lesson Completed - Verbfy"})}),(0,a.jsx)("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center",children:(0,a.jsxs)("div",{className:"max-w-md w-full bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 text-center",children:[(0,a.jsx)("div",{className:"w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4",children:(0,a.jsx)("i",{className:"fas fa-check text-green-600 text-2xl"})}),(0,a.jsx)("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-4",children:"Lesson Completed!"}),(0,a.jsx)("p",{className:"text-gray-600 dark:text-gray-400 mb-6",children:"Thank you for using Verbfy. Your lesson has been completed successfully."}),(0,a.jsx)("button",{onClick:()=>t.push((null==e?void 0:e.role)==="teacher"?"/teacher/dashboard":"/student/dashboard"),className:"bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors",children:"Go to Dashboard"})]})})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(c(),{children:[(0,a.jsx)("title",{children:"Lesson Room - Verbfy"}),(0,a.jsx)("meta",{name:"description",content:"Join your English lesson"})]}),(0,a.jsxs)("div",{className:"min-h-screen bg-gray-900",children:[(0,a.jsx)("div",{className:"bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-4",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,a.jsx)("h1",{className:"text-xl font-semibold text-gray-900 dark:text-white",children:"English Lesson"}),(0,a.jsx)("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:(null==e?void 0:e.role)==="teacher"?"with ".concat(l.student.name):"with ".concat(l.teacher.name)})]}),(0,a.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,a.jsx)("div",{className:"bg-gray-100 dark:bg-gray-700 px-3 py-1 rounded-lg",children:(0,a.jsx)("span",{className:"text-sm font-medium text-gray-900 dark:text-white",children:"".concat(Math.floor(E/60).toString().padStart(2,"0"),":").concat((E%60).toString().padStart(2,"0"))})}),((null==e?void 0:e.role)==="teacher"||E<=0)&&(0,a.jsx)("button",{onClick:R,className:"bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-700 transition-colors",children:"End Lesson"})]})]})}),m&&b?(0,a.jsx)("div",{className:"h-[calc(100vh-80px)]",children:(0,a.jsxs)(u.IC,{video:!0,audio:!0,token:m,serverUrl:"wss://verbfy-53tvgg0m.livekit.cloud","data-lk-theme":"default",style:{height:"100%"},onConnected:()=>{w(!0),x("Connected to lesson room")},onDisconnected:()=>{w(!1)},children:[(0,a.jsx)(u.zc,{}),(0,a.jsx)(u.Z5,{})]})}):(0,a.jsx)("div",{className:"h-[calc(100vh-80px)] flex items-center justify-center",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto mb-4"}),(0,a.jsx)("p",{className:"text-white",children:"Connecting to lesson room..."})]})})]})]})}}},function(e){e.O(0,[2138,9226,9496,8484,437,5823,2244,6235,5323,747,3365,8638,9806,7093,8510,8424,8639,7855,7446,2169,8308,1408,6259,4657,8212,1493,2888,5514,179],function(){return e(e.s=40578)}),_N_E=e.O()}]);