(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8585],{25564:function(e,t,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/lesson/[reservationId]",function(){return s(32017)}])},32017:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return o}});var a=s(85893),n=s(67294),r=s(11163),i=s(36197),l=s(37213);s(13618);var d=s(32798);function c(e){let{reservationId:t,onLessonEnd:s,onError:r}=e,{user:c}=(0,i.aC)(),[o,u]=(0,n.useState)(null),[m,x]=(0,n.useState)(""),[h,v]=(0,n.useState)(""),[g,f]=(0,n.useState)(!0),[b,y]=(0,n.useState)(""),[j,p]=(0,n.useState)(!1),[N,w]=(0,n.useState)(!1),k=(0,n.useRef)(null);(0,n.useEffect)(()=>{E()},[t]);let E=async()=>{try{f(!0),y("");let e=await d.ZP.post("/api/reservations/".concat(t,"/start"));if(!e.data.success)throw Error(e.data.message||"Failed to start lesson");let s=e.data.data;u(s),w(!0);let a=await d.ZP.post("/api/livekit/token/".concat(s.roomName),{metadata:JSON.stringify({reservationId:t,role:null==c?void 0:c.role,lessonType:s.lessonType,lessonLevel:s.lessonLevel})});if(!a.data.token||!a.data.url)throw Error("Failed to get video conference credentials");x(a.data.token),v(a.data.url)}catch(a){var e,s;let t=(null===(s=a.response)||void 0===s?void 0:null===(e=s.data)||void 0===e?void 0:e.message)||a.message||"Failed to initialize lesson";y(t),null==r||r(t)}finally{f(!1)}},S=async()=>{try{k.current&&k.current.disconnect(),await d.ZP.post("/api/reservations/".concat(t,"/end"),{feedback:"Lesson completed via video conference",rating:(null==c?void 0:c.role)==="student"?5:void 0}),null==s||s()}catch(t){var e,a;null==r||r((null===(a=t.response)||void 0===a?void 0:null===(e=a.data)||void 0===e?void 0:e.message)||"Failed to end lesson properly")}};return g?(0,a.jsx)("div",{className:"flex items-center justify-center min-h-screen bg-gray-100",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),(0,a.jsx)("div",{className:"text-lg font-medium text-gray-900",children:"Starting your lesson..."}),(0,a.jsx)("div",{className:"text-sm text-gray-600 mt-2",children:"Please wait while we prepare your video conference"})]})}):b?(0,a.jsx)("div",{className:"flex items-center justify-center min-h-screen bg-gray-100",children:(0,a.jsxs)("div",{className:"text-center max-w-md mx-auto p-6",children:[(0,a.jsx)("div",{className:"text-red-600 text-6xl mb-4",children:"⚠️"}),(0,a.jsx)("div",{className:"text-lg font-medium text-gray-900 mb-2",children:"Unable to Start Lesson"}),(0,a.jsx)("div",{className:"text-sm text-gray-600 mb-4",children:b}),(0,a.jsx)("button",{onClick:()=>window.location.reload(),className:"bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700",children:"Try Again"})]})}):m&&h&&o?(0,a.jsxs)("div",{className:"h-screen bg-black",children:[(0,a.jsxs)("div",{className:"bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"font-medium text-gray-900",children:[o.lessonType," - ",o.lessonLevel]}),(0,a.jsx)("div",{className:"text-sm text-gray-600",children:(null==c?void 0:c.role)==="student"?"Teacher: ".concat(o.teacher.name):"Student: ".concat(o.student.name)})]}),(0,a.jsxs)("div",{className:"text-sm text-gray-500",children:[o.startTime," - ",o.endTime]})]}),(0,a.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2 ".concat(j?"text-green-600":"text-yellow-600"),children:[(0,a.jsx)("div",{className:"w-2 h-2 rounded-full ".concat(j?"bg-green-500":"bg-yellow-500")}),(0,a.jsx)("span",{className:"text-sm font-medium",children:j?"Connected":"Connecting..."})]}),(0,a.jsx)("button",{onClick:S,className:"bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 text-sm font-medium",children:"End Lesson"})]})]}),(0,a.jsx)("div",{className:"h-full",children:(0,a.jsxs)(l.IC,{video:!0,audio:!0,token:m,serverUrl:h,"data-lk-theme":"default",style:{height:"calc(100vh - 64px)"},onConnected:()=>{p(!0)},onDisconnected:()=>{p(!1)},children:[(0,a.jsx)(l.zc,{}),(0,a.jsx)(l.Z5,{})]})})]}):(0,a.jsx)("div",{className:"flex items-center justify-center min-h-screen bg-gray-100",children:(0,a.jsx)("div",{className:"text-center",children:(0,a.jsx)("div",{className:"text-lg font-medium text-gray-900",children:"Preparing video conference..."})})})}function o(){let e=(0,r.useRouter)(),{reservationId:t}=e.query,{user:s,loading:l}=(0,i.aC)(),[o,u]=(0,n.useState)(null),[m,x]=(0,n.useState)(!0),[h,v]=(0,n.useState)(""),[g,f]=(0,n.useState)(!1);(0,n.useEffect)(()=>{if(!l){if(!s){e.push("/login");return}t&&b()}},[t,s,l]);let b=async()=>{try{x(!0),v("");let e=(await d.ZP.get("/api/reservations/".concat(t))).data;if(!e)throw Error("Reservation not found");let a=e.student._id===(null==s?void 0:s.id),n=e.teacher._id===(null==s?void 0:s.id);if(!a&&!n)throw Error("You do not have access to this lesson");if(!["booked","inProgress"].includes(e.status))throw Error("Lesson cannot be accessed. Status: ".concat(e.status));let r=new Date,i=new Date(e.actualDate),[l,c]=e.endTime.split(":").map(Number),o=new Date(i);if(o.setHours(l,c,0,0),r>o)throw Error("This lesson has already ended");if(a){let[t,s]=e.startTime.split(":").map(Number),a=new Date(i);if(a.setHours(t,s,0,0),(a.getTime()-r.getTime())/6e4>15)throw Error("You can only join the lesson 15 minutes before the scheduled time")}u(e),f(!0)}catch(t){var e,a;v((null===(a=t.response)||void 0===a?void 0:null===(e=a.data)||void 0===e?void 0:e.message)||t.message||"Failed to access lesson")}finally{x(!1)}};return l||m?(0,a.jsx)("div",{className:"flex items-center justify-center min-h-screen bg-gray-100",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),(0,a.jsx)("div",{className:"text-lg font-medium text-gray-900",children:"Loading lesson..."})]})}):h?(0,a.jsx)("div",{className:"flex items-center justify-center min-h-screen bg-gray-100",children:(0,a.jsxs)("div",{className:"text-center max-w-md mx-auto p-6",children:[(0,a.jsx)("div",{className:"text-red-600 text-6xl mb-4",children:"\uD83D\uDEAB"}),(0,a.jsx)("div",{className:"text-lg font-medium text-gray-900 mb-2",children:"Access Denied"}),(0,a.jsx)("div",{className:"text-sm text-gray-600 mb-4",children:h}),(0,a.jsxs)("div",{className:"space-x-3",children:[(0,a.jsx)("button",{onClick:()=>e.back(),className:"bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400",children:"Go Back"}),(0,a.jsx)("button",{onClick:()=>window.location.reload(),className:"bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700",children:"Try Again"})]})]})}):g&&o&&t?(0,a.jsx)(c,{reservationId:t,onLessonEnd:()=>{(null==s?void 0:s.role)==="student"?e.push("/student/dashboard"):(null==s?void 0:s.role)==="teacher"?e.push("/teacher/dashboard"):e.push("/dashboard")},onError:e=>{v(e)}}):(0,a.jsx)("div",{className:"flex items-center justify-center min-h-screen bg-gray-100",children:(0,a.jsx)("div",{className:"text-center",children:(0,a.jsx)("div",{className:"text-lg font-medium text-gray-900",children:"Preparing lesson..."})})})}}},function(e){e.O(0,[2138,9226,9496,8484,437,5823,2244,6235,5323,747,3365,8638,9806,7093,8510,8424,8639,7855,7446,2169,8308,1408,6259,4657,8212,1493,2888,5514,179],function(){return e(e.s=25564)}),_N_E=e.O()}]);