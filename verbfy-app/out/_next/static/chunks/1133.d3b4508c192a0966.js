"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1133],{41133:function(e,t,s){s.r(t),s.d(t,{default:function(){return g}});var i=s(85893),a=s(67294),r=s(13822);class n{static getInstance(){return n.instance||(n.instance=new n),n.instance}initializePermissionState(){if(this.permissionState.isSupported=!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&"function"==typeof navigator.mediaDevices.getUserMedia),!this.permissionState.isSupported){this.permissionState.error="getUserMedia is not supported in this browser";return}"permissions"in navigator?this.checkPermissionStatus():this.permissionState.canRequest=!0}async checkPermissionStatus(){try{let e=await navigator.permissions.query({name:"microphone"});this.permissionState.isGranted="granted"===e.state,this.permissionState.isDenied="denied"===e.state,this.permissionState.canRequest="denied"!==e.state,this.permissionState.lastChecked=Date.now(),e.addEventListener("change",()=>{this.permissionState.isGranted="granted"===e.state,this.permissionState.isDenied="denied"===e.state,this.permissionState.canRequest="denied"!==e.state,this.permissionState.lastChecked=Date.now()})}catch(e){this.permissionState.canRequest=!0}}async getMicrophoneDevices(){try{let e=await navigator.mediaDevices.enumerateDevices();return this.devices=e.filter(e=>"audioinput"===e.kind).map(e=>({deviceId:e.deviceId,label:e.label||"Microphone ".concat(e.deviceId.slice(0,8)),kind:e.kind,groupId:e.groupId})),this.devices}catch(e){return[]}}async requestMicrophonePermission(e){if(!this.permissionState.isSupported)return{success:!1,error:"Microphone access is not supported in this browser. Please use a modern browser like Chrome, Firefox, Safari, or Edge."};if(this.permissionState.isDenied)return{success:!1,error:"Microphone access has been permanently denied. Please enable microphone access in your browser settings and refresh the page."};try{var t;let s={audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:44100,channelCount:1,latency:.01},video:!1},i={audio:{...s.audio,...(null==e?void 0:e.audio)||{}},video:null!==(t=null==e?void 0:e.video)&&void 0!==t?t:s.video};this.permissionState.isPrompted=!0;let a=await navigator.mediaDevices.getUserMedia(i);return this.currentStream=a,this.permissionState.isGranted=!0,this.permissionState.isDenied=!1,this.permissionState.lastChecked=Date.now(),this.permissionState.error=void 0,await this.getMicrophoneDevices(),{success:!0,stream:a}}catch(t){this.permissionState.isGranted=!1,this.permissionState.lastChecked=Date.now();let e=this.getDetailedErrorMessage(t);return this.permissionState.error=e,{success:!1,error:e}}}getDetailedErrorMessage(e){return e instanceof Error?({NotAllowedError:'Microphone access was denied. Please click "Allow" when prompted, or enable microphone access in your browser settings.',NotFoundError:"No microphone device found. Please connect a microphone and try again.",NotSupportedError:"Microphone access is not supported in this browser. Please use a modern browser.",NotReadableError:"Microphone is already in use by another application. Please close other applications using the microphone and try again.",AbortError:"Microphone access request was cancelled. Please try again.",SecurityError:"Microphone access is blocked due to security restrictions. Please ensure you are using HTTPS.",InvalidStateError:"Microphone is in an invalid state. Please refresh the page and try again.",TypeError:"Invalid microphone constraints. Please try again.",UnknownError:"An unknown error occurred while accessing the microphone. Please try again."})[e.name]||"Microphone access failed: ".concat(e.message||"Unknown error"):"Microphone access failed: Unknown error"}async testMicrophoneQuality(e){try{let t=new(window.AudioContext||window.webkitAudioContext),s=t.createMediaStreamSource(e),i=t.createAnalyser(),a=new Uint8Array(i.frequencyBinCount);return s.connect(i),i.fftSize=256,new Promise(e=>{let r=0,n=0,o=0,c=setInterval(()=>{i.getByteFrequencyData(a);let l=a.reduce((e,t)=>e+t,0)/a.length;if(n+=l,r++,l>10&&o++,r>=10){let a;clearInterval(c);let l=n/r,d=o/r;a=d>.7&&l>20?"excellent":d>.4&&l>10?"good":d>.1&&l>5?"poor":"none",e({isWorking:"none"!==a,hasAudio:d>.1,volumeLevel:l,quality:a}),s.disconnect(),i.disconnect(),t.close()}},100)})}catch(e){return{isWorking:!1,hasAudio:!1,volumeLevel:0,quality:"none"}}}stopMicrophone(){this.currentStream&&(this.currentStream.getTracks().forEach(e=>{e.stop()}),this.currentStream=null)}getPermissionState(){return{...this.permissionState}}isMicrophoneActive(){return null!==this.currentStream&&this.currentStream.getAudioTracks().some(e=>"live"===e.readyState)}getBrowserCompatibility(){return{getUserMedia:!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia),permissionsAPI:"permissions"in navigator,audioContext:!!(window.AudioContext||window.webkitAudioContext),webRTC:!!(window.RTCPeerConnection||window.webkitRTCPeerConnection),https:"https:"===location.protocol||"localhost"===location.hostname}}resetPermissionState(){this.stopMicrophone(),this.permissionState={isSupported:!1,isGranted:!1,isDenied:!1,isPrompted:!1,canRequest:!1,lastChecked:0},this.initializePermissionState()}constructor(){this.devices=[],this.currentStream=null,this.permissionState={isSupported:!1,isGranted:!1,isDenied:!1,isPrompted:!1,canRequest:!1,lastChecked:0},this.initializePermissionState()}}let o=n.getInstance(),c=()=>{let[e,t]=(0,a.useState)(o.getPermissionState()),[s,i]=(0,a.useState)([]),[r,n]=(0,a.useState)(null),[c,l]=(0,a.useState)(null),[d,u]=(0,a.useState)(!1),[m,h]=(0,a.useState)({isWorking:!1,hasAudio:!1,volumeLevel:0,quality:"none"}),[p,x]=(0,a.useState)(null),g=(0,a.useRef)(null),v=o.getBrowserCompatibility(),b=(0,a.useCallback)(()=>{let e=o.getPermissionState();t(e),x(e.error||null)},[]),y=(0,a.useCallback)(async()=>{try{let e=await o.getMicrophoneDevices();if(i(e),c&&e.length>0){let t=c.getAudioTracks()[0];if(t){let s=e.find(e=>e.deviceId===t.getSettings().deviceId);n(s||e[0])}}}catch(e){}},[c]),w=(0,a.useCallback)(e=>{g.current&&clearInterval(g.current),g.current=setInterval(async()=>{try{let t=await o.testMicrophoneQuality(e);h(t),u(t.isWorking)}catch(e){u(!1)}},2e3)},[]),f=(0,a.useCallback)(async e=>{try{x(null);let t=await o.requestMicrophonePermission(e);return t.success&&t.stream?(l(t.stream),u(!0),await y(),w(t.stream)):x(t.error||"Failed to access microphone"),b(),t}catch(t){let e=t instanceof Error?t.message:"Unknown error occurred";return x(e),b(),{success:!1,error:e}}},[y,b,w]),j=(0,a.useCallback)(()=>{o.stopMicrophone(),l(null),u(!1),h({isWorking:!1,hasAudio:!1,volumeLevel:0,quality:"none"}),g.current&&(clearInterval(g.current),g.current=null),b()},[b]),N=(0,a.useCallback)(async()=>{if(c)try{let e=await o.testMicrophoneQuality(c);h(e)}catch(e){}},[c]),S=(0,a.useCallback)(()=>{x(null)},[]);return(0,a.useEffect)(()=>{b(),y();let e=setInterval(b,5e3);return()=>{clearInterval(e),g.current&&clearInterval(g.current)}},[b,y]),(0,a.useEffect)(()=>{if(c){let e=c.getAudioTracks()[0];if(e){let t=()=>{u(!1),h(e=>({...e,isWorking:!1,quality:"none"}))},s=()=>{u(!1)},i=()=>{u(!0)};return e.addEventListener("ended",t),e.addEventListener("mute",s),e.addEventListener("unmute",i),()=>{e.removeEventListener("ended",t),e.removeEventListener("mute",s),e.removeEventListener("unmute",i)}}}},[c]),{permissionState:e,isSupported:e.isSupported,isGranted:e.isGranted,isDenied:e.isDenied,canRequest:e.canRequest,devices:s,currentDevice:r,currentStream:c,isActive:d,quality:m,requestPermission:f,stopMicrophone:j,testQuality:N,refreshDevices:y,browserCompatibility:v,error:p,clearError:S}};var l=s(54910),d=s(11429),u=s(13431),m=s(61937),h=s(29711);function p(e){let{onPermissionGranted:t,onCancel:s,roomName:r="VerbfyTalk Room"}=e,{isSupported:n,isGranted:o,isDenied:p,canRequest:x,devices:g,currentStream:v,isActive:b,quality:y,requestPermission:w,stopMicrophone:f,testQuality:j,refreshDevices:N,browserCompatibility:S,error:k,clearError:C}=c(),[M,P]=(0,a.useState)(!1),[D,E]=(0,a.useState)(!1),[A,R]=(0,a.useState)(""),I=(0,a.useCallback)(async()=>{P(!0),C();let e=A?{audio:{deviceId:{exact:A},echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:44100,channelCount:1,latency:.01},video:!1}:void 0;(await w(e)).success,P(!1)},[A,C,w]),q=async()=>{f(),await N(),await I()},T=async()=>{await j()};return(0,a.useEffect)(()=>{n&&x&&!o&&!p&&I()},[n,x,o,p,I]),(0,a.useEffect)(()=>{v&&b&&y.isWorking&&t(v)},[v,b,y.isWorking,t]),(0,i.jsx)("div",{className:"flex items-center justify-center h-screen bg-gray-900",children:(0,i.jsxs)("div",{className:"text-center max-w-md mx-auto p-6",children:[(0,i.jsxs)("div",{className:"mb-6",children:[M?(0,i.jsx)(l.Z,{className:"w-16 h-16 text-blue-600 animate-spin"}):o&&b&&y.isWorking?(0,i.jsx)(d.Z,{className:"w-16 h-16 text-green-600"}):p?(0,i.jsx)(h.Z,{className:"w-16 h-16 text-red-600"}):n?(0,i.jsx)(m.Z,{className:"w-16 h-16 text-blue-600"}):(0,i.jsx)(u.Z,{className:"w-16 h-16 text-yellow-600"}),(0,i.jsx)("h2",{className:"text-2xl font-bold text-white mt-4 mb-2",children:"Microphone Access Required"}),(0,i.jsxs)("p",{className:"text-gray-300 mb-4",children:[r," needs access to your microphone for voice chat."]})]}),(0,i.jsxs)("div",{className:"mb-6 p-4 rounded-lg bg-gray-800 ".concat(o&&b&&y.isWorking?"text-green-600":p||k?"text-red-600":n?"text-blue-600":"text-yellow-600"),children:[(0,i.jsx)("p",{className:"text-sm font-medium",children:M?"Requesting microphone access...":o&&b&&y.isWorking?"Microphone access granted! Quality: ".concat(y.quality):p?"Microphone access was denied. Please enable it in your browser settings.":n?k||"Microphone access is required for voice chat.":"Microphone access is not supported in this browser."}),b&&y.isWorking?(0,i.jsxs)("div",{className:"mt-4 flex items-center justify-center gap-2",children:[(0,i.jsx)("div",{className:"w-3 h-3 rounded-full ".concat({excellent:"bg-green-500",good:"bg-blue-500",poor:"bg-yellow-500",none:"bg-red-500"}[y.quality]," animate-pulse")}),(0,i.jsxs)("span",{className:"text-sm text-gray-400",children:["Quality: ",y.quality," | Volume: ",Math.round(y.volumeLevel)]})]}):null]}),k&&(0,i.jsxs)("div",{className:"mb-6 p-4 bg-red-900 border border-red-700 rounded-lg",children:[(0,i.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,i.jsx)(u.Z,{className:"w-5 h-5 text-red-400"}),(0,i.jsx)("span",{className:"text-red-400 font-medium",children:"Error"})]}),(0,i.jsx)("p",{className:"text-red-300 text-sm",children:k})]}),(0,i.jsxs)("div",{className:"space-y-3",children:[!o&&x&&!M&&(0,i.jsx)("button",{onClick:I,className:"w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors",children:"Allow Microphone Access"}),o&&b&&(0,i.jsx)("button",{onClick:T,className:"w-full bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors",children:"Test Microphone Quality"}),(p||k)&&(0,i.jsx)("button",{onClick:q,className:"w-full bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-3 rounded-lg font-medium transition-colors",children:"Retry Microphone Access"}),(0,i.jsxs)("button",{onClick:()=>E(!D),className:"w-full bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-medium transition-colors",children:[D?"Hide":"Show"," Advanced Options"]})]}),D&&(0,i.jsxs)("div",{className:"mt-6",children:[D&&0!==g.length?(0,i.jsxs)("div",{className:"mt-4",children:[(0,i.jsx)("label",{className:"block text-sm font-medium text-white mb-2",children:"Select Microphone Device"}),(0,i.jsxs)("select",{value:A,onChange:e=>R(e.target.value),className:"w-full bg-gray-700 text-white px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[(0,i.jsx)("option",{value:"",children:"Default Device"}),g.map(e=>(0,i.jsx)("option",{value:e.deviceId,children:e.label},e.deviceId))]})]}):null,D?(0,i.jsxs)("div",{className:"mt-6 p-4 bg-gray-800 rounded-lg",children:[(0,i.jsx)("h4",{className:"text-sm font-semibold text-white mb-3",children:"Browser Compatibility"}),(0,i.jsxs)("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)(d.Z,{className:"w-4 h-4 ".concat(S.getUserMedia?"text-green-500":"text-red-500")}),(0,i.jsx)("span",{className:"text-gray-300",children:"getUserMedia"})]}),(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)(d.Z,{className:"w-4 h-4 ".concat(S.permissionsAPI?"text-green-500":"text-red-500")}),(0,i.jsx)("span",{className:"text-gray-300",children:"Permissions API"})]}),(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)(d.Z,{className:"w-4 h-4 ".concat(S.audioContext?"text-green-500":"text-red-500")}),(0,i.jsx)("span",{className:"text-gray-300",children:"Audio Context"})]}),(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)(d.Z,{className:"w-4 h-4 ".concat(S.webRTC?"text-green-500":"text-red-500")}),(0,i.jsx)("span",{className:"text-gray-300",children:"WebRTC"})]}),(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)(d.Z,{className:"w-4 h-4 ".concat(S.https?"text-green-500":"text-red-500")}),(0,i.jsx)("span",{className:"text-gray-300",children:"HTTPS"})]})]})]}):null]}),(0,i.jsxs)("div",{className:"mt-6 text-sm text-gray-400 space-y-1",children:[(0,i.jsx)("p",{children:"• Your microphone will only be used for voice chat"}),(0,i.jsx)("p",{children:"• You can mute/unmute anytime during the conversation"}),(0,i.jsx)("p",{children:"• No audio is recorded or stored"}),(0,i.jsx)("p",{children:"• Microphone access can be revoked in browser settings"})]}),(0,i.jsx)("button",{onClick:s,className:"mt-6 text-gray-400 hover:text-white transition-colors",children:"← Back to Rooms"})]})})}var x=s(82861);function g(e){let{roomId:t,onLeave:s}=e,{isConnected:n,isLoading:o,error:c,currentRoom:l,participants:d,messages:u,isMuted:h,isSpeaking:g,joinRoom:v,leaveRoom:b,sendMessage:y,toggleMute:w,setMicrophoneStream:f,setError:j}=(0,r.t)(),[N,S]=(0,a.useState)(!1),[k,C]=(0,a.useState)("");(0,a.useEffect)(()=>{t&&n&&N&&v(t).catch(e=>{j("Failed to join room. Please try again.")})},[t,n,N,v,j]);let M=()=>{b(),s()};return o?(0,i.jsx)("div",{className:"flex items-center justify-center h-screen bg-gray-900",children:(0,i.jsxs)("div",{className:"text-center",children:[(0,i.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),(0,i.jsx)("p",{className:"mt-4 text-white",children:"Joining room..."})]})}):N?c?(0,i.jsx)("div",{className:"flex items-center justify-center h-screen bg-gray-900",children:(0,i.jsxs)("div",{className:"text-center",children:[(0,i.jsx)("p",{className:"text-red-400 mb-4",children:c}),(0,i.jsx)("button",{onClick:()=>{j(null),v(t)},className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg mr-4",children:"Retry"}),(0,i.jsx)("button",{onClick:M,className:"bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg",children:"Leave Room"})]})}):(0,i.jsxs)("div",{className:"h-screen flex flex-col bg-gray-900",children:[(0,i.jsxs)("div",{className:"bg-gray-800 p-4 flex items-center justify-between",children:[(0,i.jsxs)("div",{className:"flex items-center gap-4",children:[(0,i.jsx)("button",{onClick:M,className:"text-gray-300 hover:text-white p-2 rounded-lg hover:bg-gray-700",children:(0,i.jsx)(x.Z,{className:"w-6 h-6"})}),(0,i.jsxs)("div",{children:[(0,i.jsx)("h1",{className:"text-xl font-bold text-white",children:(null==l?void 0:l.name)||"Room ".concat(t)}),(0,i.jsxs)("p",{className:"text-gray-400 text-sm",children:[d.length," participant",1!==d.length?"s":""]})]})]}),(0,i.jsx)("div",{className:"flex items-center gap-4",children:(0,i.jsxs)("button",{onClick:w,className:"p-3 rounded-full transition-colors relative ".concat(h?"bg-red-600 hover:bg-red-700 text-white":g?"bg-green-600 hover:bg-green-700 text-white animate-pulse":"bg-green-600 hover:bg-green-700 text-white"),children:[(0,i.jsx)(m.Z,{className:"w-6 h-6 ".concat(h?"opacity-50":"")}),g&&!h&&(0,i.jsx)("div",{className:"absolute -top-1 -right-1 w-3 h-3 bg-green-400 rounded-full animate-pulse"})]})})]}),(0,i.jsxs)("div",{className:"flex-1 flex",children:[(0,i.jsxs)("div",{className:"w-1/3 bg-gray-800 p-4",children:[(0,i.jsx)("h2",{className:"text-lg font-semibold text-white mb-4",children:"Participants"}),(0,i.jsx)("div",{className:"space-y-2",children:d.map(e=>(0,i.jsxs)("div",{className:"flex items-center gap-3 p-3 rounded-lg transition-colors ".concat(e.isSpeaking?"bg-green-700 border border-green-500":"bg-gray-700"),children:[(0,i.jsx)("div",{className:"w-3 h-3 rounded-full transition-colors ".concat(e.isSpeaking?"bg-green-500 animate-pulse":"bg-gray-500")}),(0,i.jsx)("span",{className:"text-white font-medium",children:e.name}),e.isMuted&&(0,i.jsx)(m.Z,{className:"w-4 h-4 text-red-400 opacity-50"}),e.isSpeaking&&(0,i.jsx)("div",{className:"ml-auto",children:(0,i.jsx)("div",{className:"w-2 h-2 bg-green-400 rounded-full animate-pulse"})})]},e.id))})]}),(0,i.jsxs)("div",{className:"flex-1 flex flex-col",children:[(0,i.jsx)("div",{className:"flex-1 p-4 overflow-y-auto",children:(0,i.jsx)("div",{className:"space-y-4",children:u.map(e=>(0,i.jsxs)("div",{className:"flex gap-3",children:[(0,i.jsx)("div",{className:"w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white text-sm font-semibold",children:e.userName.charAt(0).toUpperCase()}),(0,i.jsxs)("div",{className:"flex-1",children:[(0,i.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,i.jsx)("span",{className:"text-white font-semibold",children:e.userName}),(0,i.jsx)("span",{className:"text-gray-400 text-sm",children:new Date(e.timestamp).toLocaleTimeString()})]}),(0,i.jsx)("p",{className:"text-gray-300",children:e.message})]})]},e.id))})}),(0,i.jsx)("div",{className:"p-4 border-t border-gray-700",children:(0,i.jsxs)("form",{onSubmit:e=>{e.preventDefault(),k.trim()&&(y(k),C(""))},className:"flex gap-3",children:[(0,i.jsx)("input",{type:"text",value:k,onChange:e=>C(e.target.value),placeholder:"Type a message...",className:"flex-1 bg-gray-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600"}),(0,i.jsx)("button",{type:"submit",disabled:!k.trim(),className:"bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white px-6 py-2 rounded-lg transition-colors",children:"Send"})]})})]})]})]}):(0,i.jsx)(p,{onPermissionGranted:e=>{try{f(e),S(!0),t&&n&&v(t).catch(e=>{j("Failed to join room. Please try again.")})}catch(e){j("Failed to initialize microphone. Please try again.")}},onCancel:()=>{try{s()}catch(e){s()}},roomName:(null==l?void 0:l.name)||"Room ".concat(t)})}}}]);