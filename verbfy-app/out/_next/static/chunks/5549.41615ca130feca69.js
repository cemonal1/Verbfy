"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5549],{95549:function(e,t,r){r.r(t),r.d(t,{default:function(){return b}});var s=r(85893),n=r(67294),a=r(17734),i=r(36197),o=r(5704);let c=(0,r(97679).hu)("VerbfyTalk"),l=()=>{let{user:e}=(0,i.aC)(),t=o.tokenStorage.getToken(),[r,s]=(0,n.useState)(!1),[l,d]=(0,n.useState)(new Map),[u,m]=(0,n.useState)(new Map),[h,g]=(0,n.useState)(new Map),[p,x]=(0,n.useState)(!1),[v,f]=(0,n.useState)(null),[w,b]=(0,n.useState)(!1),[y]=(0,n.useState)(!1),[j,N]=(0,n.useState)(null),[k,S]=(0,n.useState)({}),C=(0,n.useMemo)(()=>{let e=Array.from(l.values());return e.length>0?e[0]:null},[l]),M=(0,n.useMemo)(()=>C&&u.get(C._id)||[],[C,u]),R=(0,n.useMemo)(()=>C&&h.get(C._id)||[],[C,h]),I=(0,n.useRef)(null),E=(0,n.useRef)(null),P=(0,n.useRef)(new Map),D=(0,n.useRef)(new Map),T=(0,n.useRef)({}),A=(0,n.useMemo)(()=>({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]}),[]),L=(0,n.useCallback)(async(e,t)=>{try{var r;let s=new RTCPeerConnection(A);P.current.has(t)||P.current.set(t,new Map),P.current.get(t).set(e,s),D.current.set(e,s),T.current[e]=s,E.current&&E.current.getTracks().forEach(e=>{s.addTrack(e,E.current)}),s.onicecandidate=r=>{var s;r.candidate&&(null===(s=I.current)||void 0===s?void 0:s.connected)&&I.current.emit("webrtc:ice-candidate",{to:e,candidate:r.candidate,roomId:t})},s.ontrack=r=>{c.info("Remote audio stream received",{participantId:e,roomId:t});let[s]=r.streams;S(r=>({...r,["".concat(t,"-").concat(e)]:s}))};let n=await s.createOffer();await s.setLocalDescription(n),(null===(r=I.current)||void 0===r?void 0:r.connected)&&I.current.emit("webrtc:offer",{to:e,offer:n,roomId:t})}catch(e){c.error("Failed to create peer connection:",e)}},[A]),q=(0,n.useCallback)(async(e,t)=>L(e,t),[L]),U=(0,n.useCallback)(async(e,t,r)=>{try{var s;let n=new RTCPeerConnection(A);P.current.has(r)||P.current.set(r,new Map),P.current.get(r).set(e,n),D.current.set(e,n),T.current[e]=n,E.current&&E.current.getTracks().forEach(e=>{n.addTrack(e,E.current)}),n.onicecandidate=t=>{var s;t.candidate&&(null===(s=I.current)||void 0===s?void 0:s.connected)&&I.current.emit("webrtc:ice-candidate",{to:e,roomId:r,candidate:t.candidate})},n.ontrack=t=>{c.info("Remote audio stream received",{participantId:e,roomId:r});let[s]=t.streams;S(t=>({...t,["".concat(r,"-").concat(e)]:s}))},await n.setRemoteDescription(t);let a=await n.createAnswer();await n.setLocalDescription(a),(null===(s=I.current)||void 0===s?void 0:s.connected)&&I.current.emit("webrtc:answer",{to:e,roomId:r,answer:a})}catch(e){c.error("Failed to handle offer:",e)}},[A]),O=(0,n.useCallback)(async(e,t,r)=>{try{let s=P.current.get(r),n=null==s?void 0:s.get(e);n||(n=D.current.get(e)),n&&await n.setRemoteDescription(t)}catch(e){c.error("Failed to handle answer:",e)}},[]),_=(0,n.useCallback)(async(e,t,r)=>{try{let s=P.current.get(r),n=null==s?void 0:s.get(e);n||(n=D.current.get(e)),n&&n.remoteDescription&&await n.addIceCandidate(t)}catch(e){c.error("Failed to handle ICE candidate:",e)}},[]);(0,n.useEffect)(()=>{if(!e||!t){c.warn("No user or token available");return}let r="http://localhost:5000";c.info("Attempting to connect",{backendUrl:r}),c.debug("User info",{name:null==e?void 0:e.name,hasToken:!!t});let n=(0,a.io)(r,{auth:{token:t},transports:["polling"],upgrade:!0,rememberUpgrade:!0,timeout:2e4,forceNew:!0,reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3,reconnectionDelayMax:5e3,autoConnect:!0,withCredentials:!0});return I.current=n,n.on("connect",()=>{c.info("Connected to server successfully"),c.debug("Socket ID",{socketId:n.id}),s(!0),N(null)}),n.on("disconnect",e=>{c.warn("Disconnected from server",{reason:e}),s(!1),d(new Map),m(new Map),S({}),Object.values(T.current).forEach(e=>e.close()),T.current={},D.current.clear()}),n.on("reconnect",e=>{c.info("Reconnected after attempts",{attemptNumber:e}),s(!0),N(null)}),n.on("reconnect_attempt",e=>{c.debug("Reconnection attempt",{attemptNumber:e})}),n.on("reconnect_error",e=>{c.error("Reconnection error:",e)}),n.on("reconnect_failed",()=>{c.error("Reconnection failed after all attempts")}),n.on("room:joined",t=>{let{room:r,roomId:s}=t;c.info("Joined room",{roomName:r.name,roomId:s}),d(e=>new Map(e).set(s,r));let n=r.participants.map(e=>({id:e.userId._id,name:e.userId.name,isSpeaking:!1,isMuted:!1,isSpeaker:!1}));m(e=>new Map(e).set(s,n)),g(e=>new Map(e).set(s,[])),r.participants&&r.participants.length>0&&(c.info("Initializing WebRTC connections",{participantCount:r.participants.length,roomId:s}),r.participants.forEach(t=>{t.userId._id!==(null==e?void 0:e.id)&&L(t.userId._id,s)}))}),n.on("participant:joined",t=>{let{participant:r,roomId:s}=t;c.info("Participant joined",{name:r.name,roomId:s});let n={id:r.id,name:r.name,isSpeaking:!1,isMuted:!1,isSpeaker:!1};m(e=>{let t=new Map(e),r=t.get(s)||[];return t.set(s,[...r,n]),t}),r.id!==(null==e?void 0:e.id)&&L(r.id,s)}),n.on("participant:left",e=>{var t,r;let{participantId:s,roomId:n}=e;c.info("Participant left",{participantId:s,roomId:n}),m(e=>{let t=new Map(e),r=t.get(n)||[];return t.set(n,r.filter(e=>e.id!==s)),t});let a=P.current.get(n);(null==a?void 0:a.has(s))&&(c.debug("Closing peer connection",{participantId:s,roomId:n}),null===(t=a.get(s))||void 0===t||t.close(),a.delete(s)),T.current[s]&&(c.debug("Closing peer connection",{participantId:s}),T.current[s].close(),delete T.current[s]),D.current.has(s)&&(null===(r=D.current.get(s))||void 0===r||r.close(),D.current.delete(s))}),n.on("message:received",e=>{c.debug("Message received",{message:e.message.message,roomId:e.roomId}),g(t=>{let r=new Map(t),s=r.get(e.roomId)||[];return r.set(e.roomId,[...s,e.message]),r})}),n.on("webrtc:offer",async e=>{await U(e.from,e.offer,e.roomId)}),n.on("webrtc:answer",async e=>{await O(e.from,e.answer,e.roomId)}),n.on("webrtc:ice-candidate",async e=>{await _(e.from,e.candidate,e.roomId)}),()=>{n.disconnect(),I.current=null}},[e,t,L,U,O,_]);let F=(0,n.useCallback)(async(e,r)=>{var s;if(!(null===(s=I.current)||void 0===s?void 0:s.connected))return f("Not connected to server"),!1;if(l.has(e))return c.info("Already connected to room",{roomId:e}),l.get(e);try{x(!0),f(null);let s=await fetch("/api/verbfy-talk/".concat(e,"/join"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(t)},credentials:"include",body:JSON.stringify({password:r})});if(!s.ok){let e=await s.json();throw Error(e.message||"Failed to join room")}let n=await s.json();return c.info("HTTP API join successful",{roomName:n.data.name}),d(t=>new Map(t).set(e,n.data)),m(t=>new Map(t).set(e,[])),g(t=>new Map(t).set(e,[])),I.current.emit("room:join",{roomId:e}),n.data}catch(e){throw c.error("Failed to join room via HTTP API",{error:e instanceof Error?e.message:"Unknown error"}),e}finally{x(!1)}},[t,l]),W=(0,n.useCallback)(e=>{E.current=e,c.info("Microphone stream set in useVerbfyTalk"),Object.values(T.current).forEach(t=>{let r=t.getSenders().find(e=>{var t;return(null===(t=e.track)||void 0===t?void 0:t.kind)==="audio"});r&&e.getAudioTracks()[0]?r.replaceTrack(e.getAudioTracks()[0]):e.getAudioTracks()[0]&&t.addTrack(e.getAudioTracks()[0],e)})},[]),G=(0,n.useCallback)(e=>{var t;let r=e||(null==C?void 0:C._id);if(!r){c.warn("No room to leave");return}(null===(t=I.current)||void 0===t?void 0:t.connected)&&I.current.emit("room:leave",{roomId:r}),d(e=>{let t=new Map(e);return t.delete(r),t}),m(e=>{let t=new Map(e);return t.delete(r),t}),g(e=>{let t=new Map(e);return t.delete(r),t});let s=P.current.get(r);s&&(s.forEach(e=>e.close()),P.current.delete(r)),r===(null==C?void 0:C._id)&&(D.current.forEach(e=>e.close()),D.current.clear(),Object.values(T.current).forEach(e=>e.close()),T.current={}),1===l.size&&l.has(r)&&E.current&&(E.current.getTracks().forEach(e=>e.stop()),E.current=null)},[C,l]),Z=(0,n.useCallback)(()=>{Array.from(l.keys()).forEach(e=>G(e))},[l,G]),B=(0,n.useCallback)((e,t)=>{var r;let s=t||(null==C?void 0:C._id);(null===(r=I.current)||void 0===r?void 0:r.connected)&&s&&(c.debug("Sending message",{roomId:s,message:e.trim()}),I.current.emit("message:send",{roomId:s,message:e.trim()}))},[C]);return{isConnected:r,isLoading:p,error:v,connectionError:j,currentRoom:C,participants:M,messages:R,connectedRooms:l,roomParticipants:u,roomMessages:h,isMuted:w,isSpeaking:y,remoteStreams:k,joinRoom:F,leaveRoom:G,leaveAllRooms:Z,sendMessage:B,toggleMute:(0,n.useCallback)(()=>{if(E.current){let e=E.current.getAudioTracks()[0];e&&(e.enabled=!e.enabled,b(!e.enabled))}},[]),createPeerConnection:q,setMicrophoneStream:W,setError:f}};class d{static getInstance(){return d.instance||(d.instance=new d),d.instance}initializePermissionState(){if(this.permissionState.isSupported=!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&"function"==typeof navigator.mediaDevices.getUserMedia),!this.permissionState.isSupported){this.permissionState.error="getUserMedia is not supported in this browser";return}"permissions"in navigator?this.checkPermissionStatus():this.permissionState.canRequest=!0}async checkPermissionStatus(){try{let e=await navigator.permissions.query({name:"microphone"});this.permissionState.isGranted="granted"===e.state,this.permissionState.isDenied="denied"===e.state,this.permissionState.canRequest="denied"!==e.state,this.permissionState.lastChecked=Date.now(),e.addEventListener("change",()=>{this.permissionState.isGranted="granted"===e.state,this.permissionState.isDenied="denied"===e.state,this.permissionState.canRequest="denied"!==e.state,this.permissionState.lastChecked=Date.now()})}catch(e){this.permissionState.canRequest=!0}}async getMicrophoneDevices(){try{let e=await navigator.mediaDevices.enumerateDevices();return this.devices=e.filter(e=>"audioinput"===e.kind).map(e=>({deviceId:e.deviceId,label:e.label||"Microphone ".concat(e.deviceId.slice(0,8)),kind:e.kind,groupId:e.groupId})),this.devices}catch(e){return[]}}async requestMicrophonePermission(e){if(!this.permissionState.isSupported)return{success:!1,error:"Microphone access is not supported in this browser. Please use a modern browser like Chrome, Firefox, Safari, or Edge."};if(this.permissionState.isDenied)return{success:!1,error:"Microphone access has been permanently denied. Please enable microphone access in your browser settings and refresh the page."};try{var t;let r={audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:44100,channelCount:1,latency:.01},video:!1},s={audio:{...r.audio,...(null==e?void 0:e.audio)||{}},video:null!==(t=null==e?void 0:e.video)&&void 0!==t?t:r.video};this.permissionState.isPrompted=!0;let n=await navigator.mediaDevices.getUserMedia(s);return this.currentStream=n,this.permissionState.isGranted=!0,this.permissionState.isDenied=!1,this.permissionState.lastChecked=Date.now(),this.permissionState.error=void 0,await this.getMicrophoneDevices(),{success:!0,stream:n}}catch(t){this.permissionState.isGranted=!1,this.permissionState.lastChecked=Date.now();let e=this.getDetailedErrorMessage(t);return this.permissionState.error=e,{success:!1,error:e}}}getDetailedErrorMessage(e){return e instanceof Error?({NotAllowedError:'Microphone access was denied. Please click "Allow" when prompted, or enable microphone access in your browser settings.',NotFoundError:"No microphone device found. Please connect a microphone and try again.",NotSupportedError:"Microphone access is not supported in this browser. Please use a modern browser.",NotReadableError:"Microphone is already in use by another application. Please close other applications using the microphone and try again.",AbortError:"Microphone access request was cancelled. Please try again.",SecurityError:"Microphone access is blocked due to security restrictions. Please ensure you are using HTTPS.",InvalidStateError:"Microphone is in an invalid state. Please refresh the page and try again.",TypeError:"Invalid microphone constraints. Please try again.",UnknownError:"An unknown error occurred while accessing the microphone. Please try again."})[e.name]||"Microphone access failed: ".concat(e.message||"Unknown error"):"Microphone access failed: Unknown error"}async testMicrophoneQuality(e){try{let t=new(window.AudioContext||window.webkitAudioContext),r=t.createMediaStreamSource(e),s=t.createAnalyser(),n=new Uint8Array(s.frequencyBinCount);return r.connect(s),s.fftSize=256,new Promise(e=>{let a=0,i=0,o=0,c=setInterval(()=>{s.getByteFrequencyData(n);let l=n.reduce((e,t)=>e+t,0)/n.length;if(i+=l,a++,l>10&&o++,a>=10){let n;clearInterval(c);let l=i/a,d=o/a;n=d>.7&&l>20?"excellent":d>.4&&l>10?"good":d>.1&&l>5?"poor":"none",e({isWorking:"none"!==n,hasAudio:d>.1,volumeLevel:l,quality:n}),r.disconnect(),s.disconnect(),t.close()}},100)})}catch(e){return{isWorking:!1,hasAudio:!1,volumeLevel:0,quality:"none"}}}stopMicrophone(){this.currentStream&&(this.currentStream.getTracks().forEach(e=>{e.stop()}),this.currentStream=null)}getPermissionState(){return{...this.permissionState}}isMicrophoneActive(){return null!==this.currentStream&&this.currentStream.getAudioTracks().some(e=>"live"===e.readyState)}getBrowserCompatibility(){return{getUserMedia:!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia),permissionsAPI:"permissions"in navigator,audioContext:!!(window.AudioContext||window.webkitAudioContext),webRTC:!!(window.RTCPeerConnection||window.webkitRTCPeerConnection),https:"https:"===location.protocol||"localhost"===location.hostname}}resetPermissionState(){this.stopMicrophone(),this.permissionState={isSupported:!1,isGranted:!1,isDenied:!1,isPrompted:!1,canRequest:!1,lastChecked:0},this.initializePermissionState()}constructor(){this.devices=[],this.currentStream=null,this.permissionState={isSupported:!1,isGranted:!1,isDenied:!1,isPrompted:!1,canRequest:!1,lastChecked:0},this.initializePermissionState()}}let u=d.getInstance(),m=()=>{let[e,t]=(0,n.useState)(u.getPermissionState()),[r,s]=(0,n.useState)([]),[a,i]=(0,n.useState)(null),[o,c]=(0,n.useState)(null),[l,d]=(0,n.useState)(!1),[m,h]=(0,n.useState)({isWorking:!1,hasAudio:!1,volumeLevel:0,quality:"none"}),[g,p]=(0,n.useState)(null),x=(0,n.useRef)(null),v=u.getBrowserCompatibility(),f=(0,n.useCallback)(()=>{let e=u.getPermissionState();t(e),p(e.error||null)},[]),w=(0,n.useCallback)(async()=>{try{let e=await u.getMicrophoneDevices();if(s(e),o&&e.length>0){let t=o.getAudioTracks()[0];if(t){let r=e.find(e=>e.deviceId===t.getSettings().deviceId);i(r||e[0])}}}catch(e){}},[o]),b=(0,n.useCallback)(e=>{x.current&&clearInterval(x.current),x.current=setInterval(async()=>{try{let t=await u.testMicrophoneQuality(e);h(t),d(t.isWorking)}catch(e){d(!1)}},2e3)},[]),y=(0,n.useCallback)(async e=>{try{p(null);let t=await u.requestMicrophonePermission(e);return t.success&&t.stream?(c(t.stream),d(!0),await w(),b(t.stream)):p(t.error||"Failed to access microphone"),f(),t}catch(t){let e=t instanceof Error?t.message:"Unknown error occurred";return p(e),f(),{success:!1,error:e}}},[w,f,b]),j=(0,n.useCallback)(()=>{u.stopMicrophone(),c(null),d(!1),h({isWorking:!1,hasAudio:!1,volumeLevel:0,quality:"none"}),x.current&&(clearInterval(x.current),x.current=null),f()},[f]),N=(0,n.useCallback)(async()=>{if(o)try{let e=await u.testMicrophoneQuality(o);h(e)}catch(e){}},[o]),k=(0,n.useCallback)(()=>{p(null)},[]);return(0,n.useEffect)(()=>{f(),w();let e=setInterval(f,5e3);return()=>{clearInterval(e),x.current&&clearInterval(x.current)}},[f,w]),(0,n.useEffect)(()=>{if(o){let e=o.getAudioTracks()[0];if(e){let t=()=>{d(!1),h(e=>({...e,isWorking:!1,quality:"none"}))},r=()=>{d(!1)},s=()=>{d(!0)};return e.addEventListener("ended",t),e.addEventListener("mute",r),e.addEventListener("unmute",s),()=>{e.removeEventListener("ended",t),e.removeEventListener("mute",r),e.removeEventListener("unmute",s)}}}},[o]),{permissionState:e,isSupported:e.isSupported,isGranted:e.isGranted,isDenied:e.isDenied,canRequest:e.canRequest,devices:r,currentDevice:a,currentStream:o,isActive:l,quality:m,requestPermission:y,stopMicrophone:j,testQuality:N,refreshDevices:w,browserCompatibility:v,error:g,clearError:k}};var h=r(54910),g=r(11429),p=r(13431),x=r(61937),v=r(29711);function f(e){let{onPermissionGranted:t,onCancel:r,roomName:a="VerbfyTalk Room"}=e,{isSupported:i,isGranted:o,isDenied:c,canRequest:l,devices:d,currentStream:u,isActive:f,quality:w,requestPermission:b,stopMicrophone:y,testQuality:j,refreshDevices:N,browserCompatibility:k,error:S,clearError:C}=m(),[M,R]=(0,n.useState)(!1),[I,E]=(0,n.useState)(!1),[P,D]=(0,n.useState)(""),T=(0,n.useCallback)(async()=>{R(!0),C();let e=P?{audio:{deviceId:{exact:P},echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:44100,channelCount:1,latency:.01},video:!1}:void 0;(await b(e)).success,R(!1)},[P,C,b]),A=async()=>{y(),await N(),await T()},L=async()=>{await j()};return(0,n.useEffect)(()=>{i&&l&&!o&&!c&&T()},[i,l,o,c,T]),(0,n.useEffect)(()=>{u&&f&&w.isWorking&&t(u)},[u,f,w.isWorking,t]),(0,s.jsx)("div",{className:"flex items-center justify-center h-screen bg-gray-900",children:(0,s.jsxs)("div",{className:"text-center max-w-md mx-auto p-6",children:[(0,s.jsxs)("div",{className:"mb-6",children:[M?(0,s.jsx)(h.Z,{className:"w-16 h-16 text-blue-600 animate-spin"}):o&&f&&w.isWorking?(0,s.jsx)(g.Z,{className:"w-16 h-16 text-green-600"}):c?(0,s.jsx)(v.Z,{className:"w-16 h-16 text-red-600"}):i?(0,s.jsx)(x.Z,{className:"w-16 h-16 text-blue-600"}):(0,s.jsx)(p.Z,{className:"w-16 h-16 text-yellow-600"}),(0,s.jsx)("h2",{className:"text-2xl font-bold text-white mt-4 mb-2",children:"Microphone Access Required"}),(0,s.jsxs)("p",{className:"text-gray-300 mb-4",children:[a," needs access to your microphone for voice chat."]})]}),(0,s.jsxs)("div",{className:"mb-6 p-4 rounded-lg bg-gray-800 ".concat(o&&f&&w.isWorking?"text-green-600":c||S?"text-red-600":i?"text-blue-600":"text-yellow-600"),children:[(0,s.jsx)("p",{className:"text-sm font-medium",children:M?"Requesting microphone access...":o&&f&&w.isWorking?"Microphone access granted! Quality: ".concat(w.quality):c?"Microphone access was denied. Please enable it in your browser settings.":i?S||"Microphone access is required for voice chat.":"Microphone access is not supported in this browser."}),f&&w.isWorking?(0,s.jsxs)("div",{className:"mt-4 flex items-center justify-center gap-2",children:[(0,s.jsx)("div",{className:"w-3 h-3 rounded-full ".concat({excellent:"bg-green-500",good:"bg-blue-500",poor:"bg-yellow-500",none:"bg-red-500"}[w.quality]," animate-pulse")}),(0,s.jsxs)("span",{className:"text-sm text-gray-400",children:["Quality: ",w.quality," | Volume: ",Math.round(w.volumeLevel)]})]}):null]}),S&&(0,s.jsxs)("div",{className:"mb-6 p-4 bg-red-900 border border-red-700 rounded-lg",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,s.jsx)(p.Z,{className:"w-5 h-5 text-red-400"}),(0,s.jsx)("span",{className:"text-red-400 font-medium",children:"Error"})]}),(0,s.jsx)("p",{className:"text-red-300 text-sm",children:S})]}),(0,s.jsxs)("div",{className:"space-y-3",children:[!o&&l&&!M&&(0,s.jsx)("button",{onClick:T,className:"w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors",children:"Allow Microphone Access"}),o&&f&&(0,s.jsx)("button",{onClick:L,className:"w-full bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors",children:"Test Microphone Quality"}),(c||S)&&(0,s.jsx)("button",{onClick:A,className:"w-full bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-3 rounded-lg font-medium transition-colors",children:"Retry Microphone Access"}),(0,s.jsxs)("button",{onClick:()=>E(!I),className:"w-full bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-medium transition-colors",children:[I?"Hide":"Show"," Advanced Options"]})]}),I&&(0,s.jsxs)("div",{className:"mt-6",children:[I&&0!==d.length?(0,s.jsxs)("div",{className:"mt-4",children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-white mb-2",children:"Select Microphone Device"}),(0,s.jsxs)("select",{value:P,onChange:e=>D(e.target.value),className:"w-full bg-gray-700 text-white px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[(0,s.jsx)("option",{value:"",children:"Default Device"}),d.map(e=>(0,s.jsx)("option",{value:e.deviceId,children:e.label},e.deviceId))]})]}):null,I?(0,s.jsxs)("div",{className:"mt-6 p-4 bg-gray-800 rounded-lg",children:[(0,s.jsx)("h4",{className:"text-sm font-semibold text-white mb-3",children:"Browser Compatibility"}),(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(g.Z,{className:"w-4 h-4 ".concat(k.getUserMedia?"text-green-500":"text-red-500")}),(0,s.jsx)("span",{className:"text-gray-300",children:"getUserMedia"})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(g.Z,{className:"w-4 h-4 ".concat(k.permissionsAPI?"text-green-500":"text-red-500")}),(0,s.jsx)("span",{className:"text-gray-300",children:"Permissions API"})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(g.Z,{className:"w-4 h-4 ".concat(k.audioContext?"text-green-500":"text-red-500")}),(0,s.jsx)("span",{className:"text-gray-300",children:"Audio Context"})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(g.Z,{className:"w-4 h-4 ".concat(k.webRTC?"text-green-500":"text-red-500")}),(0,s.jsx)("span",{className:"text-gray-300",children:"WebRTC"})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(g.Z,{className:"w-4 h-4 ".concat(k.https?"text-green-500":"text-red-500")}),(0,s.jsx)("span",{className:"text-gray-300",children:"HTTPS"})]})]})]}):null]}),(0,s.jsxs)("div",{className:"mt-6 text-sm text-gray-400 space-y-1",children:[(0,s.jsx)("p",{children:"• Your microphone will only be used for voice chat"}),(0,s.jsx)("p",{children:"• You can mute/unmute anytime during the conversation"}),(0,s.jsx)("p",{children:"• No audio is recorded or stored"}),(0,s.jsx)("p",{children:"• Microphone access can be revoked in browser settings"})]}),(0,s.jsx)("button",{onClick:r,className:"mt-6 text-gray-400 hover:text-white transition-colors",children:"← Back to Rooms"})]})})}var w=r(82861);function b(e){let{roomId:t,onLeave:r}=e,{isConnected:a,isLoading:i,error:o,currentRoom:c,participants:d,messages:u,isMuted:m,isSpeaking:h,joinRoom:g,leaveRoom:p,sendMessage:v,toggleMute:b,setMicrophoneStream:y,setError:j}=l(),[N,k]=(0,n.useState)(!1),[S,C]=(0,n.useState)("");(0,n.useEffect)(()=>{t&&a&&N&&g(t).catch(e=>{j("Failed to join room. Please try again.")})},[t,a,N,g,j]);let M=()=>{p(),r()};return i?(0,s.jsx)("div",{className:"flex items-center justify-center h-screen bg-gray-900",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),(0,s.jsx)("p",{className:"mt-4 text-white",children:"Joining room..."})]})}):N?o?(0,s.jsx)("div",{className:"flex items-center justify-center h-screen bg-gray-900",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("p",{className:"text-red-400 mb-4",children:o}),(0,s.jsx)("button",{onClick:()=>{j(null),g(t)},className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg mr-4",children:"Retry"}),(0,s.jsx)("button",{onClick:M,className:"bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg",children:"Leave Room"})]})}):(0,s.jsxs)("div",{className:"h-screen flex flex-col bg-gray-900",children:[(0,s.jsxs)("div",{className:"bg-gray-800 p-4 flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"flex items-center gap-4",children:[(0,s.jsx)("button",{onClick:M,className:"text-gray-300 hover:text-white p-2 rounded-lg hover:bg-gray-700",children:(0,s.jsx)(w.Z,{className:"w-6 h-6"})}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h1",{className:"text-xl font-bold text-white",children:(null==c?void 0:c.name)||"Room ".concat(t)}),(0,s.jsxs)("p",{className:"text-gray-400 text-sm",children:[d.length," participant",1!==d.length?"s":""]})]})]}),(0,s.jsx)("div",{className:"flex items-center gap-4",children:(0,s.jsxs)("button",{onClick:b,className:"p-3 rounded-full transition-colors relative ".concat(m?"bg-red-600 hover:bg-red-700 text-white":h?"bg-green-600 hover:bg-green-700 text-white animate-pulse":"bg-green-600 hover:bg-green-700 text-white"),children:[(0,s.jsx)(x.Z,{className:"w-6 h-6 ".concat(m?"opacity-50":"")}),h&&!m&&(0,s.jsx)("div",{className:"absolute -top-1 -right-1 w-3 h-3 bg-green-400 rounded-full animate-pulse"})]})})]}),(0,s.jsxs)("div",{className:"flex-1 flex",children:[(0,s.jsxs)("div",{className:"w-1/3 bg-gray-800 p-4",children:[(0,s.jsx)("h2",{className:"text-lg font-semibold text-white mb-4",children:"Participants"}),(0,s.jsx)("div",{className:"space-y-2",children:d.map(e=>(0,s.jsxs)("div",{className:"flex items-center gap-3 p-3 rounded-lg transition-colors ".concat(e.isSpeaking?"bg-green-700 border border-green-500":"bg-gray-700"),children:[(0,s.jsx)("div",{className:"w-3 h-3 rounded-full transition-colors ".concat(e.isSpeaking?"bg-green-500 animate-pulse":"bg-gray-500")}),(0,s.jsx)("span",{className:"text-white font-medium",children:e.name}),e.isMuted&&(0,s.jsx)(x.Z,{className:"w-4 h-4 text-red-400 opacity-50"}),e.isSpeaking&&(0,s.jsx)("div",{className:"ml-auto",children:(0,s.jsx)("div",{className:"w-2 h-2 bg-green-400 rounded-full animate-pulse"})})]},e.id))})]}),(0,s.jsxs)("div",{className:"flex-1 flex flex-col",children:[(0,s.jsx)("div",{className:"flex-1 p-4 overflow-y-auto",children:(0,s.jsx)("div",{className:"space-y-4",children:u.map(e=>(0,s.jsxs)("div",{className:"flex gap-3",children:[(0,s.jsx)("div",{className:"w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white text-sm font-semibold",children:e.userName.charAt(0).toUpperCase()}),(0,s.jsxs)("div",{className:"flex-1",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,s.jsx)("span",{className:"text-white font-semibold",children:e.userName}),(0,s.jsx)("span",{className:"text-gray-400 text-sm",children:new Date(e.timestamp).toLocaleTimeString()})]}),(0,s.jsx)("p",{className:"text-gray-300",children:e.message})]})]},e.id))})}),(0,s.jsx)("div",{className:"p-4 border-t border-gray-700",children:(0,s.jsxs)("form",{onSubmit:e=>{e.preventDefault(),S.trim()&&(v(S),C(""))},className:"flex gap-3",children:[(0,s.jsx)("input",{type:"text",value:S,onChange:e=>C(e.target.value),placeholder:"Type a message...",className:"flex-1 bg-gray-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600"}),(0,s.jsx)("button",{type:"submit",disabled:!S.trim(),className:"bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white px-6 py-2 rounded-lg transition-colors",children:"Send"})]})})]})]})]}):(0,s.jsx)(f,{onPermissionGranted:e=>{try{y(e),k(!0),t&&a&&g(t).catch(e=>{j("Failed to join room. Please try again.")})}catch(e){j("Failed to initialize microphone. Please try again.")}},onCancel:()=>{try{r()}catch(e){r()}},roomName:(null==c?void 0:c.name)||"Room ".concat(t)})}},97679:function(e,t,r){r.d(t,{hu:function(){return i}});let s={ERROR:"error",WARN:"warn",INFO:"info",DEBUG:"debug"};class n{normalizeLevel(e){let t=e.toLowerCase();return t===s.ERROR||t===s.WARN||t===s.INFO||t===s.DEBUG?t:this.isProduction?s.INFO:s.DEBUG}setLevel(e){this.logLevel=e}getLevel(){return this.logLevel}shouldLog(e){let t=[s.ERROR,s.WARN,s.INFO,s.DEBUG],r=t.indexOf(this.logLevel);return t.indexOf(e)<=r}safeStringify(e){try{return JSON.stringify(e,(e,t)=>t instanceof Error?{name:t.name,message:t.message,stack:t.stack}:t)}catch(e){return"[unserializable]"}}formatMessage(e,t,r,s){let n=new Date().toISOString(),a="[".concat(n,"] [").concat(e.toUpperCase(),"] [").concat(t,"] ").concat(r);return s&&"object"==typeof s?"".concat(a," ").concat(this.safeStringify(s)):a}logToConsole(e,t,r,n){if(this.shouldLog(e)){if(this.formatMessage(e,t,r,n),this.isProduction){let s={timestamp:new Date().toISOString(),level:e,context:t,message:r};void 0!==n&&(s.data=n);{let s=window;s.gtag&&s.gtag("event","log",{custom_parameter_level:e,custom_parameter_context:t,custom_parameter_message:r})}}else switch(e){case s.ERROR:case s.WARN:case s.INFO:case s.DEBUG:}}}error(e,t,r){this.logToConsole(s.ERROR,e,t,r)}warn(e,t,r){this.logToConsole(s.WARN,e,t,r)}info(e,t,r){this.logToConsole(s.INFO,e,t,r)}debug(e,t,r){this.logToConsole(s.DEBUG,e,t,r)}constructor(){this.isProduction=!0,this.logLevel=this.normalizeLevel("info")}}let a=new n,i=e=>({error:(t,r)=>a.error(e,t,r),warn:(t,r)=>a.warn(e,t,r),info:(t,r)=>a.info(e,t,r),debug:(t,r)=>a.debug(e,t,r)})}}]);